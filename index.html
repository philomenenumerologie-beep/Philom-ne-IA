<script>
// ============================
//  Config
// ============================
const BACKEND_URL = 'https://philo-backend-su29.onrender.com';

// ============================
//  Helpers UI
// ============================
const $ = id => document.getElementById(id);
const msgs = $('msgs');
const txt  = $('txt');

function addMsg(who, text){
  const div = document.createElement('div');
  div.className = 'bubble ' + (who==='me' ? 'me' : 'bot');
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
}

function setHUD(state = {}){
  const t = n => Number(n||0).toLocaleString('fr-FR');
  const free = state.freeRemaining||0;
  const paid = state.paidBalance||0;
  const total = free + paid;
  $('tkFree').textContent  = t(free);
  $('tkPaid').textContent  = t(paid);
  $('tkTotal').textContent = t(total);
  $('hudFree') && ($('hudFree').textContent = t(free));
  $('hudPaid') && ($('hudPaid').textContent = t(paid));
  $('hudBalance') && ($('hudBalance').textContent = 'Solde : ' + t(total));

  const logged = !!state.email && !state.isAnonymous;
  $('btnSignup').style.display = logged ? 'none' : '';
  $('btnLogin').style.display  = logged ? 'none' : '';
  $('btnLogout').style.display = logged ? '' : 'none';
  $('hello').textContent = logged
    ? `Connect√© : ${state.email}`
    : 'Bonjour üëã ‚Ä¢ Tape @motcl√© pour l‚Äôactualit√©';
}

// ============================
//  API (unique)
// ============================
async function api(path, opt = {}){
  const r = await fetch(BACKEND_URL + path, {
    method: opt.method || 'GET',
    headers: { 'Content-Type':'application/json' },
    credentials: 'include',
    body: opt.body ? JSON.stringify(opt.body) : undefined
  });
  if (!r.ok) throw new Error('HTTP ' + r.status);
  return r.json();
}

// ============================
//  App logic
// ============================
async function initUser(){
  try{
    const res = await api('/api/start', { method:'POST' });
    if (res && res.user) setHUD(res.user);
    else addMsg('bot','‚ö†Ô∏è start: r√©ponse inattendue');
  }catch(e){
    addMsg('bot','‚ö†Ô∏è Erreur de d√©marrage: ' + e.message);
    console.error(e);
  }
}

async function refreshMe(){
  try{
    const me = await api('/api/me');   // OK seulement si connect√©
    setHUD(me);
    return me;
  }catch(_){
    // ignor√© si anonyme/non connect√©
  }
}

async function doSend(){
  const text = txt.value.trim();
  if (!text) return;
  const cost = 50;

  // 1) D√©biter
  try{
    const use = await api('/api/use', { method:'POST', body:{ cost } });
    setHUD(use);
  }catch(e){
    addMsg('bot','‚ö†Ô∏è Plus de tokens. Clique sur ‚öôÔ∏è puis ‚ÄúRecharger‚Äù.');
    return;
  }

  // 2) Afficher mon message
  addMsg('me', text);
  txt.value='';

  // 3) Appeler le chat (si tu as un /api/chat)
  try{
    const r = await api('/api/chat', { method:'POST', body:{ message:text } });
    addMsg('bot', r.reply || '‚Ä¶');
    await refreshMe();
  }catch(e){
    addMsg('bot','[Erreur r√©seau]');
    console.error(e);
  }
}

// Modales
function openDlg(id){ $(id).showModal(); }
function closeDlg(id){ $(id).close(); }

// Auth
async function signup(){
  const email = $('suEmail').value.trim();
  const password = $('suPass').value;
  $('suMsg').textContent='';
  try{
    await api('/api/signup',{ method:'POST', body:{ email, password } });
    $('suMsg').innerHTML = '<span class="ok">Compte cr√©√© ‚úî +2000 tokens</span>';
    setTimeout(()=>closeDlg('dlgSignup'),600);
    await refreshMe();
  }catch(e){
    $('suMsg').innerHTML = '<span class="ko">Cr√©ation impossible</span>';
    console.error(e);
  }
}

async function login(){
  const email = $('lgEmail').value.trim();
  const password = $('lgPass').value;
  $('lgMsg').textContent='';
  try{
    await api('/api/login',{ method:'POST', body:{ email, password } });
    $('lgMsg').innerHTML = '<span class="ok">Connect√© ‚úî</span>';
    setTimeout(()=>closeDlg('dlgLogin'),400);
    await refreshMe();
  }catch(e){
    $('lgMsg').innerHTML = '<span class="ko">Email ou mot de passe invalide</span>';
    console.error(e);
  }
}

async function logout(){
  try{ await api('/api/logout',{ method:'POST' }); }catch(_){}
  await initUser(); // revient en anonyme
}

// ============================
//  Wiring
// ============================
document.addEventListener('click', (ev)=>{
  const c = ev.target.dataset && ev.target.dataset.close;
  if (c) closeDlg(c);
});
$('btnSend').onclick = doSend;
txt.addEventListener('keydown', e=>{
  if (e.key==='Enter' && !e.shiftKey){ e.preventDefault(); doSend(); }
});
$('btnSignup').onclick = ()=>openDlg('dlgSignup');
$('btnLogin').onclick  = ()=>openDlg('dlgLogin');
$('btnLogout').onclick = logout;
$('doSignup').onclick  = signup;
$('doLogin').onclick   = login;
$('btnBuy').onclick    = ()=>alert('Paiement indisponible pour le moment.');

// Lang (placeholders)
$('btnFR').onclick = ()=>addMsg('bot','üá´üá∑ Fran√ßais s√©lectionn√©');
$('btnEN').onclick = ()=>addMsg('bot','üá¨üáß English selected');
$('btnNL').onclick = ()=>addMsg('bot','üá≥üá± Nederlands geselecteerd');

// Boot
document.addEventListener('DOMContentLoaded', async ()=>{
  await initUser();
  addMsg('bot','Bonjour ! Comment puis-je vous aider aujourd‚Äôhui ?');
});
</script>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Philomenia Messenger</title>

  <!-- Clerk Frontend -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#071826; --panel:#0e2238; --muted:#9bb3c9; --accent:#3aa0ff; --danger:#ff4646; }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width:900px; margin:0 auto; padding:22px; }
    h1 { margin:6px 0 2px; font-size:28px; text-align:center; }
    .topline { text-align:center; color:var(--muted); margin-bottom:14px; font-size:14px; }
    .badge { display:inline-block; padding:2px 8px; background:#0f2b47; border:1px solid #234c77; border-radius:999px; margin:0 6px; }
    .tokens { font-weight:600; color:#fff; }
    .panel { background:var(--panel); border:1px solid #173a5c; border-radius:12px; padding:14px; }
    .row { display:flex; gap:10px; }
    .grow { flex:1; }
    .chatbox { height:54vh; min-height:280px; overflow:auto; padding:12px; background:#0b1d31; border:1px solid #153150; border-radius:10px; }
    .msg { max-width:88%; margin:8px 0; padding:10px 12px; border-radius:10px; line-height:1.35; font-size:15px; white-space:pre-wrap; word-wrap:break-word; }
    .me { margin-left:auto; background:#133a6d; border:1px solid #2d65a2; }
    .bot { background:#0f2b47; border:1px solid #2a527e; }
    .muted { color:var(--muted); }
    input[type="text"], textarea {
      width:100%; background:#0b1d31; border:1px solid #173a5c; color:#fff;
      border-radius:10px; padding:12px; font-size:15px; outline:none;
    }
    textarea { height:52px; resize:none; }
    button { cursor:pointer; border:0; border-radius:10px; padding:12px 14px; font-weight:600; }
    .send { background:var(--accent); color:#001427; }
    .logout { background:var(--danger); color:#fff; padding:8px 12px; }
    .bar { display:flex; align-items:center; justify-content:space-between; gap:10px; margin:10px 0 16px; }
    .small { font-size:13px; }
    .right { text-align:right; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Philomenia Messenger</h1>

    <div class="topline">
      <span id="connectedAs" class="badge">Connexion…</span>
      <span class="badge tokens">Tokens : <span id="tokFree">0</span> / <span id="tokPaid">0</span></span>
      <button id="logout" class="logout small">Se déconnecter</button>
    </div>

    <div class="panel">
      <div id="alert" class="muted small" style="margin:0 4px 8px;">Bonjour 👋 Tape un message et envoie.</div>

      <div id="chat" class="chatbox">
        <div class="msg bot">Bonjour ! Comment puis-je vous aider aujourd’hui ?</div>
      </div>

      <div class="row" style="margin-top:10px;">
        <textarea id="input" class="grow" placeholder="Écris ton message… (Entrée = envoyer)"></textarea>
        <button id="send" class="send">Envoyer</button>
      </div>
    </div>

    <div class="right muted small" style="margin-top:10px;">
      Solde • Gratuit : <span id="fBalance">0</span> • Payant : <span id="pBalance">0</span>
    </div>
  </div>

  <script>
    // Helpers d’UI
    const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    function addMsg(text, cls) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function safeFetch(url, options={}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (e) {
        console.error(e);
        $("alert").textContent = "⚠️ Échec de chargement (" + (e.message || "erreur") + ")";
        return null;
      }
    }

    // Clerk + page
    window.addEventListener("load", async () => {
      await Clerk.load();

      if (!Clerk.user) {
        // Pas connecté -> retour accueil
        window.location.href = "/";
        return;
      }

      // Afficher l’email utilisateur
      const mail = Clerk.user.primaryEmailAddress?.emailAddress || "inconnu";
      $("connectedAs").textContent = "Connecté ✅ : " + mail;

      // Déconnexion
      $("logout").onclick = async () => {
        await Clerk.signOut();
        window.location.href = "/";
      };

      // Charger les soldes/tokens
      refreshBalances();

      // Envoi message
      const sendBtn = $("send");
      const input = $("input");

      async function sendMessage() {
        const text = input.value.trim();
        if (!text) return;
        input.value = "";
        addMsg(text, "me");

        sendBtn.disabled = true;
        sendBtn.textContent = "…";

        // Appel backend (POST /api/chat)
        const payload = { message: text, email: mail };
        const data = await safeFetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (data && (data.reply || data.choices)) {
          const reply = data.reply || data.choices?.[0]?.message?.content || "Réponse reçue.";
          addMsg(reply, "bot");
          // Recharge les soldes après consommation
          refreshBalances();
        } else {
          addMsg("Désolé, impossible d’obtenir une réponse pour le moment.", "bot");
        }

        sendBtn.disabled = false;
        sendBtn.textContent = "Envoyer";
      }

      sendBtn.onclick = sendMessage;

      // Entrée pour envoyer (Shift+Entrée = nouvelle ligne)
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });

    async function refreshBalances() {
      const data = await safeFetch("/api/balance");
      if (!data) return;
      const free = Number(data.free || 0);
      const paid = Number(data.paid || 0);

      $("tokFree").textContent = free;
      $("tokPaid").textContent = paid;
      $("fBalance").textContent = free;
      $("pBalance").textContent = paid;
      $("alert").textContent = "Prêt ✅";
    }
  </script>
</body>
</html>

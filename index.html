<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Philom√®ne IA Messenger ‚Äì GPT-4 Turbo</title>

  <!-- On garde la cl√© Clerk pour plus tard -->
  <meta name="clerk-publishable-key" content="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA" />

  <!-- L'URL de ton backend -->
  <meta name="api-base" content="https://api.philomeneia.com" />

  <style>
    :root {
      --bg:#071826;
      --panel:#0e2238;
      --panel-border:#173a5c;
      --bubble-user-bg:#133a6d;
      --bubble-user-border:#2d65a2;
      --bubble-bot-bg:#0f2b47;
      --bubble-bot-border:#2a527e;
      --text-muted:#9bb3c9;
      --accent:#1478FF;
      --danger:#ff4646;
      --radius:12px;
      --radius-sm:8px;
    }

    * {
      box-sizing:border-box;
      -webkit-tap-highlight-color:rgba(0,0,0,0);
    }

    body {
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /******** HEADER ********/
    header {
      background:#0b1d31;
      border-bottom:1px solid var(--panel-border);
      padding:12px 16px;
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      row-gap:8px;
      font-size:13px;
      line-height:1.4;
    }

    .leftHead {
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    .rowHeadTop {
      display:flex;
      flex-wrap:wrap;
      align-items:center;
      gap:6px;
      font-weight:500;
    }

    .badge {
      background:#0f2b47;
      border:1px solid #234c77;
      border-radius:999px;
      padding:2px 8px;
      font-size:12px;
      font-weight:500;
      color:#fff;
    }

    .tokensBadge {
      background:#133a6d;
      border:1px solid #2d65a2;
    }

    .emailLine {
      font-size:12px;
      color:var(--text-muted);
    }

    .rightHeadBtns {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }

    button.headBtn {
      background:#2b2b2b;
      color:#fff;
      border:1px solid #3a3a3a;
      border-radius:var(--radius-sm);
      font-size:13px;
      font-weight:500;
      padding:8px 10px;
      line-height:1.2;
      cursor:pointer;
    }

    button.headClear {
      background:var(--danger);
      border:1px solid var(--danger);
      color:#fff;
    }

    /******** LAYOUT PRINCIPAL ********/
    main {
      flex:1;
      display:flex;
      flex-direction:column;
      min-height:0; /* important pour le calc */
    }

    /* On fait une zone chat-container qui prend tout l'√©cran
       moins la barre d'envoi */
    .chatContainer {
      flex:1;
      min-height:0;
      display:flex;
      flex-direction:column;
      background:var(--panel);
      border-top:1px solid var(--panel-border);
      border-bottom:1px solid var(--panel-border);
    }

    /* Bloc intro (pr√©sentation) */
    #introBlock {
      border-bottom:1px solid var(--panel-border);
      padding:16px;
      font-size:14px;
      line-height:1.4;
      color:var(--text-muted);
      background:#0e2238;
    }

    #introBlock h1 {
      margin:0 0 6px;
      font-size:16px;
      color:#fff;
      font-weight:600;
    }

    #introBlock .offer {
      margin-top:12px;
      background:rgba(255,255,255,0.06);
      border:1px solid #234c77;
      border-radius:var(--radius-sm);
      padding:10px 12px;
      font-size:13px;
      color:#fff;
    }

    /* Zone scroll des messages */
    #chatScroll {
      flex:1;
      min-height:0;
      overflow-y:auto;
      -webkit-overflow-scrolling:touch;
      padding:16px;
      background:#0b1d31;
    }

    .msg {
      max-width:85%;
      padding:10px 12px;
      border-radius:10px;
      line-height:1.4;
      font-size:15px;
      word-wrap:break-word;
      white-space:pre-wrap;
      margin-bottom:10px;
    }
    .msg.bot {
      background:var(--bubble-bot-bg);
      border:1px solid var(--bubble-bot-border);
      margin-right:auto;
    }
    .msg.me {
      background:var(--bubble-user-bg);
      border:1px solid var(--bubble-user-border);
      margin-left:auto;
    }
    .msg.system {
      background:#2b2b2b;
      border:1px solid #3a3a3a;
      margin-left:auto;
      margin-right:auto;
      font-size:13px;
      opacity:.8;
    }

    /* Effet Wizz (secousse) */
    @keyframes shake {
      0% { transform:translate(0, 0); }
      20% { transform:translate(-2px, 1px); }
      40% { transform:translate(3px, -2px); }
      60% { transform:translate(-3px, 2px); }
      80% { transform:translate(2px, -1px); }
      100% { transform:translate(0, 0); }
    }
    .shake {
      animation:shake 0.4s linear 1;
    }

    /******** BARRE D'ENVOI EN BAS ********/
    .sendBarWrap {
      background:#0e2238;
      padding:10px 12px;
    }

    .sendRow {
      display:flex;
      align-items:flex-start;
      gap:8px;
    }

    .iconBtn {
      background:#2b2b2b;
      color:#fff;
      border:1px solid #3a3a3a;
      border-radius:var(--radius-sm);
      padding:10px;
      font-size:14px;
      font-weight:500;
      line-height:1.2;
      cursor:pointer;
      flex-shrink:0;
      min-width:44px;
      text-align:center;
    }

    textarea#userInput {
      flex:1;
      background:#0b1d31;
      border:1px solid var(--panel-border);
      border-radius:var(--radius-sm);
      color:#fff;
      font-size:16px;
      line-height:1.4;
      padding:10px 12px;
      resize:none;
      outline:none;
      min-height:46px;
      max-height:120px;
    }

    button#sendBtn {
      background:var(--accent);
      border:0;
      border-radius:var(--radius-sm);
      color:#001427;
      font-size:15px;
      font-weight:600;
      padding:12px 14px;
      line-height:1.2;
      flex-shrink:0;
      cursor:pointer;
    }

    .balanceLine {
      font-size:12px;
      color:var(--text-muted);
      text-align:right;
      margin-top:6px;
    }

    /******** R√âGLAGES PANEL (slide-up) ********/
    #settingsPanel {
      position:fixed;
      left:0; right:0; bottom:0;
      background:#0e2238;
      border-top:1px solid var(--panel-border);
      border-radius:16px 16px 0 0;
      padding:16px;
      box-shadow:0 -20px 40px rgba(0,0,0,0.6);
      font-size:14px;
      color:#fff;
      display:none;
      z-index:9999;
    }

    #settingsPanel h2 {
      font-size:16px;
      margin:0 0 12px;
      font-weight:600;
    }

    .panelLine {
      font-size:13px;
      color:var(--text-muted);
      line-height:1.4;
      margin-bottom:12px;
    }

    .panelBtns {
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }

    .loginBtn {
      background:#1478FF;
      color:#001427;
      border:0;
      border-radius:var(--radius-sm);
      font-size:14px;
      font-weight:600;
      padding:10px 12px;
      line-height:1.2;
      cursor:pointer;
    }

    .closeSettingsBtn {
      background:#2b2b2b;
      color:#fff;
      border:1px solid #3a3a3a;
      border-radius:var(--radius-sm);
      font-size:14px;
      font-weight:600;
      padding:10px 12px;
      line-height:1.2;
      cursor:pointer;
    }

    .printBtn {
      background:var(--danger);
      color:#fff;
      border:0;
      border-radius:var(--radius-sm);
      font-size:14px;
      font-weight:600;
      padding:10px 12px;
      line-height:1.2;
      cursor:pointer;
    }

  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="leftHead">
      <div class="rowHeadTop">
        <span class="badge" id="userStatus">Invit√© üë§</span>
        <span class="badge tokensBadge" id="tokenBadge">Tokens: 0</span>
      </div>
      <div class="emailLine" id="userEmail">Non connect√©</div>
    </div>

    <div class="rightHeadBtns">
      <button class="headBtn" id="settingsBtn">R√©glages</button>
      <button class="headBtn headClear" id="clearBtn">Vider chat</button>
    </div>
  </header>

  <!-- ZONE CHAT -->
  <main>
    <div class="chatContainer" id="chatContainer">

      <div id="introBlock">
        <h1>Philom√®ne IA ‚Äì Assistant personnel</h1>
        Je peux t‚Äôaider pour tes devoirs, √©crire un mail pro, corriger un texte,
        cuisiner avec ce que tu as dans ton frigo, traduire, expliquer une panne,
        pr√©parer un CV, t‚Äôexpliquer une facture, tout √ßa calmement √©tape par √©tape.
        <div class="offer">
          ‚Ä¢ Mode invit√© : tu testes gratuitement (1000 tokens).<br/>
          ‚Ä¢ Quand tu cr√©es ton compte (e-mail v√©rifi√©) : tu passes √† 5000 tokens et on garde l‚Äôhistorique.<br/><br/>
          Politique / actu du jour : je peux parfois ne pas avoir la derni√®re info en temps r√©el.
        </div>
      </div>

      <div id="chatScroll"></div>

    </div>

    <!-- BARRE D'ENVOI -->
    <div class="sendBarWrap">
      <div class="sendRow">
        <button class="iconBtn" id="photoBtn">üì∑</button>

        <textarea id="userInput" placeholder="√âcris ton message‚Ä¶ (Entr√©e = envoyer)"></textarea>

        <button class="iconBtn" id="wizzBtn">‚ö°Wizz</button>

        <button id="sendBtn">Envoyer</button>
      </div>

      <div class="balanceLine" id="balanceLine">
        Solde: 0 tokens restants
      </div>
    </div>
  </main>

  <!-- PANEL R√âGLAGES -->
  <div id="settingsPanel">
    <h2>R√©glages</h2>
    <div class="panelLine">
      Statut actuel : <span id="panelStatus">Invit√© (1000 tokens)</span><br/>
      Passe √† 5000 tokens en cr√©ant un compte (connexion rapide par e-mail).
    </div>

    <div class="panelBtns">
      <button class="loginBtn" id="loginPanelBtn">Cr√©er un compte / Se connecter</button>
      <button class="closeSettingsBtn" id="closeSettingsBtn">Fermer</button>
      <button class="printBtn" id="printBtn">Imprimer</button>
    </div>
  </div>

  <script>
    // R√©cup√®re les infos du <meta> dans le head
    const apiBase = document.querySelector('meta[name="api-base"]').content;
    const clerkKey = document.querySelector('meta[name="clerk-publishable-key"]').content;

    // √âl√©ments DOM
    const chatContainerEl = document.getElementById("chatContainer");
    const introBlockEl   = document.getElementById("introBlock");
    const chatScrollEl   = document.getElementById("chatScroll");

    const userInputEl    = document.getElementById("userInput");
    const sendBtnEl      = document.getElementById("sendBtn");
    const wizzBtnEl      = document.getElementById("wizzBtn");
    const photoBtnEl     = document.getElementById("photoBtn");

    const tokenBadgeEl   = document.getElementById("tokenBadge");
    const userStatusEl   = document.getElementById("userStatus");
    const userEmailEl    = document.getElementById("userEmail");
    const balanceLineEl  = document.getElementById("balanceLine");
    const clearBtnEl     = document.getElementById("clearBtn");

    const settingsBtnEl      = document.getElementById("settingsBtn");
    const settingsPanelEl    = document.getElementById("settingsPanel");
    const closeSettingsBtnEl = document.getElementById("closeSettingsBtn");
    const loginPanelBtnEl    = document.getElementById("loginPanelBtn");
    const panelStatusEl      = document.getElementById("panelStatus");
    const printBtnEl         = document.getElementById("printBtn");

    // Notre "session" c√¥t√© front
    // id: identifiant utilisateur (invit√© ou email une fois connect√©)
    // tokens: solde courant
    // email: si connect√©
    let currentUser = {
      id: null,
      tokens: 0,
      email: null,
      isGuest: true
    };

    // Petit helper pour cr√©er une bulle de chat
    function addMessageBubble(who, text) {
      const div = document.createElement("div");
      div.className = "msg " + who;
      div.textContent = text;
      chatScrollEl.appendChild(div);
      chatScrollEl.scrollTop = chatScrollEl.scrollHeight;
    }

    // Message syst√®me (ex: Wizz)
    function addSystemBubble(text) {
      const div = document.createElement("div");
      div.className = "msg system";
      div.textContent = text;
      chatScrollEl.appendChild(div);
      chatScrollEl.scrollTop = chatScrollEl.scrollHeight;
    }

    // Cacher l'intro apr√®s le premier vrai message envoy√©
    function hideIntro() {
      if (introBlockEl) {
        introBlockEl.style.display = "none";
      }
    }

    // Mise √† jour des infos affich√©es en haut / bas
    function refreshHeaderAndBalance() {
      tokenBadgeEl.textContent = "Tokens: " + currentUser.tokens;
      balanceLineEl.textContent = "Solde: " + currentUser.tokens + " tokens restants";

      if (currentUser.isGuest) {
        userStatusEl.textContent = "Invit√© üë§";
        userEmailEl.textContent  = "Non connect√©";
        panelStatusEl.textContent = "Invit√© ("+currentUser.tokens+" tokens)";
      } else {
        userStatusEl.textContent = "Connect√© ‚úÖ";
        userEmailEl.textContent  = currentUser.email || "Connect√©";
        panelStatusEl.textContent = "Connect√© ("+currentUser.tokens+" tokens)";
      }
    }

    // Envoi d'un message √† l'IA
    async function sendMessageToAI() {
      const text = userInputEl.value.trim();
      if (!text) return;

      if (currentUser.tokens <= 0) {
        addMessageBubble("bot","Plus de tokens üòÖ Va dans R√©glages pour recharger.");
        return;
      }

      hideIntro();
      addMessageBubble("me", text);
      userInputEl.value = "";
      sendBtnEl.disabled = true;
      sendBtnEl.textContent = "‚Ä¶";

      try {
        // Appel backend /api/chat
        const response = await fetch(apiBase + "/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: currentUser.id,
            message: text
          })
        });

        const data = await response.json();

        if (data && data.reply) {
          addMessageBubble("bot", data.reply);
        } else {
          addMessageBubble("bot","Pas de r√©ponse.");
        }

        // Tokens restants renvoy√©s par le serveur
        if (typeof data.remaining !== "undefined") {
          currentUser.tokens = data.remaining;
          refreshHeaderAndBalance();
        }

      } catch (err) {
        console.error(err);
        addMessageBubble("bot","Erreur r√©seau.");
      }

      sendBtnEl.disabled = false;
      sendBtnEl.textContent = "Envoyer";
    }

    // Wizz MSN: secoue l'√©cran du chat
    function doWizz() {
      // bulle syst√®me
      addSystemBubble("üí• WIZZ envoy√©");
      // secouer
      chatContainerEl.classList.add("shake");
      setTimeout(() => {
        chatContainerEl.classList.remove("shake");
      }, 450);
    }

    // Vider chat (efface visuel + dit au backend de reset la m√©moire)
    async function clearChat() {
      chatScrollEl.innerHTML = "";
      addMessageBubble("bot","Conversation effac√©e ‚úÖ");

      // On ping le backend pour reset m√©moire si possible
      if (currentUser.id) {
        try {
          await fetch(apiBase + "/api/clear", {
            method:"POST",
            headers:{"Content-Type":"application/json"},
            body: JSON.stringify({ userId: currentUser.id })
          });
        } catch(e){
          console.warn("clear error", e);
        }
      }
    }

    // Ouvrir / fermer le panneau R√©glages
    function openSettings() {
      settingsPanelEl.style.display = "block";
    }
    function closeSettings() {
      settingsPanelEl.style.display = "none";
    }

    // "Imprimer"
    function doPrint() {
      window.print();
    }

    // Connexion / inscription (Clerk) ‚Äî version simple pour l‚Äôinstant:
    // Pour le moment on ne d√©clenche pas Clerk ici (√ßa demande du script Clerk),
    // mais on pr√©pare la logique:
    // 1. L'utilisateur se connecte (plus tard via Clerk)
    // 2. On re√ßoit son email / un userId permanent
    // 3. On appelle upgradeAccount() pour passer √† 5000 tokens
    async function upgradeAccount(fakeEmail) {
      // Simulation du passage invit√© -> connect√©
      // Dans la vraie version Clerk:
      //   - fakeEmail = Clerk.user.primaryEmailAddress.emailAddress
      //   - userId = Clerk.user.id
      currentUser.isGuest = false;
      currentUser.email = fakeEmail || "user@example.com";
      currentUser.id = currentUser.email; // on utilise l'email comme id simplifi√©
      currentUser.tokens = 5000;
      refreshHeaderAndBalance();
      addMessageBubble("bot","Bienvenue, compte activ√© ‚úÖ Tu as maintenant 5000 tokens.");
    }

    // Quand on clique sur "Cr√©er un compte / Se connecter"
    loginPanelBtnEl.addEventListener("click", () => {
      // Pour l'instant on simule la connexion directe,
      // comme si la personne venait de valider son e-mail.
      upgradeAccount("exemple@philomeneia.com");
      closeSettings();
    });

    // Gestion des boutons
    sendBtnEl.addEventListener("click", sendMessageToAI);
    userInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessageToAI();
      }
    });

    wizzBtnEl.addEventListener("click", doWizz);
    clearBtnEl.addEventListener("click", clearChat);
    settingsBtnEl.addEventListener("click", openSettings);
    closeSettingsBtnEl.addEventListener("click", closeSettings);
    printBtnEl.addEventListener("click", doPrint);

    // Le bouton üì∑ pour plus tard (envoi d'image / panne etc.)
    photoBtnEl.addEventListener("click", () => {
      addSystemBubble("üì∑ Envoi d'image bient√¥t disponible");
    });

    // Au chargement: on demande un compte invit√© au backend
    async function initGuest() {
      try {
        const r = await fetch(apiBase + "/api/guest-start", {
          method:"POST"
        });
        const data = await r.json();

        // data doit contenir { userId, tokens }
        currentUser.id = data.userId;
        currentUser.tokens = data.tokens;
        currentUser.isGuest = true;
        currentUser.email = null;

        refreshHeaderAndBalance();

        // message d'accueil
        addMessageBubble(
          "bot",
          "Salut üëã Je suis Philom√®ne IA. Tu as " +
          currentUser.tokens +
          " tokens gratuits pour tester. Pose ta question."
        );

      } catch(e) {
        console.error(e);
        addMessageBubble("bot","Erreur de connexion au serveur üò¢");
      }
    }

    initGuest();
  </script>

</body>
</html>

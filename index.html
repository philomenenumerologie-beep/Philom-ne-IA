<!DOCTYPE html>
<html lang="fr" style="background:#000;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhilomÃ¨ne I.A.</title>
  <meta name="color-scheme" content="dark" />

  <!-- Clerk Auth -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family: -apple-system, BlinkMacSystemFont, "Inter", Roboto, "Helvetica Neue", Arial, sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* HEADER */
    header {
      background:#000;
      color:#ffd84f;
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:16px;
      font-weight:500;
      position:relative;
    }
    .left-head,
    .right-head{
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }
    .burger,
    .more {
      width:40px;
      height:40px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
    }

    .token-box {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:14px;
      line-height:1.2;
      color:#ffd84f;
      font-weight:600;
      text-align:center;
    }
    .token-value {
      display:flex;
      align-items:center;
      gap:8px;
    }
    .token-value span#token-count-top{
      color:#ffd84f;
      font-feature-settings:"tnum";
    }
    .token-label {
      font-size:12px;
      color:#888;
      font-weight:400;
    }

    /* MENU FLOTTANT (â‹¯) */
    .menu-panel {
      position:absolute;
      top:60px;
      right:16px;
      background:#0b0b0f;
      border:1px solid rgba(255,255,255,0.12);
      border-radius:12px;
      min-width:200px;
      box-shadow:0 30px 60px rgba(0,0,0,0.8),0 0 40px rgba(120,80,255,0.4);
      padding:8px 0;
      display:none;
      z-index:9999;
    }
    .menu-item {
      width:100%;
      background:transparent;
      border:0;
      text-align:left;
      color:#fff;
      font-size:15px;
      padding:12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .menu-item + .menu-item {
      border-top:1px solid rgba(255,255,255,0.07);
    }
    .menu-item span.hint {
      font-size:12px;
      color:#888;
      font-weight:400;
    }
    .menu-item.danger {
      color:#ff4f4f;
    }

    /* CONTENU CHAT */
    .chat-wrapper {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:16px;
      overflow-y:auto;
      background:radial-gradient(circle at 20% 20%, rgba(80,0,255,0.18) 0%, rgba(0,0,0,0) 60%);
    }

    .bubble {
      max-width:90%;
      border-radius:12px;
      padding:16px;
      line-height:1.4;
      font-size:18px;
      box-shadow:0 30px 60px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.08);
      white-space:pre-wrap;
      word-break:break-word;
    }

    .bubble.assistant {
      align-self:flex-start;
      background:#2b2b2b;
      color:#fff;
    }

    .bubble.user {
      align-self:flex-end;
      background:#4c3bff;
      background:radial-gradient(circle at 100% 0%, rgba(130,110,255,.6) 0%, rgba(20,10,60,0) 60%), #4c3bff;
      color:#fff;
      font-weight:500;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 40px rgba(100,60,255,0.6),0 30px 60px rgba(0,0,0,0.8);
    }

    .bubble.thinking {
      background:#2b2b2b;
      color:#ccc;
      font-style:italic;
    }

    /* BARRE D'ENVOI */
    .input-zone-wrapper {
      background:#000;
      border-top:1px solid rgba(255,255,255,0.08);
      padding:16px;
    }
    .input-row {
      display:flex;
      align-items:stretch;
      gap:12px;
      background:radial-gradient(circle at 0% 0%, rgba(130,110,255,.3) 0%, rgba(0,0,0,0) 60%);
    }

    .plus-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:28px;
      font-weight:500;
    }
    .text-input {
      flex:1;
      background:#0f0f1a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      font-size:18px;
      color:#fff;
      padding:16px;
      font-family:inherit;
      outline:none;
    }
    .send-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:24px;
      font-weight:500;
    }

    .status-line {
      text-align:center;
      margin-top:12px;
      font-size:15px;
      color:#999;
      font-weight:400;
    }
    .status-line strong {
      font-weight:600;
      color:#fff;
    }
    .status-line #token-count-bottom {
      color:#fff;
      font-feature-settings:"tnum";
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="left-head">
      <div class="burger" id="openMainMenu">â˜°</div>
    </div>

    <div class="token-box">
      <div class="token-value">
        <div style="font-size:20px;">ðŸ’Ž</div>
        <span id="token-count-top">5000</span>
        <span>tokens</span>
      </div>
      <div class="token-label">PhilomÃ¨ne I.A.</div>
    </div>

    <div class="right-head">
      <div class="more" id="moreBtn">â‹¯</div>
    </div>

    <!-- menu dÃ©roulant (â‹¯) -->
    <div id="menuPanel" class="menu-panel">
      <button class="menu-item" id="connectBtn">
        <span>Connexion / Inscription</span>
        <span class="hint">sÃ©curisÃ©</span>
      </button>
      <button class="menu-item danger" id="logoutBtn" style="display:none;">
        <span>Se dÃ©connecter</span>
        <span class="hint">fermer la session</span>
      </button>
    </div>
  </header>

  <!-- ZONE MESSAGES -->
  <div id="chat-container" class="chat-wrapper"></div>

  <!-- BARRE D'ENVOI -->
  <div class="input-zone-wrapper">
    <div class="input-row">
      <div class="plus-btn" id="plusBtn">+</div>
      <input
        id="user-input"
        class="text-input"
        placeholder="Ã‰crivez votre message..."
      />
      <div id="send-btn" class="send-btn">âž¤</div>
    </div>

    <div class="status-line">
      PrÃªt â€¢
      <strong>
        <span id="token-count-bottom">5000</span>
        tokens
      </strong>
      restants
    </div>
  </div>

  <!-- SCRIPT LOGIQUE -->
  <script>
    // =========================
    // CONFIG
    // =========================
    const API_URL = "https://philo-backend-su29.onrender.com/ask";
    let tokenCount = 5000;
    let currentUserEmail = null; // si connectÃ© on met l'email, sinon null

    // conversation stockÃ©e en mÃ©moire locale
    const conversation = [
      {
        role: "system",
        content: "Tu es PhilomÃ¨ne I.A., une assistante personnelle en franÃ§ais, avec un ton humain, calme et rassurant."
      },
      {
        role: "assistant",
        content:
          "ðŸ‘‹ Bonjour ! Je suis PhilomÃ¨ne I.A., votre assistante personnelle.\n" +
          "Si vous avez un problÃ¨me, jâ€™ai la solution.\n" +
          "Vous avez une question, jâ€™ai la rÃ©ponse.\n" +
          "Ensemble, on ira plus loin ðŸ•Š"
      }
    ];

    // =========================
    // SÃ‰LECTEURS
    // =========================
    const chatContainer   = document.getElementById("chat-container");
    const userInput       = document.getElementById("user-input");
    const sendBtn         = document.getElementById("send-btn");
    const tokenTop        = document.getElementById("token-count-top");
    const tokenBottom     = document.getElementById("token-count-bottom");
    const moreBtn         = document.getElementById("moreBtn");
    const menuPanel       = document.getElementById("menuPanel");
    const connectBtn      = document.getElementById("connectBtn");
    const logoutBtn       = document.getElementById("logoutBtn");

    // =========================
    // UI HELPERS
    // =========================
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addBubble(text, who) {
      const div = document.createElement("div");
      div.classList.add("bubble");

      if (who === "user") {
        div.classList.add("user");
      } else if (who === "assistant") {
        div.classList.add("assistant");
      } else if (who === "thinking") {
        div.classList.add("assistant","thinking");
      } else {
        div.classList.add("assistant");
      }

      div.textContent = text || "";
      chatContainer.appendChild(div);
      scrollToBottom();
      return div;
    }

    function updateTokensUI() {
      tokenTop.textContent    = tokenCount;
      tokenBottom.textContent = tokenCount;
    }

    function initWelcomeMessage() {
      // on affiche le message d'accueil une seule fois au dÃ©but
      const welcome = conversation[1].content;
      addBubble(welcome, "assistant");
      updateTokensUI();
    }

    // =========================
    // CLERK (AUTH)
    // =========================
    async function initClerkStuff() {
      await Clerk.load();

      if (Clerk.user) {
        // connectÃ©
        currentUserEmail = Clerk.user.primaryEmailAddress?.emailAddress || "compte";
        connectBtn.style.display = "none";        // cacher "Connexion / Inscription"
        logoutBtn.style.display  = "flex";        // montrer "Se dÃ©connecter"
      } else {
        // pas connectÃ©
        currentUserEmail = null;
        connectBtn.style.display = "flex";
        logoutBtn.style.display  = "none";
      }
    }

    // ouvrir les popups Clerk
    connectBtn.addEventListener("click", () => {
      Clerk.openSignIn();
      menuPanel.style.display = "none";
    });

    // dÃ©connexion Clerk
    logoutBtn.addEventListener("click", async () => {
      try {
        await Clerk.signOut();
      } catch(e) {
        console.error("Erreur signOut:", e);
      }
      currentUserEmail = null;
      connectBtn.style.display = "flex";
      logoutBtn.style.display  = "none";
      menuPanel.style.display  = "none";
    });

    // =========================
    // MENU â‹¯
    // =========================
    moreBtn.addEventListener("click", () => {
      if (menuPanel.style.display === "block") {
        menuPanel.style.display = "none";
      } else {
        menuPanel.style.display = "block";
      }
    });

    // si on clique ailleurs on ferme le menu
    document.addEventListener("click", (e) => {
      if (!e.target.closest(".more") && !e.target.closest("#menuPanel")) {
        menuPanel.style.display = "none";
      }
    });

    // =========================
    // ENVOI MESSAGE
    // =========================
    async function askPhilomene() {
      const text = userInput.value.trim();
      if (!text) return;

      // bulle utilisateur
      addBubble(text, "user");

      // push dans conversation locale
      conversation.push({
        role: "user",
        content: text
      });

      // vider le champ
      userInput.value = "";

      // bulle attente
      const thinkingBubble = addBubble("PhilomÃ¨ne rÃ©flÃ©chit Ã  votre messageâ€¦", "thinking");

      try {
        // appel backend
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            conversation: conversation
          })
        });

        if (!resp.ok) {
          throw new Error("HTTP " + resp.status);
        }

        const data = await resp.json();

        // remplacer la bulle 'thinking' par la vraie rÃ©ponse
        thinkingBubble.remove();
        addBubble(data.answer || "â€¦", "assistant");

        // sauvegarder la rÃ©ponse aussi dans conversation
        conversation.push({
          role: "assistant",
          content: data.answer || ""
        });

        // dÃ©crÃ©menter les tokens simulÃ©s
        tokenCount = Math.max(0, tokenCount - 20);
        updateTokensUI();

      } catch (err) {
        thinkingBubble.textContent = "DÃ©solÃ©e, jâ€™ai eu un souci rÃ©seau.";
      }
    }

    sendBtn.addEventListener("click", askPhilomene);
    userInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        askPhilomene();
      }
    });

    // =========================
    // LANCEMENT
    // =========================
    initWelcomeMessage();

    // trÃ¨s important : on attend Clerk pour mettre Ã  jour le menu (connectÃ©/pas connectÃ©)
    document.addEventListener("readystatechange", async () => {
      if (document.readyState === "complete") {
        try {
          await initClerkStuff();
        } catch(e) {
          console.error("Clerk init error:", e);
        }
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Philomène IA — Messenger</title>

  <!-- Clerk (auth) -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#071826; --panel:#0e2238; --muted:#9bb3c9; --accent:#2e7df6; --danger:#ff4646; }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width:920px; margin:0 auto; padding:22px; }
    h1 { margin:6px 0 12px; font-size:28px; text-align:center; }
    .topline { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:8px; color:var(--muted); margin-bottom:14px; font-size:14px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:#0f2b47; border:1px solid #234c77; border-radius:999px; }
    .tokens { font-weight:700; color:#fff; }
    .logout { background:var(--danger); color:#fff; border:0; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; }

    .panel { background:var(--panel); border:1px solid #173a5c; border-radius:12px; padding:14px; }
    .alert { margin:0 4px 8px; color:var(--muted); }
    .chatbox { height:56vh; min-height:280px; overflow:auto; padding:12px; background:#0b1d31; border:1px solid #153150; border-radius:10px; }
    .msg { max-width:88%; margin:8px 0; padding:10px 12px; border-radius:10px; line-height:1.35; font-size:15px; white-space:pre-wrap; word-wrap:break-word; }
    .me { margin-left:auto; background:#133a6d; border:1px solid #2d65a2; }
    .bot { background:#0f2b47; border:1px solid #2a527e; }

    .row { display:flex; gap:10px; margin-top:10px; }
    textarea { flex:1; height:54px; resize:none; background:#0b1d31; border:1px solid #173a5c; color:#fff; border-radius:10px; padding:12px; font-size:15px; outline:none; }
    button { cursor:pointer; border:0; border-radius:10px; padding:12px 14px; font-weight:600; }
    .send { background:var(--accent); color:#001427; min-width:120px; }
    .photo { background:#00bcd4; color:#001427; min-width:120px; }

    input[type=file] { display:none; }
    .preview { font-size:12px; color:#beddff; opacity:.9; margin-top:6px; }
    .right { text-align:right; color:var(--muted); font-size:13px; margin-top:10px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Philomène IA — Messenger</h1>

    <div class="topline">
      <span id="connectedAs" class="badge">Connexion…</span>
      <span class="badge tokens">Tokens : <span id="tokFree">0</span> / <span id="tokPaid">0</span></span>
      <button id="logout" class="logout">Se déconnecter</button>
    </div>

    <div class="panel">
      <div id="alert" class="alert">Bonjour 👋 Pose ta question. Les réponses suivent le fil de la discussion.</div>

      <div id="chat" class="chatbox">
        <div class="msg bot">Bonjour ! Comment puis-je vous aider aujourd’hui ?</div>
      </div>

      <div id="preview" class="preview"></div>

      <div class="row">
        <textarea id="input" placeholder="Écris ton message… (Entrée = envoyer)"></textarea>
        <label for="file" class="photo" title="Envoyer une photo">📷 Photo</label>
        <input id="file" type="file" accept="image/*" />
        <button id="send" class="send">Envoyer</button>
      </div>
    </div>

    <div class="right">
      Solde • Gratuit : <span id="fBalance">0</span> • Payant : <span id="pBalance">0</span>
    </div>
  </div>

  <script>
    // ====== Config API (change automatiquement prod/dev) ======
    const API_URL = (location.hostname.includes("philomeneia"))
      ? "https://api.philomeneia.com"
      : "http://localhost:10000";

    const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    const fileInput = $("file");
    const preview = $("preview");

    let imageDataUrl = null;
    let userId = null; // récupéré via Clerk

    function addMsg(text, who) {
      const div = document.createElement("div");
      div.className = "msg " + (who === "me" ? "me" : "bot");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function safeJSON(url, options = {}) {
      try {
        const r = await fetch(url, options);
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch (e) {
        console.error(e);
        $("alert").textContent = "⚠️ Erreur réseau: " + (e.message || "inconnue");
        return null;
      }
    }

    // ——— Auth Clerk + init page ———
    window.addEventListener("load", async () => {
      await Clerk.load();
      if (!Clerk.user) { window.location.href = "/"; return; }

      userId = Clerk.user.id; // ← ID unique pour la mémoire côté serveur
      const mail = Clerk.user.primaryEmailAddress?.emailAddress || "inconnu";
      $("connectedAs").textContent = "Connecté ✅ : " + mail;

      $("logout").onclick = async () => {
        await Clerk.signOut();
        window.location.href = "/";
      };

      await refreshBalances();

      // Envoi texte
      $("send").onclick = sendMessage;
      const input = $("input");
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      // Upload photo
      fileInput.addEventListener("change", async () => {
        if (!fileInput.files?.length) return;
        const f = fileInput.files[0];
        if (!f.type.startsWith("image/")) {
          preview.textContent = "Fichier non supporté.";
          imageDataUrl = null;
          return;
        }
        imageDataUrl = await toDataURL(f);
        preview.textContent = "Photo attachée ✅";
      });
    });

    async function refreshBalances() {
      const d = await safeJSON(API_URL + "/api/balance");
      if (!d) return;
      $("tokFree").textContent = d.free ?? 0;
      $("tokPaid").textContent = d.paid ?? 0;
      $("fBalance").textContent = d.free ?? 0;
      $("pBalance").textContent = d.paid ?? 0;
      $("alert").textContent = "Prêt ✅";
    }

    async function sendMessage() {
      const input = $("input");
      const text = input.value.trim();
      if (!text && !imageDataUrl) return;

      addMsg(text || "(photo)", "me");
      input.value = "";

      const body = {
        userId,                           // ← clé pour la mémoire serveur
        message: text || "",
        imageDataUrl: imageDataUrl || null
      };

      const data = await safeJSON(API_URL + "/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (data && data.reply) {
        addMsg(data.reply, "bot");
      } else {
        addMsg("Désolé, impossible d’obtenir une réponse pour le moment.", "bot");
      }

      // reset pièce jointe + refresh solde
      imageDataUrl = null;
      preview.textContent = "";
      refreshBalances();
    }

    function toDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Philomène IA – Messenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Clerk Frontend -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <style>
    :root{--bg:#071826;--panel:#0e2238;--muted:#9bb3c9;--accent:#3aa0ff;--danger:#ff4646}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:22px}
    h1{margin:6px 0 2px;font-size:28px;text-align:center}
    .topline{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;color:var(--muted);margin-bottom:14px;font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#0f2b47;border:1px solid #234c77;border-radius:999px}
    .tokens{font-weight:700;color:#fff}
    .logout{background:var(--danger);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    .panel{background:var(--panel);border:1px solid #173a5c;border-radius:12px;padding:14px}
    .alert{margin:0 4px 10px;color:var(--muted);font-size:13px}
    .warn{margin:0 4px 10px;background:#432c00;border:1px solid #7a5600;color:#ffd888;padding:8px 10px;border-radius:8px;display:none}
    .chatbox{height:56vh;min-height:280px;overflow:auto;padding:12px;background:#0b1d31;border:1px solid #153150;border-radius:10px}
    .msg{max-width:88%;margin:8px 0;padding:10px 12px;border-radius:10px;line-height:1.35;font-size:15px;white-space:pre-wrap;word-wrap:break-word}
    .me{margin-left:auto;background:#133a6d;border:1px solid #2d65a2}
    .bot{background:#0f2b47;border:1px solid #2a527e}
    .row{display:flex;gap:10px;margin-top:10px}
    textarea{flex:1;height:54px;resize:none;background:#0b1d31;border:1px solid #173a5c;color:#fff;border-radius:10px;padding:12px;font-size:15px;outline:none}
    .send{background:var(--accent);color:#001427;border:0;border-radius:10px;padding:0 18px;font-weight:700;cursor:pointer}
    .buy{background:#00c853;color:#021014;border:0;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;display:none}
    .photo{background:#00bcd4;color:#021014;border:0;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer}
    .foot{margin-top:10px;text-align:right;color:var(--muted);font-size:13px}
    .thin{font-weight:400;opacity:.9}
    .preview{font-size:12px;color:#beddff;opacity:.9;margin-top:6px}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Philomène IA – Messenger</h1>

    <div class="topline">
      <span id="connectedAs" class="badge">Connexion…</span>
      <span class="badge tokens">Tokens : <span id="tokFree">0</span> / <span id="tokPaid">0</span></span>
      <button id="logout" class="logout">Se déconnecter</button>
    </div>

    <div class="panel">
      <div id="alert" class="alert">Bonjour 👋 Tape un message, ajoute une photo si besoin, et envoie.</div>
      <div id="lowWarn" class="warn">
        Il vous reste peu de tokens. Voulez-vous en ajouter ?
        <button id="topup1" style="margin-left:8px">Ajouter des tokens 🔋</button>
      </div>

      <div id="chat" class="chatbox">
        <div class="msg bot">Bonjour ! Comment puis-je vous aider aujourd’hui ?</div>
      </div>

      <div class="row">
        <textarea id="input" placeholder="Écris ton message… (Entrée = envoyer)"></textarea>
        <button id="send" class="send">Envoyer</button>
        <button id="buy" class="buy">Ajouter des tokens</button>
        <button id="photoBtn" class="photo">📷 Photo</button>
        <input id="file" type="file" accept="image/*" capture="environment" style="display:none" />
      </div>
      <div id="preview" class="preview"></div>
    </div>

    <div class="foot">
      Solde • Gratuit : <span id="fBalance">0</span> • Payant : <span id="pBalance">0</span>
      <span class="thin">• Philomène au service des gens</span>
    </div>
  </div>

  <script>
    // === Backend API ===
    const API_BASE = "https://api.philomeneia.com";

    // === DOM helpers ===
    const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    function addMsg(text, cls) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function setAlert(txt) { $("alert").textContent = txt; }
    function showLowWarn(show) { $("lowWarn").style.display = show ? "block" : "none"; }
    function showBuy(show) { $("buy").style.display = show ? "inline-block" : "none"; }

    async function jsonFetch(url, options = {}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (e) {
        console.error(e);
        setAlert("⚠️ Échec de chargement (" + (e.message || "erreur") + ")");
        return null;
      }
    }

    // === Clerk + App ===
    let email = "inconnu";
    let greetedKey = "";
    let pendingImages = []; // dataURLs des images sélectionnées (envoyées au prochain message)

    window.addEventListener("load", async () => {
      await Clerk.load();

      if (!Clerk.user) {
        window.location.href = "/";
        return;
      }

      email = Clerk.user.primaryEmailAddress?.emailAddress || "inconnu";
      $("connectedAs").textContent = "Connecté ✅ : " + email;
      greetedKey = "ph_greeted_" + email;

      $("logout").onclick = async () => {
        await Clerk.signOut();
        window.location.href = "/";
      };

      $("topup1").onclick = doTopup;
      $("buy").onclick = doTopup;

      // Photo
      $("photoBtn").onclick = () => $("file").click();
      $("file").addEventListener("change", handleFile);

      await refreshBalances();
      setAlert("Prêt ✅");

      const input = $("input");
      const sendBtn = $("send");

      async function sendMessage() {
        const text = input.value.trim();
        if (!text && pendingImages.length === 0) return;

        input.value = "";
        const label = text || (pendingImages.length ? "(Photo envoyée)" : "");
        addMsg(label, "me");

        sendBtn.disabled = true; const old = sendBtn.textContent; sendBtn.textContent = "…";

        const payload = {
          message: text,
          email,
          first: !localStorage.getItem(greetedKey),
          images: pendingImages // tableau de dataURL
        };

        const data = await jsonFetch(`${API_BASE}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        // reset images sélectionnées après envoi
        pendingImages = [];
        $("preview").textContent = "";

        if (data?.reply) {
          addMsg(data.reply, "bot");
          if (payload.first) localStorage.setItem(greetedKey, "1");
          await refreshBalances();
        } else if (data?.error || !data) {
          if (data?.error === "Crédits insuffisants") {
            addMsg("Vous avez utilisé tous vos tokens. Rechargez pour continuer ✨", "bot");
            showBuy(true);
            showLowWarn(false);
          } else {
            addMsg("Désolé, impossible d’obtenir une réponse pour le moment.", "bot");
          }
        }

        sendBtn.disabled = false; sendBtn.textContent = old;
      }

      sendBtn.onclick = sendMessage;
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) {
          e.preventDefault();
          sendMessage();
        }
      });
    });

    async function refreshBalances() {
      const url = `${API_BASE}/api/balance?email=${encodeURIComponent(email)}`;
      const data = await jsonFetch(url);
      if (!data) return;

      const free = Number(data.free || 0);
      const paid = Number(data.paid || 0);
      $("tokFree").textContent = free;
      $("tokPaid").textContent = paid;
      $("fBalance").textContent = free;
      $("pBalance").textContent = paid;

      const total = free + paid;
      showLowWarn(total > 0 && total <= 200);
      showBuy(total <= 200);
    }

    async function doTopup() {
      const data = await jsonFetch(`${API_BASE}/api/topup`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ email })
      });
      if (data?.ok) {
        setAlert(`+${data.added} tokens ajoutés ✅`);
        await refreshBalances();
      } else {
        setAlert("Impossible d’ajouter des tokens pour le moment.");
      }
    }

    function handleFile(ev) {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result; // "data:image/...;base64,AAAA"
        pendingImages.push(dataUrl);
        $("preview").textContent = `Image prête à être envoyée (${pendingImages.length})`;
      };
      reader.readAsDataURL(file);
      // reset pour pouvoir re-sélectionner la même photo ensuite
      ev.target.value = "";
    }
  </script>
</body>
</html>

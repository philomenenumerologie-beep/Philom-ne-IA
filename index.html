<!DOCTYPE html>
<html lang="fr" style="background:#000;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Philom√®ne I.A.</title>
  <meta name="color-scheme" content="dark" />

  <style>
    :root {
      --bg:#000;
      --panel:#0a0a12;
      --line:rgba(255,255,255,0.08);
      --accent:#4c3bff;
      --accent-glow:rgba(120,80,255,0.8);
      --soft:#2b2b2b;
      --text-main:#fff;
      --text-dim:#999;
      --token:#ffd84f;
    }

    body {
      margin:0;
      background:var(--bg);
      color:var(--text-main);
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* HEADER */
    header {
      background:var(--bg);
      border-bottom:1px solid var(--line);
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }

    .left-head,
    .right-head {
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }

    .icon-btn {
      width:40px;
      height:40px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
    }

    .token-box {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:14px;
      line-height:1.2;
      color:var(--token);
      font-weight:600;
      text-align:center;
    }
    .token-value {
      display:flex;
      align-items:center;
      gap:6px;
      font-size:15px;
    }
    .token-value span#token-count {
      color:var(--token);
      font-feature-settings:"tnum";
      font-size:16px;
      font-weight:600;
    }
    .token-label {
      font-size:12px;
      font-weight:400;
      color:var(--text-dim);
    }

    /* MENU (‚ãØ) D√âROULANT */
    .menu-box {
      position:relative;
    }
    .dropdown {
      position:absolute;
      top:48px;
      right:0;
      background:#0f0f1a;
      border:1px solid var(--line);
      border-radius:10px;
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      min-width:180px;
      padding:8px 0;
      display:none;
      z-index:9999;
    }
    .dropdown-btn {
      width:100%;
      background:transparent;
      border:0;
      text-align:left;
      padding:12px 16px;
      font-size:15px;
      color:#fff;
      display:flex;
      justify-content:space-between;
      align-items:center;
    }
    .dropdown-btn:active {
      background:rgba(255,255,255,0.07);
    }
    .dropdown-separator {
      height:1px;
      background:var(--line);
      margin:6px 0;
    }

    /* CHAT AREA */
    .chat-area {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:16px;
      overflow-y:auto;
      background:radial-gradient(circle at 20% 20%, rgba(80,0,255,0.18) 0%, rgba(0,0,0,0) 60%);
    }

    .bubble {
      max-width:90%;
      border-radius:12px;
      padding:16px;
      line-height:1.4;
      font-size:17px;
      box-shadow:0 30px 60px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.08);
      white-space:pre-wrap;
      word-break:break-word;
    }

    .assistant {
      align-self:flex-start;
      background:var(--soft);
      color:var(--text-main);
    }

    .user {
      align-self:flex-end;
      background:radial-gradient(circle at 100% 0%, rgba(130,110,255,.6) 0%, rgba(20,10,60,0) 60%), var(--accent);
      color:#fff;
      font-weight:500;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px var(--accent-glow),0 30px 60px rgba(0,0,0,0.8);
    }

    .thinking {
      font-size:15px;
      color:#ddd;
      background:var(--soft);
    }

    /* BARRE BAS */
    .bottom-zone {
      background:var(--bg);
      border-top:1px solid var(--line);
      padding:16px;
    }
    .input-row {
      display:flex;
      align-items:stretch;
      gap:12px;
    }
    .plus-btn {
      min-width:52px;
      min-height:52px;
      background:var(--accent);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px var(--accent-glow),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:28px;
      line-height:0;
      font-weight:500;
    }
    .message-input {
      flex:1;
      background:#0f0f1a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      font-size:16px;
      color:#fff;
      padding:16px;
      font-family:inherit;
      outline:none;
    }
    .send-btn {
      min-width:52px;
      min-height:52px;
      background:var(--accent);
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px var(--accent-glow),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      line-height:0;
      font-weight:500;
    }
    .status-line {
      text-align:center;
      margin-top:12px;
      font-size:14px;
      color:var(--text-dim);
      font-weight:400;
    }
    .status-line strong {
      font-weight:600;
      color:var(--text-main);
    }

    /* PETIT POPUP "+" (photo, doc, micro) */
    .plus-wrapper {
      position:relative;
    }
    .plus-menu {
      position:absolute;
      bottom:60px;
      left:0;
      background:#0f0f1a;
      border:1px solid var(--line);
      border-radius:10px;
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      min-width:200px;
      padding:8px 0;
      display:none;
      z-index:9999;
    }
    .plus-item {
      width:100%;
      background:transparent;
      border:0;
      text-align:left;
      padding:12px 16px;
      font-size:15px;
      color:#fff;
      display:flex;
      align-items:center;
      justify-content:space-between;
    }
    .plus-item:active {
      background:rgba(255,255,255,0.07);
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="left-head">
      <div class="icon-btn" id="menu-open">‚ò∞</div>
    </div>

    <div class="token-box">
      <div class="token-value">
        <div style="font-size:18px;">üíé</div>
        <span id="token-count">0</span>
        <span style="color:#fff;font-size:14px;">tokens</span>
      </div>
      <div class="token-label">Philom√®ne I.A.</div>
    </div>

    <div class="right-head menu-box">
      <div class="icon-btn" id="more-btn">‚ãØ</div>

      <div class="dropdown" id="dropdown-menu">
        <button class="dropdown-btn" id="login-btn">
          <span>Se connecter</span>
          <span style="opacity:.6;">üîê</span>
        </button>

        <button class="dropdown-btn" id="logout-btn" style="display:none;">
          <span>Se d√©connecter</span>
          <span style="opacity:.6;">üö™</span>
        </button>

        <div class="dropdown-separator"></div>

        <button class="dropdown-btn" id="faq-btn">
          <span>Aide / Comment je t'aide ?</span>
          <span style="opacity:.6;">‚ùì</span>
        </button>
      </div>
    </div>
  </header>

  <!-- CHAT -->
  <div id="chat-area" class="chat-area"></div>

  <!-- BARRE BAS -->
  <div class="bottom-zone">
    <div class="input-row">
      <div class="plus-wrapper">
        <div class="plus-btn" id="plus-toggle">+</div>

        <div class="plus-menu" id="plus-menu">
          <button class="plus-item">
            <span>Envoyer une photo</span><span>üì∑</span>
          </button>
          <button class="plus-item">
            <span>Envoyer un document</span><span>üìé</span>
          </button>
          <button class="plus-item">
            <span>Dicter au micro</span><span>üéô</span>
          </button>
        </div>
      </div>

      <input
        id="msg-input"
        class="message-input"
        placeholder="√âcrivez votre message..."
      />
      <div id="send-btn" class="send-btn">‚û§</div>
    </div>

    <div class="status-line">
      <span id="status-text">Pr√™t</span> ‚Ä¢
      <strong><span id="tokens-bottom">0</span> tokens restants</strong>
    </div>
  </div>

  <script>
    // =============================
    // CONFIG
    // =============================
    const BACKEND_URL = "https://philo-backend-su29.onrender.com";

    // On va stocker ici l'utilisateur courant.
    // Si connect√© via Clerk on aura un vrai userId genre "user_abc123"
    // Pour l'instant on simule: on garde en m√©moire dans le navigateur.
    let currentUserId = localStorage.getItem("philo_userId") || "";

    // Historique local pour l'affichage
    let conversation = [];
    let tokensLeft = 0;

    // =============================
    // HELPERS UI
    // =============================
    const chatArea      = document.getElementById("chat-area");
    const msgInput      = document.getElementById("msg-input");
    const sendBtn       = document.getElementById("send-btn");
    const tokenTopEl    = document.getElementById("token-count");
    const tokenBottomEl = document.getElementById("tokens-bottom");
    const statusTextEl  = document.getElementById("status-text");

    const moreBtn       = document.getElementById("more-btn");
    const dropdownMenu  = document.getElementById("dropdown-menu");
    const loginBtn      = document.getElementById("login-btn");
    const logoutBtn     = document.getElementById("logout-btn");

    const plusToggle    = document.getElementById("plus-toggle");
    const plusMenu      = document.getElementById("plus-menu");

    function scrollToBottom() {
      chatArea.scrollTop = chatArea.scrollHeight;
    }

    function addBubble(text, who) {
      const div = document.createElement("div");
      div.classList.add("bubble");
      if (who === "user") {
        div.classList.add("user");
      } else if (who === "assistant") {
        div.classList.add("assistant");
      } else if (who === "thinking") {
        div.classList.add("assistant","thinking");
      } else {
        div.classList.add("assistant");
      }
      div.textContent = text || "";
      chatArea.appendChild(div);
      scrollToBottom();
      return div;
    }

    function renderConversation() {
      chatArea.innerHTML = "";
      for (const msg of conversation) {
        if (msg.role === "system") {
          // on ne montre pas le system
          continue;
        }
        if (msg.role === "assistant") {
          addBubble(msg.content, "assistant");
        } else if (msg.role === "user") {
          addBubble(msg.content, "user");
        }
      }
    }

    function updateTokenDisplay() {
      tokenTopEl.textContent    = tokensLeft;
      tokenBottomEl.textContent = tokensLeft;
    }

    function setStatus(txt) {
      statusTextEl.textContent = txt;
    }

    // =============================
    // MENU ‚ãØ
    // =============================
    let menuOpen = false;
    moreBtn.addEventListener("click", () => {
      menuOpen = !menuOpen;
      dropdownMenu.style.display = menuOpen ? "block" : "none";

      // maj boutons login/logout selon si on est connect√©
      if (currentUserId) {
        loginBtn.style.display  = "none";
        logoutBtn.style.display = "flex";
      } else {
        loginBtn.style.display  = "flex";
        logoutBtn.style.display = "none";
      }
    });

    // bouton +
    let plusOpen = false;
    plusToggle.addEventListener("click", () => {
      plusOpen = !plusOpen;
      plusMenu.style.display = plusOpen ? "block" : "none";
    });

    // =============================
    // "Connexion" (fake Clerk pour l‚Äôinstant)
    // =============================
    loginBtn.addEventListener("click", () => {
      // ici on ferait Clerk.openSignIn() normalement
      // pour le moment: on simule un ID fixe
      currentUserId = "user_demo";
      localStorage.setItem("philo_userId", currentUserId);
      dropdownMenu.style.display = "none";
      menuOpen = false;
      loadUserState();
    });

    logoutBtn.addEventListener("click", () => {
      // On dit juste au backend "ok", mais surtout on nettoie c√¥t√© front
      fetch(BACKEND_URL + "/logout", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: currentUserId })
      }).catch(()=>{});

      currentUserId = "";
      localStorage.removeItem("philo_userId");
      dropdownMenu.style.display = "none";
      menuOpen = false;
      loadUserState(); // recharge en mode invit√©
    });

    // =============================
    // CHARGER /me
    // =============================
    async function loadUserState() {
      setStatus("Chargement‚Ä¶");

      try {
        const resp = await fetch(BACKEND_URL + "/me", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId: currentUserId })
        });

        const data = await resp.json();

        // tokens
        tokensLeft = data.tokens || 0;
        updateTokenDisplay();

        // historique pour l'affichage
        conversation = data.history || [];
        renderConversation();

        setStatus("Pr√™t");
      } catch (e) {
        console.error(e);
        setStatus("Erreur de connexion serveur");
      }
    }

    // =============================
    // ENVOI MESSAGE -> /ask
    // =============================
    async function sendMessage() {
      const text = msgInput.value.trim();
      if (!text) return;

      // Ajoute ma bulle violette direct
      addBubble(text,"user");
      msgInput.value = "";

      // Bulle "r√©flexion"
      const thinkingDiv = addBubble("Philom√®ne r√©fl√©chit‚Ä¶", "thinking");

      setStatus("R√©ponse en cours‚Ä¶");

      try {
        const resp = await fetch(BACKEND_URL + "/ask", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({
            userId: currentUserId,
            text: text
          })
        });

        const data = await resp.json();

        thinkingDiv.remove();

        if (data.error) {
          addBubble(data.error, "assistant");
          setStatus("Erreur");
          return;
        }

        // r√©ponse IA
        addBubble(data.answer, "assistant");

        // mets √† jour les tokens restants venant du serveur
        if (typeof data.tokens === "number") {
          tokensLeft = data.tokens;
          updateTokenDisplay();
        }

        setStatus("Pr√™t");
      } catch (err) {
        console.error(err);
        thinkingDiv.textContent = "J'ai eu un souci r√©seau üòî";
        setStatus("Erreur r√©seau");
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    msgInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        sendMessage();
      }
    });

    // =============================
    // AU LANCEMENT
    // =============================
    loadUserState();
  </script>
</body>
</html>

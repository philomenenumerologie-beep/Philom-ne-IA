<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Cr√©er mon CV ‚Äì Philom√®ne I.A.</title>

  <!-- On r√©utilise tes styles -->
  <link rel="stylesheet" href="styles.css" />

  <style>
    /* Petit style en plus pour la page CV */
    body {
      background: #050816;
    }
    .cv-page {
      max-width: 900px;
      margin: 0 auto;
      padding: 16px;
    }
    .cv-title {
      font-size: 22px;
      font-weight: 700;
      margin: 12px 0 8px;
    }
    .cv-sub {
      color: var(--text-dim);
      margin-bottom: 16px;
    }
    .cv-card {
      background: var(--panel-2);
      border-radius: 18px;
      padding: 16px;
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow);
      margin-bottom: 16px;
    }
    .cv-grid {
      display: grid;
      gap: 10px;
    }
    @media (min-width: 720px) {
      .cv-grid {
        grid-template-columns: repeat(2, minmax(0, 1fr));
      }
    }
    .cv-label {
      font-size: 13px;
      color: var(--text-dim);
      margin-bottom: 4px;
    }
    .cv-input, .cv-textarea {
      width: 100%;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.12);
      background: #020617;
      color: var(--text);
      padding: 8px 10px;
      font-size: 14px;
      resize: vertical;
    }
    .cv-textarea {
      min-height: 80px;
    }
    .cv-actions {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
    }
    .cv-button {
      border: 0;
      border-radius: 999px;
      padding: 10px 18px;
      cursor: pointer;
      font-weight: 600;
      font-size: 15px;
      background: linear-gradient(180deg, var(--accent), var(--accent-2));
      color: #fff;
      box-shadow: 0 10px 26px rgba(122,77,255,.45);
    }
    .cv-back {
      border-radius: 999px;
      padding: 8px 14px;
      font-size: 14px;
      border: 1px solid rgba(255,255,255,.15);
      background: transparent;
      color: var(--text-dim);
      cursor: pointer;
    }
    .cv-output {
      white-space: pre-wrap;
      word-wrap: break-word;
      overflow-wrap: anywhere;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      font-size: 14px;
    }
    .cv-status {
      font-size: 13px;
      color: var(--text-dim);
      margin-top: 6px;
    }
  </style>
</head>

<body class="theme-dark">
  <!-- Topbar simplifi√©e -->
  <header id="topbar" role="banner">
    <div class="topbar__left">
      <button class="chip" onclick="window.location.href='index.html'">
        ‚¨Ö Retour √† Philom√®ne
      </button>
    </div>
    <div class="topbar__right">
      <div id="tokenBadge" class="gem" aria-live="polite">
        <span class="gem__icon" aria-hidden="true">üíé</span>
        <span id="tokenCount">0</span>
      </div>
    </div>
  </header>

  <div id="versionLine" aria-live="polite">
    <span class="dot dot--on" aria-hidden="true"></span>
    <span>Module CV ‚Äì <strong>Philom√®ne I.A.</strong></span>
  </div>

  <main class="cv-page">
    <div class="cv-card">
      <div class="cv-title">Cr√©er mon CV avec Philom√®ne</div>
      <div class="cv-sub">
        Remplis les infos ci-dessous, Philom√®ne va g√©n√©rer un CV clair et professionnel
        que tu pourras copier-coller ou adapter.
      </div>

      <div class="cv-grid">
        <div>
          <div class="cv-label">Ton nom complet</div>
          <input id="cv-name" class="cv-input" placeholder="Pr√©nom NOM" />
        </div>
        <div>
          <div class="cv-label">Poste vis√©</div>
          <input id="cv-job" class="cv-input" placeholder="Ex : Pr√©parateur de commandes, cariste, √©ducateur..." />
        </div>
        <div>
          <div class="cv-label">Ville / R√©gion</div>
          <input id="cv-city" class="cv-input" placeholder="Ex : Li√®ge, Bruxelles, Lille..." />
        </div>
        <div>
          <div class="cv-label">Secteur</div>
          <input id="cv-sector" class="cv-input" placeholder="Ex : logistique, vente, b√¢timent..." />
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="cv-label">Tes exp√©riences (m√™me courtes, int√©rims‚Ä¶)</div>
        <textarea id="cv-exp" class="cv-textarea" placeholder="Ex : 2 ans comme pr√©parateur de commandes chez X, 6 mois en usine, etc."></textarea>
      </div>

      <div style="margin-top:10px">
        <div class="cv-label">Tes comp√©tences / qualit√©s</div>
        <textarea id="cv-skills" class="cv-textarea" placeholder="Ex : s√©rieux, ponctuel, sait travailler en √©quipe, permis cariste, bonne condition physique‚Ä¶"></textarea>
      </div>

      <div style="margin-top:10px">
        <div class="cv-label">Autres infos utiles (permis, langues, dispo, etc.)</div>
        <textarea id="cv-extra" class="cv-textarea" placeholder="Ex : Permis B, v√©hicule, disponible le week-end, parle fran√ßais et un peu n√©erlandais‚Ä¶"></textarea>
      </div>

      <div class="cv-actions">
        <button id="cv-generate" class="cv-button">‚ú® G√©n√©rer mon CV</button>
        <div id="cv-status" class="cv-status"></div>
      </div>
    </div>

    <div class="cv-card">
      <div class="cv-label">R√©sultat du CV (tu peux copier-coller) :</div>
      <div id="cv-output" class="cv-output">
        Ton CV g√©n√©r√© appara√Ætra ici.
      </div>
    </div>
  </main>

  <script>
    // M√™me logique d'utilisateur que Philom√®ne (userId + tokens en localStorage)
    const API_URL = "https://api.philomeneia.com/ask";
    const LS_USER   = "philo_user_id";
    const LS_TOKENS = "philo_tokens_balance";

    let userId = localStorage.getItem(LS_USER);
    if (!userId) {
      userId = "guest_" + Math.random().toString(36).slice(2,10);
      localStorage.setItem(LS_USER, userId);
    }

    let tokenBalance = Number(localStorage.getItem(LS_TOKENS));
    if (!Number.isFinite(tokenBalance) || tokenBalance < 0) {
      tokenBalance = 0;
    }
    const tokenCountEl = document.getElementById("tokenCount");
    if (tokenCountEl) {
      tokenCountEl.textContent = tokenBalance.toLocaleString("fr-FR");
    }

    const btn = document.getElementById("cv-generate");
    const statusEl = document.getElementById("cv-status");
    const outputEl = document.getElementById("cv-output");

    function setStatus(msg) {
      statusEl.textContent = msg || "";
    }

    btn.addEventListener("click", async () => {
      const name   = document.getElementById("cv-name").value.trim();
      const job    = document.getElementById("cv-job").value.trim();
      const city   = document.getElementById("cv-city").value.trim();
      const sector = document.getElementById("cv-sector").value.trim();
      const exp    = document.getElementById("cv-exp").value.trim();
      const skills = document.getElementById("cv-skills").value.trim();
      const extra  = document.getElementById("cv-extra").value.trim();

      if (!name || !job) {
        setStatus("Merci de remplir au moins ton nom et le poste vis√©.");
        return;
      }

      setStatus("‚è≥ G√©n√©ration du CV en cours‚Ä¶");
      outputEl.textContent = "Philom√®ne pr√©pare ton CV‚Ä¶";

      const userPrompt =
        "G√©n√®re un CV complet, clair et professionnel en fran√ßais, format texte simple (sans tableau, sans mise en page trop compliqu√©e). " +
        "Structure : titre avec le nom et le poste vis√©, r√©sum√© / profil, exp√©riences, comp√©tences, autres informations.\n\n" +
        "Infos fournies :\n" +
        "- Nom : " + name + "\n" +
        "- Poste vis√© : " + job + "\n" +
        (city   ? "- Ville / r√©gion : " + city + "\n" : "") +
        (sector ? "- Secteur : " + sector + "\n" : "") +
        (exp    ? "- Exp√©riences : " + exp + "\n" : "") +
        (skills ? "- Comp√©tences / qualit√©s : " + skills + "\n" : "") +
        (extra  ? "- Autres infos : " + extra + "\n" : "") +
        "\nAdapte le ton √† quelqu‚Äôun de s√©rieux, motiv√©, qui cherche du travail.";

      const conversation = [
        { role: "user", content: userPrompt }
      ];

      try {
        const resp = await fetch(API_URL, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId, conversation })
        });

        const data = await resp.json();

        const answer =
          data?.answer ||
          data?.output ||
          data?.text ||
          "Je n‚Äôai pas r√©ussi √† g√©n√©rer le CV. R√©essaie dans un instant.";

        outputEl.textContent = answer;
        setStatus("‚úÖ CV g√©n√©r√©. Tu peux le modifier et le copier-coller.");

        // Mise √† jour des tokens si pr√©sents
        if (data?.usage?.total_tokens && typeof data.usage.total_tokens === "number") {
          const used = Math.max(0, data.usage.total_tokens);
          tokenBalance = Math.max(0, tokenBalance - used);
          localStorage.setItem(LS_TOKENS, tokenBalance);
          if (tokenCountEl) {
            tokenCountEl.textContent = tokenBalance.toLocaleString("fr-FR");
          }
        }
      } catch (err) {
        console.error(err);
        outputEl.textContent = "Erreur de connexion avec le serveur.";
        setStatus("‚ùå Erreur, r√©essaie un peu plus tard.");
      }
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>Philomène IA</title>

  <!-- CONFIG PERSONNALISABLE -->
  <meta name="api-base" content="https://api.philomeneia.com" />
  <meta name="clerk-publishable-key" content="pk_test_ZW5vdWdelXPv7Wwm9..." />
  <!-- Remplace la valeur pk_test_ZW5... par ta vraie clé Clerk publishable EXACTE -->

  <style>
    :root {
      --bg-main: #0f1a24;
      --bg-card: #1a2a3a;
      --bg-header: rgba(15,26,36,0.9);
      --bg-header-border: rgba(255,255,255,0.07);
      --bg-input: #13202d;
      --bg-user: #0056d6;
      --bg-assistant: #1f3448;
      --accent: #0a84ff;
      --accent-soft: rgba(10,132,255,0.18);
      --text-main: #ffffff;
      --text-dim: #9fb4c8;
      --bubble-radius: 16px;
      --border-soft: rgba(255,255,255,0.08);
      --shadow-card: 0 20px 40px rgba(0,0,0,0.7);
      --shadow-header: 0 10px 30px rgba(0,0,0,0.8);
      --radius-card: 14px;
      --radius-btn: 10px;
      --radius-input: 12px;
      --font-stack: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, "Helvetica Neue", Arial, sans-serif;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      text-rendering: optimizeLegibility;
    }

    body {
      margin: 0;
      background-color: var(--bg-main);
      color: var(--text-main);
      font-family: var(--font-stack);
      line-height: 1.45;
    }

    /* HEADER FIXE */
    .app-header {
      position: sticky;
      top: 0;
      z-index: 1000;
      background: var(--bg-header);
      backdrop-filter: blur(12px);
      -webkit-backdrop-filter: blur(12px);
      border-bottom: 1px solid var(--bg-header-border);
      box-shadow: var(--shadow-header);
      padding: env(safe-area-inset-top) 16px 12px 16px;
    }

    .top-row {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      row-gap: 8px;
    }

    .brand-side {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .brand-line {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 17px;
      font-weight: 600;
      color: var(--text-main);
    }

    .brand-icon {
      width: 20px;
      height: 20px;
      border-radius: 6px;
      background: radial-gradient(circle at 30% 30%, #ff80c8 0%, #ff0088 60%, #4a0030 100%);
      box-shadow: 0 8px 20px rgba(255,0,136,0.6);
      flex-shrink: 0;
    }

    .brand-sub {
      font-size: 12px;
      font-weight: 500;
      color: var(--text-dim);
    }

    .status-side {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      text-align: right;
      gap: 6px;
      min-width: 0;
      flex-shrink: 0;
    }

    .status-row {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 8px;
      min-width: 0;
    }

    .pill-status {
      background-color: var(--bg-input);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-btn);
      padding: 4px 8px;
      font-size: 12px;
      color: var(--text-main);
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 6px;
      box-shadow: 0 10px 20px rgba(0,0,0,0.8);
      max-width: 100%;
    }

    .pill-status .small-label {
      font-size: 11px;
      font-weight: 500;
      color: var(--text-dim);
      line-height: 1.2;
    }

    .pill-tokens {
      background-color: var(--accent-soft);
      color: var(--accent);
      border: 1px solid rgba(10,132,255,0.4);
      border-radius: var(--radius-btn);
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 600;
      line-height: 1.2;
      box-shadow: 0 10px 20px rgba(0,0,0,0.8);
    }

    .btn-auth {
      appearance: none;
      border: 0;
      outline: 0;
      background-color: var(--accent);
      color: #fff;
      font-size: 13px;
      font-weight: 600;
      line-height: 1.2;
      border-radius: var(--radius-btn);
      padding: 6px 10px;
      box-shadow: 0 14px 30px rgba(10,132,255,0.5);
    }

    .tools-row {
      margin-top: 8px;
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-settings,
    .btn-clear {
      appearance: none;
      border: 0;
      background-color: var(--bg-input);
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-size: 13px;
      font-weight: 500;
      padding: 6px 10px;
      line-height: 1.2;
      border-radius: var(--radius-btn);
      box-shadow: 0 14px 30px rgba(0,0,0,0.8);
    }

    .btn-clear {
      background-color: #b00020;
      border-color: rgba(255,255,255,0.15);
      box-shadow: 0 14px 30px rgba(176,0,32,0.6);
    }

    /* CONTENU CHAT */
    .chat-wrapper {
      display: flex;
      flex-direction: column;
      padding: 12px 16px calc(90px + env(safe-area-inset-bottom));
      max-width: 700px;
      margin: 0 auto;
    }

    .bubble {
      max-width: 90%;
      border-radius: var(--bubble-radius);
      padding: 14px 16px;
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.45;
      box-shadow: var(--shadow-card);
      white-space: pre-wrap;
      word-break: break-word;
    }

    .row-msg {
      display: flex;
      margin-bottom: 12px;
      width: 100%;
    }

    .you {
      justify-content: flex-end;
    }

    .you .bubble {
      background-color: var(--bg-user);
      border-bottom-right-radius: 4px;
      color: #fff;
    }

    .assistant {
      justify-content: flex-start;
    }

    .assistant .bubble {
      background-color: var(--bg-assistant);
      border-bottom-left-radius: 4px;
    }

    .system {
      justify-content: center;
    }

    .system .bubble {
      background-color: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-card);
      font-size: 15px;
      line-height: 1.45;
      color: var(--text-main);
      box-shadow: var(--shadow-card);
      width: 100%;
      max-width: 100%;
    }

    .system ul {
      padding-left: 20px;
      margin: 8px 0 0 0;
      color: var(--text-main);
    }

    .system li {
      margin-bottom: 6px;
      color: var(--text-main);
      font-size: 15px;
      line-height: 1.45;
    }

    .dim-note {
      font-size: 13px;
      line-height: 1.4;
      color: var(--text-dim);
      margin-top: 10px;
    }

    /* BARRE D'ENVOI (FOOTER FIXE) */
    .composer-shell {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      z-index: 1000;
      background: linear-gradient(to top, rgba(15,26,36,1) 0%, rgba(15,26,36,0.8) 60%, rgba(15,26,36,0) 100%);
      padding: 16px 16px calc(16px + env(safe-area-inset-bottom));
      box-shadow: 0 -20px 40px rgba(0,0,0,0.9);
    }

    .composer-inner {
      max-width: 700px;
      margin: 0 auto;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .composer-row {
      display: flex;
      align-items: flex-end;
      gap: 8px;
    }

    .btn-photo {
      background-color: var(--bg-input);
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      border-radius: var(--radius-input);
      padding: 12px;
      font-size: 15px;
      line-height: 1;
      min-width: 44px;
      min-height: 44px;
      text-align: center;
      box-shadow: var(--shadow-card);
    }

    .field-shell {
      flex: 1;
      background-color: var(--bg-input);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-input);
      box-shadow: var(--shadow-card);
      display: flex;
      align-items: center;
      padding: 10px 12px;
    }

    .field-shell textarea {
      flex: 1;
      border: 0;
      background: transparent;
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.4;
      resize: none;
      outline: none;
      max-height: 120px;
    }

    .btn-send {
      background-color: var(--accent);
      color: #fff;
      border: 0;
      font-size: 16px;
      font-weight: 600;
      min-width: 88px;
      line-height: 1.2;
      border-radius: var(--radius-input);
      padding: 12px 16px;
      box-shadow: 0 18px 36px rgba(10,132,255,0.55);
    }

    .tokens-left {
      font-size: 13px;
      font-weight: 500;
      line-height: 1.4;
      color: var(--text-dim);
      text-align: right;
      padding-right: 4px;
    }
  </style>
</head>
<body>

  <!-- HEADER -->
  <header class="app-header">
    <div class="top-row">
      <div class="brand-side">
        <div class="brand-line">
          <div class="brand-icon"></div>
          <div>Philomène IA</div>
        </div>
        <div class="brand-sub">Assistante personnelle intelligente</div>
      </div>

      <div class="status-side">
        <div class="status-row">
          <div class="pill-status" id="userStatus">
            <span id="userRole">Invité 👥</span>
            <span class="small-label" id="userEmail" style="display:none;"></span>
          </div>

          <div class="pill-tokens" id="tokenBadge">
            Tokens: <span id="tokenCount">1000</span>
          </div>

          <button class="btn-auth" id="authBtn">
            Créer un compte / Se connecter
          </button>
        </div>

        <div class="tools-row">
          <button class="btn-settings" id="settingsBtn">Réglages</button>
          <button class="btn-clear" id="clearBtn">Vider chat</button>
        </div>
      </div>
    </div>
  </header>

  <!-- CHAT -->
  <main class="chat-wrapper" id="chatWrapper">

    <!-- Message système d'accueil (scrollable, pas bloqué) -->
    <div class="row-msg system">
      <div class="bubble">
        <strong>Salut 👋 Je suis Philomène IA.</strong><br />
        Je peux t'aider pour tes devoirs, écrire un mail pro, corriger un texte, cuisiner avec ce que tu as dans ton frigo, traduire, expliquer une panne, préparer un CV, t'expliquer une facture... calmement étape par étape.

        <ul>
          <li>Mode invité&nbsp;: tu testes gratuitement (1000 tokens).</li>
          <li>Quand tu crées ton compte (e-mail vérifié)&nbsp;: tu passes à 5000 tokens et on garde l'historique.</li>
        </ul>

        <div class="dim-note">
          Politique / actu du jour&nbsp;: je peux parfois ne pas avoir la toute dernière info en temps réel.
        </div>
      </div>
    </div>

    <!-- Conversation va s'ajouter ici -->
    <div id="chatLog"></div>
  </main>

  <!-- COMPOSER -->
  <footer class="composer-shell">
    <div class="composer-inner">
      <div class="composer-row">
        <button class="btn-photo" id="photoBtn">📷</button>

        <div class="field-shell">
          <textarea id="userInput" rows="1" placeholder="Écris ton message… (Entrée = envoyer)"></textarea>
        </div>

        <button class="btn-send" id="sendBtn">Envoyer</button>
      </div>

      <div class="tokens-left">
        Solde: <span id="tokensLeftFooter">1000</span> tokens restants
      </div>
    </div>
  </footer>

  <script>
    // CONFIG
    const API_BASE = document.querySelector('meta[name="api-base"]').content;

    // état local
    let currentUser = {
      id: null,                 // si connecté
      email: null,
      tokens: 1000,             // invité par défaut
      isGuest: true
    };

    // éléments du DOM
    const chatLogEl = document.getElementById('chatLog');
    const userInputEl = document.getElementById('userInput');
    const sendBtnEl = document.getElementById('sendBtn');
    const clearBtnEl = document.getElementById('clearBtn');
    const settingsBtnEl = document.getElementById('settingsBtn');
    const authBtnEl = document.getElementById('authBtn');
    const tokenBadgeEl = document.getElementById('tokenBadge');
    const tokenCountEl = document.getElementById('tokenCount');
    const tokensLeftFooterEl = document.getElementById('tokensLeftFooter');
    const userStatusEl = document.getElementById('userStatus');
    const userEmailEl = document.getElementById('userEmail');

    // rendu visuel statut / tokens
    function renderHeaderState() {
      tokenCountEl.textContent = currentUser.tokens;
      tokensLeftFooterEl.textContent = currentUser.tokens;

      if (currentUser.isGuest) {
        userStatusEl.textContent = "Invité 👥";
        userEmailEl.style.display = "none";
        tokenBadgeEl.style.backgroundColor = "var(--accent-soft)";
      } else {
        userStatusEl.textContent = "Connecté ✅";
        userEmailEl.style.display = "inline";
        userEmailEl.textContent = currentUser.email || "";
        tokenBadgeEl.style.backgroundColor = "var(--accent-soft)";
      }
    }

    // créer une bulle dans le chat
    function addMessageBubble(sender, text) {
      const row = document.createElement("div");
      row.className = "row-msg " + (sender === "user" ? "you" : "assistant");

      const bubble = document.createElement("div");
      bubble.className = "bubble";
      bubble.textContent = text;

      row.appendChild(bubble);
      chatLogEl.appendChild(row);

      // auto-scroll bas
      window.requestAnimationFrame(() => {
        window.scrollTo({
          top: document.body.scrollHeight,
          behavior: "smooth"
        });
      });
    }

    // envoyer message au backend
    async function sendMessage() {
      const msg = userInputEl.value.trim();
      if (!msg) return;

      // afficher bulle utilisateur
      addMessageBubble("user", msg);

      // vider input
      userInputEl.value = "";
      userInputEl.style.height = "auto";

      // appel backend
      try {
        const r = await fetch(API_BASE + "/chat", {
          method: "POST",
          headers: {
            "Content-Type": "application/json"
          },
          body: JSON.stringify({
            user_id: currentUser.id ?? "guest",
            message: msg
          })
        });

        if (!r.ok) {
          addMessageBubble("assistant", "Désolé, erreur serveur.");
          return;
        }

        const data = await r.json();

        // réponse du bot
        const answer = data.reply || "Désolé, pas de réponse.";
        addMessageBubble("assistant", answer);

        // mettre à jour tokens s'ils reviennent du backend
        if (typeof data.tokens_left === "number") {
          currentUser.tokens = data.tokens_left;
          renderHeaderState();
        }

      } catch (err) {
        addMessageBubble("assistant", "Désolé, erreur réseau.");
      }
    }

    // écouteurs
    sendBtnEl.addEventListener("click", sendMessage);

    userInputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    userInputEl.addEventListener("input", () => {
      userInputEl.style.height = "auto";
      userInputEl.style.height = userInputEl.scrollHeight + "px";
    });

    clearBtnEl.addEventListener("click", () => {
      chatLogEl.innerHTML = "";
      addMessageBubble("assistant", "Conversation effacée ✅");
    });

    settingsBtnEl.addEventListener("click", () => {
      // plus tard: ouvrir panneau (paiement etc.)
      addMessageBubble("assistant", "Réglages bientôt disponibles ⚙️");
    });

    authBtnEl.addEventListener("click", () => {
      // plus tard: on ouvrira un vrai flux Clerk (inscription / e-mail code)
      addMessageBubble("assistant", "Pour créer un compte / se connecter, la vérification e-mail arrive bientôt ✉️");
    });

    // init visuel
    renderHeaderState();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Philomène IA – Messenger GPT ✨</title>

  <!-- À TOI DE METTRE LES BONNES VALEURS ICI -->
  <meta name="api-base" content="https://api.philomeneia.com" />
  <meta name="clerk-publishable-key" content="pk_test_xxx" />

  <style>
    :root {
      --bg:#071826;
      --panel:#0e2238;
      --panel-border:#1a314c;
      --text:#eaf2f8;
      --text-dim:#9db4c8;
      --accent:#3fb0ff;
      --chip:#133a5a;
      --chip-border:#1f567d;
      --chip-text:#d5ecff;
      --danger:#f15b5b;
      --input-bg:#0c1a28;
      --input-border:#1b3c58;
      --btn-bg:#1b3c58;
      --btn-text:#fff;
      --radius-lg:18px;
      --radius-md:12px;
      --radius-sm:8px;
    }

    [data-theme="light"]{
      --bg:#f4f7fb;
      --panel:#ffffff;
      --panel-border:#dbe5ef;
      --text:#1c2732;
      --text-dim:#4a5d70;
      --accent:#0067ff;
      --chip:#eaf2ff;
      --chip-border:#c9dcff;
      --chip-text:#002855;
      --danger:#bf2a2a;
      --input-bg:#ffffff;
      --input-border:#94a9c4;
      --btn-bg:#0067ff;
      --btn-text:#fff;
    }

    body{
      background-color:var(--bg);
      color:var(--text);
      font-family:-apple-system,BlinkMacSystemFont,system-ui,"Inter",Roboto,"Helvetica Neue",sans-serif;
      margin:0;
      padding:16px 16px 120px;
      line-height:1.45;
      max-width:720px;
      margin-left:auto;
      margin-right:auto;
    }

    header.app-header{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-bottom:16px;
    }

    .top-row{
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      gap:12px 16px;
    }

    .brand-block{
      flex:1;
      min-width:180px;
    }

    .brand-title{
      font-size:20px;
      font-weight:600;
      color:var(--text);
      display:flex;
      flex-wrap:wrap;
      line-height:1.25;
    }

    .brand-sub{
      font-size:14px;
      color:var(--text-dim);
      line-height:1.4;
      margin-top:4px;
    }

    .status-row{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }

    .status-chip{
      background-color:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:var(--radius-md);
      padding:12px 16px;
      min-width:180px;
      display:flex;
      flex-direction:column;
      font-size:14px;
      line-height:1.4;
      box-shadow:0 20px 40px rgba(0,0,0,0.6);
    }

    .status-line{
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:500;
      color:var(--text);
    }

    .dot-online{
      width:10px;
      height:10px;
      border-radius:999px;
      background:#00d563;
      box-shadow:0 0 8px #00d563;
      flex-shrink:0;
    }

    .status-email{
      font-size:13px;
      color:var(--text-dim);
      word-break:break-all;
    }

    .status-tokens{
      font-size:14px;
      color:var(--accent);
      font-weight:600;
    }

    .header-buttons{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }

    .btn-square{
      background-color:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:var(--radius-md);
      padding:12px 16px;
      font-size:14px;
      line-height:1.4;
      color:var(--text);
      min-width:120px;
      text-align:center;
      box-shadow:0 20px 40px rgba(0,0,0,0.6);
      display:flex;
      align-items:center;
      justify-content:center;
      gap:8px;
    }

    .btn-square strong{
      font-weight:500;
    }

    /* zone chat */
    .chat-shell{
      background-color:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:var(--radius-lg);
      padding:16px;
      box-shadow:0 30px 60px rgba(0,0,0,0.7);
      margin-bottom:16px;
    }

    .bubble{
      background-color:#102a45;
      border:1px solid var(--panel-border);
      border-radius:var(--radius-md);
      padding:16px;
      color:var(--text);
      line-height:1.5;
      font-size:16px;
    }
    [data-theme="light"] .bubble{
      background-color:#eef5ff;
      border:1px solid #c9dcff;
      color:#002855;
    }

    .bubble h2{
      font-size:18px;
      font-weight:600;
      margin:0 0 12px;
      display:flex;
      align-items:center;
      gap:8px;
      color:var(--text);
    }
    .bubble p{
      margin:0 0 8px;
    }
    .bubble ul{
      margin:0 0 12px 0;
      padding-left:20px;
    }
    .bubble li{
      margin-bottom:6px;
    }

    /* messages dynamiques */
    .messages{
      display:flex;
      flex-direction:column;
      gap:12px;
      margin-top:16px;
      max-height:40vh;
      overflow-y:auto;
      scrollbar-width:thin;
      scrollbar-color:var(--panel-border) transparent;
    }
    .messages::-webkit-scrollbar{
      width:4px;
    }
    .messages::-webkit-scrollbar-thumb{
      background:var(--panel-border);
      border-radius:999px;
    }

    .msg{
      max-width:90%;
      border-radius:var(--radius-md);
      padding:12px 14px;
      line-height:1.45;
      font-size:15px;
      white-space:pre-wrap;
      word-break:break-word;
      border:1px solid var(--panel-border);
    }
    .msg.me{
      align-self:flex-end;
      background-color:var(--accent);
      color:#000;
      border-color:var(--accent);
      font-weight:500;
      box-shadow:0 20px 40px rgba(0,0,0,0.5);
    }
    .msg.bot{
      align-self:flex-start;
      background-color:#102a45;
      color:var(--text);
      box-shadow:0 20px 40px rgba(0,0,0,0.6);
    }
    [data-theme="light"] .msg.bot{
      background-color:#eef5ff;
      color:#002855;
      border-color:#c9dcff;
    }

    /* barre d'entrée */
    .composer-shell{
      position:fixed;
      left:0;
      right:0;
      bottom:0;
      background:linear-gradient(to top, rgba(0,0,0,0.8) 0%, rgba(0,0,0,0) 100%);
      padding:16px;
      display:flex;
      justify-content:center;
      pointer-events:none;
    }
    [data-theme="light"] .composer-shell{
      background:linear-gradient(to top, rgba(255,255,255,0.9) 0%, rgba(255,255,255,0) 100%);
    }

    .composer-inner{
      background-color:var(--panel);
      border:1px solid var(--panel-border);
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      border-radius:var(--radius-lg);
      padding:16px;
      width:100%;
      max-width:720px;
      pointer-events:auto;
      display:flex;
      flex-wrap:wrap;
      gap:12px;
    }

    .input-area{
      flex:1;
      min-width:180px;
      background-color:var(--input-bg);
      border:1px solid var(--input-border);
      border-radius:var(--radius-md);
      padding:12px;
      color:var(--text);
      font-size:15px;
      line-height:1.4;
    }
    [data-theme="light"] .input-area{
      color:#1c2732;
    }
    .input-area:focus{
      outline:2px solid var(--accent);
      outline-offset:-2px;
    }

    .row-actions{
      display:flex;
      flex-wrap:nowrap;
      gap:12px;
      width:100%;
    }
    @media(min-width:480px){
      .row-actions{
        width:auto;
        margin-left:auto;
      }
    }

    .btn-action{
      background-color:var(--input-bg);
      border:1px solid var(--input-border);
      border-radius:var(--radius-md);
      color:var(--text);
      min-width:44px;
      min-height:44px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:15px;
      line-height:1.2;
      padding:0 12px;
    }
    [data-theme="light"] .btn-action{
      color:#1c2732;
    }

    .btn-send{
      background-color:var(--btn-bg);
      border:1px solid var(--btn-bg);
      color:var(--btn-text);
      font-weight:600;
      min-width:110px;
      border-radius:var(--radius-md);
      font-size:16px;
      line-height:1.2;
      padding:0 16px;
      display:flex;
      align-items:center;
      justify-content:center;
      box-shadow:0 20px 40px rgba(0,0,0,0.6);
    }

    /* modal réglages */
    .modal-overlay{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,0.6);
      display:none;
      align-items:center;
      justify-content:center;
      padding:24px;
      z-index:9999;
    }
    .modal{
      width:100%;
      max-width:360px;
      background-color:var(--panel);
      border:1px solid var(--panel-border);
      border-radius:var(--radius-lg);
      box-shadow:0 40px 80px rgba(0,0,0,0.9);
      color:var(--text);
      padding:20px;
      font-size:15px;
      line-height:1.4;
    }
    .modal h3{
      margin-top:0;
      margin-bottom:12px;
      font-size:17px;
      font-weight:600;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .modal section{
      border-top:1px solid var(--panel-border);
      padding-top:12px;
      margin-top:12px;
    }
    .modal label{
      display:block;
      font-size:14px;
      font-weight:500;
      color:var(--text-dim);
      margin-bottom:6px;
    }
    .modal-row{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip-option{
      background-color:var(--chip);
      border:1px solid var(--chip-border);
      color:var(--chip-text);
      padding:8px 12px;
      border-radius:var(--radius-md);
      font-size:14px;
      font-weight:500;
    }
    .close-settings{
      display:block;
      width:100%;
      margin-top:16px;
      text-align:center;
      font-size:15px;
      font-weight:500;
      background-color:var(--btn-bg);
      border:1px solid var(--btn-bg);
      color:var(--btn-text);
      border-radius:var(--radius-md);
      padding:10px 12px;
    }

  </style>
</head>
<body>

<header class="app-header">
  <div class="top-row">
    <div class="brand-block">
      <div class="brand-title">
        <span>🧠&nbsp;Philomène IA – Messenger GPT ✨</span>
      </div>
      <div class="brand-sub">
        Pose ta question. J’explique, je corrige, je guide pas à pas.<br/>
        FR • EN • NL • Texte ou photo.
      </div>
    </div>

    <div class="header-buttons">
      <div class="status-chip" id="statusBox">
        <div class="status-line">
          <div class="dot-online"></div>
          <div>Connecté</div>
        </div>
        <div class="status-email" id="userEmail">email@example.com</div>
        <div class="status-tokens">
          Tokens restants : <span id="tokenCount">5000</span>
        </div>
      </div>

      <button class="btn-square" id="printBtn">
        🖨️ <strong>Imprimer</strong>
      </button>

      <button class="btn-square" id="settingsBtn">
        ⚙️ <strong>Réglages</strong>
      </button>
    </div>
  </div>
</header>

<main class="chat-shell">

  <!-- Premier message de présentation -->
  <div class="bubble">
    <h2>Salut 👋</h2>
    <p>Je suis Philomène IA.</p>
    <p>Tu peux me demander :</p>
    <ul>
      <li>expliquer un devoir</li>
      <li>écrire un mail / CV / texte</li>
      <li>donner une idée business</li>
      <li>t’aider à réparer un truc (tu peux m’envoyer une photo 📸)</li>
      <li>cuisiner avec ce qu’il y a dans ton frigo</li>
    </ul>
    <p>Écris ou envoie une photo.</p>
  </div>

  <!-- zone qui va se remplir avec la vraie conversation -->
  <div class="messages" id="messages"></div>

</main>

<!-- zone en bas pour écrire -->
<div class="composer-shell">
  <div class="composer-inner">
    <textarea id="userInput" class="input-area" rows="2"
      placeholder="Écris ton message… (Entrée = envoyer)"></textarea>

    <div class="row-actions">
      <button class="btn-action" id="photoBtn">📷</button>
      <input type="file" id="photoFile" accept="image/*" style="display:none" />
      <button class="btn-send" id="sendBtn">Envoyer</button>
    </div>
  </div>
</div>

<!-- MODAL RÉGLAGES -->
<div class="modal-overlay" id="settingsModal">
  <div class="modal">
    <h3>⚙️ Réglages</h3>

    <section>
      <label>Thème</label>
      <div class="modal-row">
        <div class="chip-option" data-theme-choice="light">🌞 Clair</div>
        <div class="chip-option" data-theme-choice="dark">🌙 Sombre</div>
      </div>
    </section>

    <section>
      <label>Langue</label>
      <div class="modal-row">
        <div class="chip-option" data-lang="fr">🇫🇷 FR</div>
        <div class="chip-option" data-lang="en">🇬🇧 EN</div>
        <div class="chip-option" data-lang="nl">🇳🇱 NL</div>
      </div>
    </section>

    <section>
      <label>Crédits / packs</label>
      <div class="modal-row">
        <div class="chip-option">5 € • 70 000 tokens</div>
        <div class="chip-option">10 € • 150 000 tokens</div>
        <div class="chip-option">20 € • 320 000 tokens</div>
      </div>
      <small style="color:var(--text-dim);font-size:12px;line-height:1.4;display:block;margin-top:8px;">
        Paiement sécurisé (à brancher).
      </small>
    </section>

    <button class="close-settings" id="closeSettingsBtn">Fermer</button>
  </div>
</div>

<script>
(function(){
  // récupère les metas config
  const apiBase = document.querySelector('meta[name="api-base"]').content.trim();
  const clerkKey = document.querySelector('meta[name="clerk-publishable-key"]').content.trim();

  // état local
  let currentUser = {
    id: "anonymous",
    email: "email@example.com",
    tokens: 5000
  };
  let currentTheme = document.documentElement.getAttribute("data-theme") || "dark";
  let currentLang = "fr";
  let attachedImageData = null; // base64 si photo envoyée

  // DOM refs
  const tokenCountEl = document.getElementById("tokenCount");
  const userEmailEl = document.getElementById("userEmail");
  const messagesEl = document.getElementById("messages");
  const userInputEl = document.getElementById("userInput");
  const sendBtn = document.getElementById("sendBtn");
  const photoBtn = document.getElementById("photoBtn");
  const photoFile = document.getElementById("photoFile");
  const printBtn = document.getElementById("printBtn");
  const settingsBtn = document.getElementById("settingsBtn");
  const settingsModal = document.getElementById("settingsModal");
  const closeSettingsBtn = document.getElementById("closeSettingsBtn");

  // helpers UI
  function addMessage(role, text){
    const div = document.createElement("div");
    div.className = "msg " + (role === "user" ? "me" : "bot");
    div.textContent = text;
    messagesEl.appendChild(div);
    messagesEl.scrollTop = messagesEl.scrollHeight;
  }

  function setTokensLeft(n){
    currentUser.tokens = n;
    tokenCountEl.textContent = n;
  }

  function setUserEmail(email) {
    currentUser.email = email;
    userEmailEl.textContent = email;
  }

  // 1. Récupérer le solde initial
  async function fetchBalance(){
    try{
      const url = apiBase + "/api/balance?userId=" + encodeURIComponent(currentUser.id);
      const r = await fetch(url);
      const j = await r.json();
      if(j && typeof j.free === "number"){
        setTokensLeft(j.free);
      }
    }catch(e){
      console.log("balance err", e);
    }
  }

  // 2. Envoyer message à l'API
  async function sendToAI(){
    const msg = userInputEl.value.trim();
    if(!msg && !attachedImageData) return;
    if(currentUser.tokens <= 0){
      addMessage("assistant","Solde insuffisant. Merci d’acheter un pack 🔒");
      return;
    }

    addMessage("user", msg || "(photo)");
    userInputEl.value = "";

    try{
      const r = await fetch(apiBase + "/api/chat", {
        method:"POST",
        headers:{ "Content-Type":"application/json" },
        body:JSON.stringify({
          userId: currentUser.id,
          message: msg,
          imageDataUrl: attachedImageData
        })
      });
      const j = await r.json();
      if(j.error){
        addMessage("assistant","Erreur: " + j.error);
        return;
      }
      if(j.reply){
        addMessage("assistant", j.reply);
      }else{
        addMessage("assistant","(Pas de réponse)");
      }
      if(typeof j.remaining === "number"){
        setTokensLeft(j.remaining);
      }
    }catch(err){
      console.log(err);
      addMessage("assistant","Erreur réseau.");
    }finally{
      attachedImageData = null;
    }
  }

  // 3. photo -> base64 dans attachedImageData
  photoBtn.addEventListener("click", ()=>{
    photoFile.click();
  });
  photoFile.addEventListener("change", ()=>{
    const file = photoFile.files[0];
    if(!file) return;
    const reader = new FileReader();
    reader.onload = e=>{
      attachedImageData = e.target.result; // data:image/...
      addMessage("user","(photo ajoutée 📷)");
    };
    reader.readAsDataURL(file);
  });

  // 4. envoyer
  sendBtn.addEventListener("click", sendToAI);
  userInputEl.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){
      e.preventDefault();
      sendToAI();
    }
  });

  // 5. impression
  printBtn.addEventListener("click", ()=>{
    window.print();
  });

  // 6. modal réglages
  settingsBtn.addEventListener("click", ()=>{
    settingsModal.style.display = "flex";
  });
  closeSettingsBtn.addEventListener("click", ()=>{
    settingsModal.style.display = "none";
  });
  settingsModal.addEventListener("click",(e)=>{
    if(e.target===settingsModal){
      settingsModal.style.display="none";
    }
  });

  // theme switch
  settingsModal.querySelectorAll("[data-theme-choice]").forEach(el=>{
    el.addEventListener("click", ()=>{
      const choice = el.getAttribute("data-theme-choice");
      currentTheme = choice;
      document.documentElement.setAttribute("data-theme", choice);
    });
  });

  // langue switch (pour plus tard)
  settingsModal.querySelectorAll("[data-lang]").forEach(el=>{
    el.addEventListener("click", ()=>{
      currentLang = el.getAttribute("data-lang");
      // plus tard on pourra envoyer currentLang au backend
    });
  });

  // 7. (Plus tard) Clerk:
  // Ici on branchera Clerk pour récupérer le vrai userId + email.
  // Pour l’instant on garde "anonymous".
  // Quand Clerk sera prêt, on fera:
  // currentUser.id = clerkUser.id;
  // setUserEmail(clerkUser.email);

  // init
  fetchBalance();
  setUserEmail("email@example.com");

})();
</script>
</body>
</html>

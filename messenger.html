<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Philom√®ne IA ‚Äì Messenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <!-- Clerk -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>
  <style>
    :root{--bg:#071826;--panel:#0e2238;--muted:#9bb3c9;--accent:#3aa0ff;--danger:#ff4646}
    html,body{height:100%}
    body{margin:0;background:var(--bg);color:#fff;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
    .wrap{max-width:920px;margin:0 auto;padding:22px}
    h1{margin:6px 0 2px;font-size:28px;text-align:center}
    .topline{display:flex;flex-wrap:wrap;gap:10px;align-items:center;justify-content:center;color:var(--muted);margin-bottom:14px;font-size:14px}
    .badge{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;background:#0f2b47;border:1px solid #234c77;border-radius:999px}
    .tokens{font-weight:700;color:#fff}
    .logout{background:var(--danger);color:#fff;border:0;border-radius:10px;padding:8px 12px;cursor:pointer}
    .panel{background:var(--panel);border:1px solid #173a5c;border-radius:12px;padding:14px}
    .alert{margin:0 4px 10px;color:var(--muted);font-size:13px}
    .warn{margin:0 4px 10px;background:#432c00;border:1px solid #7a5600;color:#ffd888;padding:8px 10px;border-radius:8px;display:none}
    .chatbox{height:56vh;min-height:280px;overflow:auto;padding:12px;background:#0b1d31;border:1px solid #153150;border-radius:10px}
    .msg{max-width:88%;margin:8px 0;padding:10px 12px;border-radius:10px;line-height:1.35;font-size:15px;white-space:pre-wrap;word-wrap:break-word}
    .me{margin-left:auto;background:#133a6d;border:1px solid #2d65a2}
    .bot{background:#0f2b47;border:1px solid #2a527e}
    .row{display:flex;gap:10px;margin-top:10px;align-items:center}
    textarea{flex:1;height:54px;resize:none;background:#0b1d31;border:1px solid #173a5c;color:#fff;border-radius:10px;padding:12px;font-size:15px;outline:none}
    .send{background:var(--accent);color:#001427;border:0;border-radius:10px;padding:0 18px;font-weight:700;cursor:pointer;height:54px}
    .buy{background:#00c853;color:#021014;border:0;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;height:54px}
    .photo{background:#00bcd4;color:#021014;border:0;border-radius:10px;padding:0 14px;font-weight:700;cursor:pointer;height:54px}
    .foot{margin-top:10px;text-align:right;color:var(--muted);font-size:13px}
    .thin{font-weight:400;opacity:.9}
    .preview{font-size:12px;color:#beddff;opacity:.9;margin-top:6px}

    /* Modale offres */
    .modal{position:fixed;inset:0;background:#0009;display:none;align-items:center;justify-content:center;padding:20px}
    .card{background:#0b1d31;border:1px solid #173a5c;border-radius:12px;padding:16px;max-width:560px;width:100%}
    .grid{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:560px){.grid{grid-template-columns:repeat(3,1fr)}}
    .offer{background:#0f2b47;border:1px solid #2a527e;border-radius:10px;padding:12px}
    .offer h4{margin:4px 0 8px}
    .offer button{width:100%;margin-top:8px;background:#00c853;color:#021014;border:0;border-radius:10px;padding:10px;font-weight:700;cursor:pointer}
    .close{float:right;background:#223a57;border:0;color:#9bb3c9;border-radius:8px;padding:6px 10px;cursor:pointer}
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Philom√®ne IA ‚Äì Messenger</h1>

    <div class="topline">
      <span id="connectedAs" class="badge">Connexion‚Ä¶</span>
      <span class="badge tokens">Tokens : <span id="tokFree">0</span> / <span id="tokPaid">0</span></span>
      <button id="logout" class="logout">Se d√©connecter</button>
    </div>

    <div class="panel">
      <div id="alert" class="alert">Bonjour üëã Tape un message, ajoute une photo si besoin, et envoie.</div>
      <div id="lowWarn" class="warn">
        Il vous reste peu de tokens. Voulez-vous en ajouter ?
        <button id="openOffers" style="margin-left:8px">Voir les offres üîã</button>
      </div>

      <div id="chat" class="chatbox">
        <div class="msg bot">Bonjour ! Comment puis-je vous aider aujourd‚Äôhui ?</div>
      </div>

      <div class="row">
        <textarea id="input" placeholder="√âcris ton message‚Ä¶ (Entr√©e = envoyer)"></textarea>
        <button id="send" class="send">Envoyer</button>
        <button id="photoBtn" class="photo">üì∑ Photo</button>
        <button id="buy" class="buy">Acheter des tokens</button>
        <input id="file" type="file" accept="image/*" capture="environment" style="display:none" />
      </div>
      <div id="preview" class="preview"></div>
    </div>

    <div class="foot">
      Solde ‚Ä¢ Gratuit : <span id="fBalance">0</span> ‚Ä¢ Payant : <span id="pBalance">0</span>
      <span class="thin">‚Ä¢ Philom√®ne au service des gens</span>
    </div>
  </div>

  <!-- Modale Offres -->
  <div id="offers" class="modal" role="dialog" aria-modal="true">
    <div class="card">
      <button class="close" id="closeOffers">Fermer</button>
      <h3>Choisissez votre pack</h3>
      <p style="color:#9bb3c9;margin-top:4px">Paiement PayPal (bient√¥t). Pour l‚Äôinstant, ajout imm√©diat de tokens (d√©mo).</p>
      <div class="grid">
        <div class="offer">
          <h4>Pack Starter</h4>
          <div>70 000 tokens ‚Ä¢ 5 ‚Ç¨</div>
          <button data-amount="70000">Choisir</button>
        </div>
        <div class="offer">
          <h4>Pack Plus</h4>
          <div>150 000 tokens ‚Ä¢ 10 ‚Ç¨</div>
          <button data-amount="150000">Choisir</button>
        </div>
        <div class="offer">
          <h4>Pack Pro</h4>
          <div>320 000 tokens ‚Ä¢ 20 ‚Ç¨</div>
          <button data-amount="320000">Choisir</button>
        </div>
      </div>
      <p style="margin-top:10px;color:#9bb3c9">Promo lancement: <b>1er achat = tokens x2</b> (√† impl√©menter c√¥t√© serveur si besoin).</p>
    </div>
  </div>

  <script>
    const API_BASE = "https://api.philomeneia.com";
    const $ = (id) => document.getElementById(id);
    const chat = $("chat");

    function addMsg(text, cls) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }
    function setAlert(txt) { $("alert").textContent = txt; }
    function showLowWarn(show) { $("lowWarn").style.display = show ? "block" : "none"; }

    async function jsonFetch(url, options = {}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (e) {
        console.error(e);
        setAlert("‚ö†Ô∏è √âchec de chargement (" + (e.message || "erreur") + ")");
        return null;
      }
    }

    let email = "inconnu";
    let greetedKey = "";
    let pendingImages = []; // dataURL images

    window.addEventListener("load", async () => {
      await Clerk.load();
      if (!Clerk.user) { window.location.href = "/"; return; }
      email = Clerk.user.primaryEmailAddress?.emailAddress || "inconnu";
      $("connectedAs").textContent = "Connect√© ‚úÖ : " + email;
      greetedKey = "ph_greeted_" + email;

      $("logout").onclick = async () => { await Clerk.signOut(); window.location.href = "/"; };

      // Photo
      $("photoBtn").onclick = () => $("file").click();
      $("file").addEventListener("change", handleFile);

      // Offres
      $("buy").onclick = () => $("offers").style.display = "flex";
      $("openOffers").onclick = () => $("offers").style.display = "flex";
      $("closeOffers").onclick = () => $("offers").style.display = "none";
      document.querySelectorAll(".offer button").forEach(btn => {
        btn.addEventListener("click", async () => {
          const amt = Number(btn.dataset.amount || 0);
          if (!amt) return;
          const data = await jsonFetch(`${API_BASE}/api/topup_custom`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ email, amount: amt })
          });
          if (data?.ok) {
            setAlert(`+${amt} tokens ajout√©s ‚úÖ`);
            $("offers").style.display = "none";
            await refreshBalances();
          } else {
            setAlert("Impossible d‚Äôajouter des tokens pour le moment.");
          }
        });
      });

      await refreshBalances();
      setAlert("Pr√™t ‚úÖ");

      const input = $("input");
      const sendBtn = $("send");
      sendBtn.onclick = sendMessage;
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      async function sendMessage() {
        const text = input.value.trim();
        if (!text && pendingImages.length === 0) return;

        input.value = "";
        const label = text || (pendingImages.length ? "(Photo envoy√©e)" : "");
        addMsg(label, "me");

        sendBtn.disabled = true; const old = sendBtn.textContent; sendBtn.textContent = "‚Ä¶";

        const payload = {
          message: text,
          email,
          first: !localStorage.getItem(greetedKey),
          images: pendingImages
        };

        const data = await jsonFetch(`${API_BASE}/api/chat`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        pendingImages = [];
        $("preview").textContent = "";

        if (data?.reply) {
          addMsg(data.reply, "bot");
          if (payload.first) localStorage.setItem(greetedKey, "1");
          await refreshBalances();
        } else if (data?.error || !data) {
          if (data?.error === "Cr√©dits insuffisants") {
            addMsg("Vous avez utilis√© tous vos tokens. Ouvrez les offres pour recharger ‚ú®", "bot");
            showLowWarn(true);
          } else {
            addMsg("D√©sol√©, impossible d‚Äôobtenir une r√©ponse pour le moment.", "bot");
          }
        }

        sendBtn.disabled = false; sendBtn.textContent = old;
      }
    });

    async function refreshBalances() {
      const url = `${API_BASE}/api/balance?email=${encodeURIComponent(email)}`;
      const data = await jsonFetch(url);
      if (!data) return;
      const free = Number(data.free || 0), paid = Number(data.paid || 0), total = free + paid;
      $("tokFree").textContent = free; $("tokPaid").textContent = paid;
      $("fBalance").textContent = free; $("pBalance").textContent = paid;
      showLowWarn(total > 0 && total <= 200);
    }

    function handleFile(ev) {
      const file = ev.target.files && ev.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = () => {
        const dataUrl = reader.result;
        pendingImages.push(dataUrl);
        $("preview").textContent = `Image pr√™te √† √™tre envoy√©e (${pendingImages.length})`;
      };
      reader.readAsDataURL(file);
      ev.target.value = "";
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" style="background:#000;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhilomÃ¨ne I.A.</title>
  <meta name="color-scheme" content="dark" />

  <!-- Clerk front SDK -->
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.clerk.dev/clerk.js">
  </script>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header {
      background:#000;
      color:#ffd84f;
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:16px;
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      font-size:16px;
      font-weight:500;
      position:relative;
    }

    .left-head,
    .right-head{
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }

    .burger,
    .more {
      width:44px;
      height:44px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:10px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
    }

    .token-box {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:14px;
      line-height:1.2;
      color:#ffd84f;
      font-weight:600;
    }
    .token-value {
      display:flex;
      align-items:center;
      gap:8px;
      font-size:18px;
    }
    .token-diamond {
      font-size:20px;
    }
    #token-count-top {
      color:#ffd84f;
      font-feature-settings:"tnum";
    }
    .token-label {
      font-size:13px;
      color:#888;
      font-weight:400;
    }

    /* menu dÃ©roulant des 3 points */
    .menu-panel {
      position:absolute;
      top:60px;
      right:16px;
      width:260px;
      background:rgba(20,20,30,0.95);
      border:1px solid rgba(255,255,255,0.15);
      border-radius:12px;
      box-shadow:0 40px 120px rgba(0,0,0,0.9);
      padding:16px;
      display:none;
      flex-direction:column;
      gap:16px;
      color:#fff;
      z-index:1000;
    }
    .menu-section {
      background:rgba(40,40,60,0.4);
      border-radius:10px;
      padding:12px 16px;
      border:1px solid rgba(255,255,255,0.1);
    }
    .menu-title {
      font-size:16px;
      font-weight:600;
      margin-bottom:4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      color:#fff;
    }
    .menu-desc {
      font-size:14px;
      color:#aaa;
      line-height:1.3;
    }
    .menu-link {
      color:#fff;
      text-decoration:none;
      display:block;
    }

    /* popin connexion disabled / erreurs etc */
    .overlay-msg {
      position:fixed;
      left:0;right:0;
      bottom:0;
      padding:16px;
      display:none;
      z-index:2000;
    }
    .overlay-card {
      background:#2b2b2b;
      color:#fff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      padding:20px;
      font-size:17px;
      line-height:1.4;
    }
    .overlay-close {
      color:#4d7dff;
      font-weight:500;
      margin-top:12px;
      text-align:right;
      font-size:16px;
    }

    /* zone chat */
    .chat-wrapper {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:16px;
      overflow-y:auto;
      background:radial-gradient(circle at 20% 20%, rgba(80,0,255,0.18) 0%, rgba(0,0,0,0) 60%);
    }

    .bubble {
      max-width:90%;
      border-radius:12px;
      padding:16px;
      line-height:1.4;
      font-size:18px;
      box-shadow:0 30px 60px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.08);
      word-break:break-word;
      white-space:pre-line;
    }

    .assistant {
      align-self:flex-start;
      background:#2b2b2b;
      color:#fff;
    }
    .user {
      align-self:flex-end;
      background:radial-gradient(circle at 100% 0%, rgba(130,110,255,.6) 0%, rgba(20,10,60,0) 60%), #4c3bff;
      color:#fff;
      font-weight:500;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 40px rgba(100,60,255,0.6),0 30px 60px rgba(0,0,0,0.8);
    }
    .thinking {
      font-size:16px;
      color:#ddd;
      background:#2b2b2b;
    }

    /* input zone */
    .input-zone-wrapper {
      background:#000;
      border-top:1px solid rgba(255,255,255,0.08);
      padding:16px;
    }
    .input-row {
      display:flex;
      align-items:stretch;
      gap:12px;
      background:radial-gradient(circle at 0% 0%, rgba(130,110,255,.3) 0%, rgba(0,0,0,0) 60%);
    }
    .plus-btn,
    .send-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:28px;
      line-height:0;
      font-weight:500;
    }
    .send-btn {
      font-size:24px;
    }
    .text-input {
      flex:1;
      background:#0f0f1a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      font-size:18px;
      color:#fff;
      padding:16px;
      font-family:inherit;
      outline:none;
    }
    .status-line {
      text-align:center;
      margin-top:12px;
      font-size:15px;
      color:#999;
      font-weight:400;
    }
    .status-line strong {
      font-weight:600;
      color:#fff;
    }
    #token-count-bottom {
      color:#fff;
      font-feature-settings:"tnum";
    }
  </style>
</head>

<body>
  <!-- HEADER -->
  <header>
    <div class="left-head">
      <div class="burger">â˜°</div>
      <div class="token-box">
        <div class="token-value">
          <div class="token-diamond">ðŸ’Ž</div>
          <span id="token-count-top">5000</span>
          <span>tokens</span>
        </div>
        <div class="token-label">PhilomÃ¨ne I.A.</div>
      </div>
    </div>

    <div class="right-head">
      <div id="menu-btn" class="more">â‹¯</div>
    </div>

    <!-- menu cachÃ© par dÃ©faut -->
    <div id="menu-panel" class="menu-panel">
      <div class="menu-section" id="menu-auth-block">
        <div class="menu-title">
          <span id="auth-title">Connexion / Inscription</span>
        </div>
        <div class="menu-desc" id="auth-desc">CrÃ©er un compte ou se connecter</div>
      </div>

      <div class="menu-section">
        <div class="menu-title">
          Paiement (bientÃ´t)
        </div>
        <div class="menu-desc">
          Recharger ses tokens par PayPal
        </div>
      </div>
    </div>
  </header>

  <!-- ZONE MESSAGES -->
  <div id="chat-container" class="chat-wrapper"></div>

  <!-- BARRE ENVOI -->
  <div class="input-zone-wrapper">
    <div class="input-row">
      <div class="plus-btn">+</div>
      <input
        id="user-input"
        class="text-input"
        placeholder="Ã‰crivez votre message..."
      />
      <div id="send-btn" class="send-btn">âž¤</div>
    </div>

    <div class="status-line">
      PrÃªt â€¢
      <strong>
        <span id="token-count-bottom">5000</span>
        tokens
      </strong>
      restants
    </div>
  </div>

  <!-- POPUP D'ALERTE -->
  <div id="overlay" class="overlay-msg">
    <div class="overlay-card">
      <div id="overlay-text">Connexion indisponible pour le moment.</div>
      <div id="overlay-close" class="overlay-close">Fermer</div>
    </div>
  </div>

  <!-- LOGIQUE FRONT -->
  <script>
    // ========================
    // CONFIG
    // ========================
    const API_BASE = "https://philo-backend-su29.onrender.com"; // backend Render Node
    let tokenCount = 5000;

    // conversation locale en mÃ©moire du front
    // on met le system + message de bienvenue au premier chargement
    let conversation = [
      {
        role: "system",
        content:
          "Tu es PhilomÃ¨ne I.A., une assistante personnelle en franÃ§ais, avec un ton humain, calme et rassurant."
      },
      {
        role: "assistant",
        content:
          "ðŸ‘‹ Bonjour. Je suis PhilomÃ¨ne I.A., votre assistante personnelle.\n" +
          "Si vous avez un problÃ¨me, jâ€™ai la solution.\n" +
          "Vous avez une question, jâ€™ai la rÃ©ponse.\n" +
          "Ensemble, on ira plus loin ðŸ•Š"
      }
    ];

    // ========================
    // ELEMENTS DOM
    // ========================
    const chatContainer = document.getElementById("chat-container");
    const userInput     = document.getElementById("user-input");
    const sendBtn       = document.getElementById("send-btn");
    const tokenTop      = document.getElementById("token-count-top");
    const tokenBottom   = document.getElementById("token-count-bottom");

    const menuBtn       = document.getElementById("menu-btn");
    const menuPanel     = document.getElementById("menu-panel");

    const overlayEl     = document.getElementById("overlay");
    const overlayText   = document.getElementById("overlay-text");
    const overlayClose  = document.getElementById("overlay-close");

    const authTitleEl   = document.getElementById("auth-title");
    const authDescEl    = document.getElementById("auth-desc");

    // ========================
    // UI HELPERS
    // ========================
    function scrollToBottom() {
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addBubble(text, who) {
      const div = document.createElement("div");
      div.classList.add("bubble");

      if (who === "user") {
        div.classList.add("user");
      } else if (who === "thinking") {
        div.classList.add("assistant","thinking");
      } else {
        div.classList.add("assistant");
      }

      div.textContent = text || "";
      chatContainer.appendChild(div);
      scrollToBottom();
      return div;
    }

    function updateTokenDisplay() {
      tokenTop.textContent    = tokenCount;
      tokenBottom.textContent = tokenCount;
    }

    function showOverlay(msg) {
      overlayText.textContent = msg;
      overlayEl.style.display = "block";
    }
    function hideOverlay() {
      overlayEl.style.display = "none";
    }

    overlayClose.addEventListener("click", hideOverlay);

    // ========================
    // CLERK AUTH
    // ========================
    let currentUserId = null; // on va stocker ici l'id Clerk une fois connectÃ©

    // Cette fonction demande Ã  Clerk s'il y a un user connectÃ©
    async function syncAuthFromClerk() {
      // window.Clerk est injectÃ© par le script Clerk
      if (!window.Clerk) return;

      await window.Clerk.load(); // charge Clerk
      const user = window.Clerk.user; // null si pas connectÃ©

      if (user) {
        currentUserId = user.id;
        authTitleEl.textContent = "ConnectÃ© âœ…";
        authDescEl.textContent  = "ID: " + currentUserId;
      } else {
        currentUserId = null;
        authTitleEl.textContent = "Connexion / Inscription";
        authDescEl.textContent  = "CrÃ©er un compte ou se connecter";
      }
    }

    // Ouvrir modal Clerk
    async function openClerkSignIn() {
      if (!window.Clerk) {
        showOverlay("Connexion indisponible pour le moment.");
        return;
      }
      await window.Clerk.load();

      // si dÃ©jÃ  connectÃ© => rien
      if (window.Clerk.user) {
        showOverlay("Vous Ãªtes dÃ©jÃ  connectÃ©.");
        return;
      }

      // ouvre la modale Clerk intÃ©grÃ©e
      window.Clerk.openSignIn();
    }

    // menu: cliquer sur la zone auth
    document.getElementById("menu-auth-block").addEventListener("click", () => {
      openClerkSignIn();
    });

    // bouton â€¦ pour afficher / cacher le menu
    menuBtn.addEventListener("click", () => {
      menuPanel.style.display = (menuPanel.style.display === "flex") ? "none" : "flex";
    });

    // ========================
    // HISTORIQUE POUR USER CONNECTÃ‰
    // ========================
    async function loadConversationForUser() {
      // si pas connectÃ© -> on garde juste la conversation de base
      if (!currentUserId) {
        renderInitialIfEmpty();
        updateTokenDisplay();
        return;
      }

      // si connectÃ© -> demander l'historique au backend
      try {
        const resp = await fetch(`${API_BASE}/history?userId=${encodeURIComponent(currentUserId)}`);
        if (!resp.ok) throw new Error("history status " + resp.status);
        const data = await resp.json();

        // data.messages devrait Ãªtre un array [{role, content}, ...]
        if (Array.isArray(data.messages) && data.messages.length > 0) {
          conversation = data.messages.slice(); // on remplace la conv locale
          chatContainer.innerHTML = "";
          for (const msg of conversation) {
            if (msg.role === "user") {
              addBubble(msg.content, "user");
            } else {
              addBubble(msg.content, "assistant");
            }
          }
        } else {
          renderInitialIfEmpty();
        }
      } catch (err) {
        console.error("loadConversationForUser error:", err);
        renderInitialIfEmpty();
      }

      updateTokenDisplay();
    }

    function renderInitialIfEmpty() {
      // efface tout
      chatContainer.innerHTML = "";
      // affiche le message de bienvenue (assistant)
      addBubble(conversation[1].content, "assistant");
    }

    // ========================
    // ENVOI MESSAGE
    // ========================
    async function askPhilomene() {
      const text = userInput.value.trim();
      if (!text) return;

      // affiche user
      addBubble(text, "user");

      // push cÃ´tÃ© front
      conversation.push({ role:"user", content:text });

      // clear champ
      userInput.value = "";

      // bulle thinking
      const thinkingBubble = addBubble(
        "PhilomÃ¨ne rÃ©flÃ©chit Ã  votre message...",
        "thinking"
      );

      try {
        const resp = await fetch(`${API_BASE}/ask`, {
          method: "POST",
          headers: { "Content-Type":"application/json" },
          body: JSON.stringify({
            userId: currentUserId,        // null si pas co
            conversation: conversation    // tout l'historique local
          })
        });

        if (!resp.ok) throw new Error("resp not ok " + resp.status);
        const data = await resp.json();

        const answer = data.answer || "â€¦";

        // remplace thinking par vraie rÃ©ponse
        thinkingBubble.remove();
        addBubble(answer,"assistant");

        // stocke rÃ©ponse dans conv locale
        conversation.push({ role:"assistant", content:answer });

        // dÃ©crÃ©mente tokens cÃ´tÃ© front (fake pour l'instant)
        tokenCount = Math.max(0, tokenCount - 20);
        updateTokenDisplay();

      } catch (err) {
        console.error("askPhilomene error:", err);
        thinkingBubble.textContent = "DÃ©solÃ©e, j'ai eu un problÃ¨me rÃ©seau.";
        thinkingBubble.classList.remove("thinking");
      }
    }

    sendBtn.addEventListener("click", askPhilomene);
    userInput.addEventListener("keydown", e => {
      if (e.key === "Enter") {
        e.preventDefault();
        askPhilomene();
      }
    });

    // ========================
    // BOOT
    // ========================
    async function boot() {
      await syncAuthFromClerk();
      await loadConversationForUser();
    }

    // lancer aprÃ¨s petit dÃ©lai pour Ãªtre sÃ»r que Clerk a chargÃ©
    window.addEventListener("load", () => {
      setTimeout(boot, 300);
    });
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Philom√®ne I.A.</title>
<style>
/* ===== Th√®me (sombre par d√©faut) ===== */
:root{--bg:#0b0b0f;--fg:#eceaf6;--muted:#bfb5ff;--card:#12101b;--card2:#161225;--line:#2a1d38;--vio:#51307a;--vio2:#5a3d8f}
body{margin:0;background:var(--bg);color:var(--fg);font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
.light{--bg:#f5f6fb;--fg:#1f2230;--muted:#4a3e7b;--card:#ffffff;--card2:#ffffff;--line:#e7e7ee;--vio:#b79cf2;--vio2:#a68ae7}
button{font:inherit}

/* ===== Topbar ===== */
.topbar{position:sticky;top:0;z-index:10;background:#0c0c10;padding:10px 14px 6px;border-bottom:1px solid var(--line)}
.light .topbar{background:#fff}
.topbar .row{display:flex;align-items:center;gap:10px}
.topbar .left,.topbar .right{display:flex;gap:10px;align-items:center}
.topbar .right{margin-left:auto}
.pill{background:#1c1427;border:1px solid var(--vio);color:#d8c9ff;border-radius:12px;padding:8px 14px;font-weight:600}
.light .pill{background:#f3f0ff;color:#3a2b77;border-color:#cbb6ff}
.pill:active{transform:scale(.98)}
.burger{background:#1c1427;border:1px solid var(--vio);color:#d8c9ff;border-radius:10px;padding:8px 12px;font-weight:700}
.light .burger{background:#f3f0ff;color:#3a2b77;border-color:#cbb6ff}

.token-badge{display:flex;align-items:center;gap:8px;background:var(--card2);border:1px solid var(--vio2);border-radius:14px;padding:6px 10px}
.token-badge .gem{filter:drop-shadow(0 0 6px #6cf)}
#tokenCount{font-variant-numeric:tabular-nums;font-weight:800;color:#a98cff}
.light #tokenCount{color:#6b55c8}

/* Sous-ligne titre/version */
.subtitle{display:flex;align-items:center;gap:8px;margin-top:8px;color:var(--muted);font-weight:600}
.dot{width:10px;height:10px;border-radius:50%}
.online{background:#7dff9c;box-shadow:0 0 8px #7dff9c}

/* Menu d√©roulant */
.menu-panel{position:absolute;right:12px;top:58px;background:#14111e;border:1px solid var(--vio);border-radius:12px;box-shadow:0 12px 30px rgba(0,0,0,.45);overflow:hidden;min-width:220px}
.light .menu-panel{background:#fff}
.menu-item{display:block;width:100%;text-align:left;padding:10px 14px;color:#e8e1ff;background:transparent;border:none}
.light .menu-item{color:#2a234e}
.menu-item:hover{background:#1c1730}
.light .menu-item:hover{background:#f2ecff}

/* ===== Chat ===== */
#chat{padding:14px;display:flex;flex-direction:column;gap:12px;max-width:900px;margin:0 auto}
.bubble{max-width:92%;padding:12px 14px;border-radius:14px;background:var(--card)}
.bubble.bot{border:1px solid var(--vio)}
.bubble.user{margin-left:auto;background:#1b1630;border:1px solid #6341a4}
.light .bubble{background:#fff;border:1px solid #e9e6ff}
.light .bubble.user{background:#efeaff;border-color:#d6c8ff}

/* ===== Composer ===== */
.composer-wrap{position:sticky;bottom:0;background:linear-gradient(0deg,rgba(0,0,0,.6),transparent 60%);padding:10px 10px 16px}
.composer{max-width:900px;margin:0 auto;display:flex;gap:10px;align-items:center}
.plus{width:44px;height:44px;border-radius:12px;background:#1c1427;border:1px solid var(--vio);color:#d8c9ff}
.light .plus{background:#f3f0ff;color:#3a2b77;border-color:#cbb6ff}
.input-box{flex:1;position:relative}
#userInput{width:100%;padding:12px 88px 12px 12px;border-radius:12px;border:1px solid var(--vio);background:var(--card);color:var(--fg)}
.mic-in{position:absolute;right:48px;top:50%;transform:translateY(-50%);background:transparent;border:none;opacity:.9}
.send{width:44px;height:44px;border-radius:12px;background:#6b41ff;color:white;border:none;font-weight:800}

/* Action sheet (plus) */
.sheet-bg{position:fixed;inset:0;background:rgba(5,5,10,.6);backdrop-filter:blur(4px);display:flex;align-items:flex-end;justify-content:center;z-index:15}
.sheet{width:100%;max-width:900px;background:#0f0c18;border-top-left-radius:16px;border-top-right-radius:16px;border-top:1px solid var(--vio);padding:10px}
.sheet .row{display:flex;gap:10px}
.sheet .opt{flex:1;background:#151228;border:1px solid var(--vio2);color:#e9e3ff;border-radius:12px;padding:12px}

/* FAQ */
.faq-backdrop{position:fixed;inset:0;background:rgba(5,5,10,.6);backdrop-filter:blur(6px);display:flex;align-items:center;justify-content:center;z-index:20}
.faq-card{max-width:640px;width:92%;background:#0f0c18;color:#f2edff;border-radius:18px;padding:18px 18px 12px;position:relative;
  box-shadow:0 0 0 3px #3b1f5f, 0 0 32px 6px rgba(135,16,255,.35)}
.faq-card h2{margin:2px 0 10px;font-size:22px;color:#cbb6ff}
.faq-section{margin:12px 0}
.faq-pack{display:flex;align-items:center;gap:10px;background:#151228;border:1px solid #5a3d8f;border-radius:12px;padding:10px 12px;margin:8px 0}
.faq-close{position:absolute;right:14px;top:10px;background:transparent;border:none;color:#cbb6ff;font-size:16px}

/* Utils */
.hidden{display:none}
</style>
</head>
<body>
  <header class="topbar">
    <div class="row">
      <div class="left">
        <button id="btnLogin" class="pill">Connexion</button>
        <button id="btnBuy" class="pill">Acheter</button>
      </div>
      <div class="right">
        <div class="token-badge" id="tokenBadge">
          <span class="gem">üíé</span><span id="tokenCount">1 000 000</span>
        </div>
        <button id="btnMenu" class="burger" aria-label="Menu">‚â°</button>
      </div>
    </div>
    <div class="subtitle">
      <span class="dot online"></span>
      <span>Philom√®ne I.A. ‚Äî <strong>version 1.0</strong></span>
    </div>
    <div id="menuPanel" class="menu-panel" hidden>
      <button id="toggleMode" class="menu-item">üåó Mode jour / nuit</button>
      <button id="openFaq" class="menu-item">‚ùì F.A.Q.</button>
    </div>
  </header>

  <main id="chat">
    <div class="bubble bot">Bonjour üëã Je suis Philom√®ne I.A., propuls√©e par GPT-5 Thinking.</div>
  </main>

  <div class="composer-wrap">
    <div class="composer">
      <button id="plusBtn" class="plus">+</button>
      <div class="input-box">
        <input id="userInput" type="text" placeholder="√âcrivez votre message..." autocomplete="off">
        <button id="micBtn" class="mic-in" title="Dicter">üé§</button>
      </div>
      <button id="sendBtn" class="send">‚û§</button>
    </div>
  </div>

  <!-- Inputs invisibles pour fichiers -->
  <input id="imgLibInput" type="file" accept="image/*" class="hidden">
  <input id="imgCamInput" type="file" accept="image/*" capture="environment" class="hidden">
  <input id="docInput" type="file" class="hidden">

<script>
/* ================== CONFIG ================== */
const API_URL = "https://api.philomeneia.com/ask"; // Texte
const API_IMG = "https://api.philomeneia.com/vision"; // Images/Docs (√† adapter c√¥t√© backend)
let tokenCount = 1_000_000;

/* ================== S√©lecteurs ================== */
const chat = document.getElementById('chat');
const userInput = document.getElementById('userInput');
const sendBtn = document.getElementById('sendBtn');
const plusBtn = document.getElementById('plusBtn');
const micBtn = document.getElementById('micBtn');
const tokenCountEl = document.getElementById('tokenCount');
const btnMenu = document.getElementById('btnMenu');
const menuPanel = document.getElementById('menuPanel');
const toggleMode = document.getElementById('toggleMode');
const openFaq = document.getElementById('openFaq');
const btnLogin = document.getElementById('btnLogin');
const btnBuy = document.getElementById('btnBuy');
const imgLibInput = document.getElementById('imgLibInput');
const imgCamInput = document.getElementById('imgCamInput');
const docInput = document.getElementById('docInput');

/* ============ Th√®me: sombre par d√©faut ============ */
(() => {
  const saved = localStorage.getItem('theme');
  if(saved === 'light') document.body.classList.add('light');
})();
toggleMode.addEventListener('click', ()=>{
  document.body.classList.toggle('light');
  localStorage.setItem('theme', document.body.classList.contains('light')?'light':'dark');
  menuPanel.setAttribute('hidden','');
});

/* ================== Menu ================== */
btnMenu.addEventListener('click', ()=>{
  const hidden = menuPanel.hasAttribute('hidden');
  document.querySelectorAll('.menu-panel').forEach(p=>p.setAttribute('hidden',''));
  if(hidden) menuPanel.removeAttribute('hidden'); else menuPanel.setAttribute('hidden','');
});
document.addEventListener('click', (e)=>{
  if(!menuPanel.contains(e.target) && e.target!==btnMenu) menuPanel.setAttribute('hidden','');
});

/* ================== Helpers UI ================== */
function addBubble(text, who='bot'){
  const b = document.createElement('div');
  b.className = 'bubble ' + (who==='user'?'user':'bot');
  b.textContent = text;
  chat.appendChild(b);
  chat.scrollTop = chat.scrollHeight;
}
function setTyping(on){
  if(on){ addBubble('‚Ä¶', 'bot'); }
  else{
    const last = chat.lastElementChild;
    if(last && last.textContent==='‚Ä¶') last.remove();
  }
}
function updateTokenDisplay(){
  tokenCountEl.textContent = tokenCount.toLocaleString('fr-FR');
}
window.updateTokensUI = (n)=>{ tokenCount = Number(n)||tokenCount; updateTokenDisplay(); };

/* ================== Placeholders Connexion/Achat ================== */
btnLogin.addEventListener('click', ()=>alert('Connexion : lier ton compte (placeholder).'));
btnBuy.addEventListener('click', ()=>alert('Acheter des tokens : 1M=5‚Ç¨ ‚Ä¢ 2M=10‚Ç¨ ‚Ä¢ 4M=20‚Ç¨ (+50% au 1er achat).'));

/* ================== FAQ Popup ================== */
function showFAQ(){
  const wrap = document.createElement('div');
  wrap.className='faq-backdrop';
  wrap.innerHTML=`
  <div class="faq-card">
    <button class="faq-close" aria-label="Fermer">Fermer ‚úñ</button>
    <h2>Foire aux questions</h2>
    <div class="faq-section">
      <strong>Quelle IA utilise Philom√®ne ?</strong>
      <p>Philom√®ne I.A. est propuls√©e par <b>GPT-5 Thinking</b>, la version la plus avanc√©e d‚ÄôOpenAI.</p>
    </div>
    <div class="faq-section">
      <strong>Comment fonctionnent les tokens ?</strong>
      <p>Chaque question + r√©ponse consomme un petit nombre de tokens selon la longueur. Le diamant üíé affiche votre solde.</p>
    </div>
    <div class="faq-section">
      <strong>Packs disponibles</strong>
      <div class="faq-pack">üíé 1 000 000 tokens ‚Üí 5 ‚Ç¨</div>
      <div class="faq-pack">üíé 2 000 000 tokens ‚Üí 10 ‚Ç¨</div>
      <div class="faq-pack">üíé 4 000 000 tokens ‚Üí 20 ‚Ç¨</div>
      <div class="faq-pack" style="justify-content:center;font-weight:700;">üéÅ Premier achat : +50% au 1er achat</div>
    </div>
    <div class="faq-section">
      <strong>Abonnement ?</strong>
      <p>Non. Toute la puissance de GPT-5, sans abonnement : vous payez uniquement ce que vous consommez.</p>
    </div>
    <div class="faq-section">
      <strong>Confidentialit√©</strong>
      <p>Vos √©changes restent priv√©s.</p>
    </div>
  </div>`;
  document.body.appendChild(wrap);
  wrap.querySelector('.faq-close').addEventListener('click', ()=>wrap.remove());
  wrap.addEventListener('click', (e)=>{ if(e.target===wrap) wrap.remove(); });
}
openFaq.addEventListener('click', ()=>{ showFAQ(); menuPanel.setAttribute('hidden',''); });

/* ================== Action Sheet (+) ================== */
let sheetBg=null;
function openSheet(){
  if(sheetBg) return;
  sheetBg = document.createElement('div');
  sheetBg.className='sheet-bg';
  sheetBg.innerHTML=`
    <div class="sheet">
      <div class="row">
        <button class="opt" id="pickPhoto">üì∑ Phototh√®que</button>
        <button class="opt" id="takePhoto">üì∏ Prendre une photo</button>
        <button class="opt" id="pickFile">üìÑ Choisir un fichier</button>
      </div>
    </div>`;
  document.body.appendChild(sheetBg);
  sheetBg.addEventListener('click', e=>{ if(e.target===sheetBg){closeSheet();} });

  document.getElementById('pickPhoto').onclick = ()=>{ imgLibInput.click(); closeSheet(); };
  document.getElementById('takePhoto').onclick = ()=>{ imgCamInput.click(); closeSheet(); };
  document.getElementById('pickFile').onclick  = ()=>{ docInput.click(); closeSheet(); };
}
function closeSheet(){ if(sheetBg){ sheetBg.remove(); sheetBg=null; } }
plusBtn.addEventListener('click', openSheet);

/* ================== Micro (speech-to-text) ================== */
let recognition=null;
if('webkitSpeechRecognition' in window){
  recognition = new webkitSpeechRecognition();
  recognition.lang = 'fr-FR'; recognition.interimResults=false;
  recognition.onresult = (e)=>{ const t = e.results[0][0].transcript; userInput.value = (userInput.value?userInput.value+' ':'') + t; };
}
micBtn.addEventListener('click', ()=>{
  if(recognition){ recognition.start(); } else { alert("Micro non support√© sur ce navigateur."); }
});

/* ================== Envoi Texte ================== */
async function sendMessage(){
  const text = userInput.value.trim();
  if(!text) return;
  addBubble(text,'user');
  userInput.value='';
  setTyping(true);

  try{
    const r = await fetch(API_URL, {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({message:text, userId:'guest_'+Math.random().toString(36).slice(2)})
    });
    const data = await r.json().catch(()=>({answer:"D√©sol√©, r√©ponse illisible."}));
    setTyping(false);
    addBubble(data.answer || "Une r√©ponse est arriv√©e, mais sans contenu.", 'bot');

    // D√©compte estimatif
    const est = Math.ceil((text.length + (data.answer?data.answer.length:80))/4);
    tokenCount = Math.max(0, tokenCount - est);
    updateTokenDisplay();
  }catch(err){
    setTyping(false);
    addBubble("Erreur r√©seau. R√©essaie.", 'bot');
  }
}
sendBtn.addEventListener('click', sendMessage);
userInput.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); sendMessage(); }});

/* ================== Upload Image / Doc ================== */
async function handleUpload(file){
  if(!file) return;
  addBubble("Fichier re√ßu, j'analyse‚Ä¶",'bot');
  try{
    const form = new FormData();
    form.append('file', file);
    form.append('userId','guest_'+Math.random().toString(36).slice(2));
    const r = await fetch(API_IMG,{method:'POST',body:form});
    const data = await r.json().catch(()=>({answer:"Fichier re√ßu."}));
    // Retire la bulle "j'analyse‚Ä¶" (derni√®re si c'est elle)
    const last = chat.lastElementChild; if(last && last.textContent.startsWith("Fichier re√ßu")) last.remove();
    addBubble(data.answer || "Fichier trait√©.", 'bot');

    const est = Math.ceil((data.answer?data.answer.length:200)/4);
    tokenCount = Math.max(0, tokenCount - est);
    updateTokenDisplay();
  }catch(e){
    addBubble("Erreur lors de l'envoi du fichier.",'bot');
  }
}
imgLibInput.addEventListener('change', ()=> handleUpload(imgLibInput.files?.[0]));
imgCamInput.addEventListener('change', ()=> handleUpload(imgCamInput.files?.[0]));
docInput.addEventListener('change', ()=> handleUpload(docInput.files?.[0]));

/* ================== Init ================== */
updateTokenDisplay();
</script>
</body>
</html>

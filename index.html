<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PhilomÃ¨ne IA Messenger â€“ GPT-4 Turbo</title>

  <style>
    :root {
      --bg:#071826;
      --panel:#0e2238;
      --panel-border:#173a5c;
      --bubble-user-bg:#133a6d;
      --bubble-user-border:#2d65a2;
      --bubble-bot-bg:#0f2b47;
      --bubble-bot-border:#2a527e;
      --text-muted:#9bb3c9;
      --accent:#1478FF;
      --danger:#ff4646;
      --radius:12px;
      --radius-sm:8px;
    }

    * { box-sizing:border-box; -webkit-tap-highlight-color:rgba(0,0,0,0); }

    body {
      margin:0;
      background:var(--bg);
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,system-ui,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    header {
      background:#0b1d31;
      border-bottom:1px solid var(--panel-border);
      padding:12px 16px;
      display:flex;
      flex-wrap:wrap;
      align-items:flex-start;
      justify-content:space-between;
      row-gap:8px;
    }

    .id-block { display:flex; flex-direction:column; font-size:13px; line-height:1.4; }
    .id-line { display:flex; align-items:center; gap:6px; flex-wrap:wrap; font-weight:500; }
    .badge { background:#0f2b47; border:1px solid #234c77; border-radius:999px; padding:2px 8px; font-size:12px; font-weight:500; color:#fff; }
    .tokens-line { font-size:12px; color:var(--text-muted); }
    .actions-line { display:flex; gap:8px; }
    button.header-btn {
      background:#2b2b2b; color:#fff; border:1px solid #3a3a3a;
      border-radius:var(--radius-sm); font-size:13px; font-weight:500;
      padding:8px 10px; line-height:1.2; cursor:pointer;
    }
    button.header-btn.danger { background:var(--danger); border:1px solid var(--danger); color:#fff; }

    main {
      flex:1; display:flex; flex-direction:column; padding:16px;
      max-width:900px; width:100%; margin:0 auto;
    }

    .chat-card {
      background:var(--panel); border:1px solid var(--panel-border);
      border-radius:var(--radius); display:flex; flex-direction:column;
      min-height:60vh; max-height:80vh;
    }

    #introBlock {
      border-bottom:1px solid var(--panel-border);
      padding:16px; font-size:14px; line-height:1.4; color:var(--text-muted);
    }
    #introBlock h1 { margin:0 0 6px; font-size:16px; color:#fff; font-weight:600; }
    #introBlock .offer {
      margin-top:12px; background:rgba(255,255,255,0.06);
      border:1px solid #234c77; border-radius:var(--radius-sm);
      padding:10px 12px; font-size:13px; color:#fff;
    }

    .chat-scroll { flex:1; overflow-y:auto; padding:16px; background:#0b1d31; border-bottom:1px solid var(--panel-border); -webkit-overflow-scrolling:touch; }
    .msg {
      max-width:85%; padding:10px 12px; border-radius:10px;
      line-height:1.4; font-size:15px; word-wrap:break-word; white-space:pre-wrap;
      margin-bottom:10px;
    }
    .msg.bot { background:var(--bubble-bot-bg); border:1px solid var(--bubble-bot-border); margin-right:auto; }
    .msg.me { background:var(--bubble-user-bg); border:1px solid var(--bubble-user-border); margin-left:auto; }

    .send-row {
      display:flex; align-items:flex-start; gap:8px; padding:12px;
      background:#0e2238; border-radius:0 0 var(--radius) var(--radius);
    }
    .file-btn {
      background:#2b2b2b; color:#fff; border:1px solid #3a3a3a;
      border-radius:var(--radius-sm); padding:10px; font-size:14px;
      font-weight:500; cursor:pointer; flex-shrink:0;
    }
    textarea#userInput {
      flex:1; background:#0b1d31; border:1px solid var(--panel-border);
      border-radius:var(--radius-sm); color:#fff; font-size:15px;
      line-height:1.4; padding:10px 12px; resize:none; outline:none;
      min-height:46px; max-height:120px;
    }
    button#sendBtn {
      background:var(--accent); border:0; border-radius:var(--radius-sm);
      color:#001427; font-size:15px; font-weight:600; padding:12px 14px;
      line-height:1.2; flex-shrink:0; cursor:pointer;
    }

    .footer-balance { text-align:right; font-size:12px; color:var(--text-muted); margin-top:10px; }

    #settingsPanel {
      position:fixed; left:0; right:0; bottom:0; background:#0e2238;
      border-top:1px solid var(--panel-border); border-radius:16px 16px 0 0;
      padding:16px; box-shadow:0 -20px 40px rgba(0,0,0,0.6);
      font-size:14px; color:#fff; display:none;
    }
    #settingsPanel h2 { font-size:16px; margin:0 0 12px; font-weight:600; }
    .closeSettingsBtn, .loginBtn, .dangerBtn {
      border-radius:var(--radius-sm); font-size:14px; font-weight:600;
      padding:8px 10px; line-height:1.2; cursor:pointer; margin-right:8px;
    }
    .closeSettingsBtn { background:#2b2b2b; color:#fff; border:1px solid #3a3a3a; }
    .loginBtn { background:#1478FF; color:#001427; border:0; }
    .dangerBtn { background:var(--danger); color:#fff; border:0; }
  </style>
</head>

<body>
  <header>
    <div class="id-block">
      <div class="id-line">
        <span class="badge" id="userStatus">InvitÃ© ðŸ‘¤</span>
        <span class="badge" id="tokenLeft">Tokens: 0</span>
      </div>
      <div class="tokens-line" id="userEmail">Non connectÃ©</div>
    </div>
    <div class="actions-line">
      <button class="header-btn" id="openSettingsBtn">RÃ©glages</button>
      <button class="header-btn danger" id="clearBtn">Vider chat</button>
    </div>
  </header>

  <main>
    <div class="chat-card">
      <div id="introBlock">
        <h1>PhilomÃ¨ne IA â€“ Assistant personnel</h1>
        Je peux tâ€™aider pour tes devoirs, Ã©crire un mail pro, corriger un texte,
        cuisiner avec ce que tu as dans ton frigo, traduire, expliquer une panne,
        prÃ©parer un CV, tâ€™expliquer une facture, tout Ã§a calmement Ã©tape par Ã©tape.
        <div class="offer">
          â€¢ Mode invitÃ©: tu testes gratuitement.<br/>
          â€¢ Mode inscrit (e-mail vÃ©rifiÃ©): plus de jetons et historique sauvegardÃ©.<br/><br/>
          Important: pour lâ€™actualitÃ© politique / info du jour, je peux parfois ne pas avoir les derniÃ¨res mises Ã  jour.
        </div>
      </div>

      <div class="chat-scroll" id="chatBox"></div>

      <div class="send-row">
        <button class="file-btn" id="photoBtn">ðŸ“·</button>
        <textarea id="userInput" placeholder="Ã‰cris ton messageâ€¦ (EntrÃ©e = envoyer)"></textarea>
        <button id="sendBtn">Envoyer</button>
      </div>
    </div>

    <div class="footer-balance" id="balanceLine">Solde: 0 tokens restants</div>
  </main>

  <div id="settingsPanel">
    <h2>RÃ©glages</h2>
    <div>
      <button class="loginBtn" id="loginBtn">CrÃ©er un compte / Se connecter</button>
      <button class="closeSettingsBtn" id="closeSettingsBtn">Fermer</button>
      <button class="dangerBtn" id="printBtn">Imprimer</button>
    </div>
  </div>

  <script>
    const apiBase = "https://api.philomeneia.com";

    let currentUser = null;
    const chatBoxEl = document.getElementById("chatBox");
    const userInputEl = document.getElementById("userInput");
    const sendBtnEl = document.getElementById("sendBtn");
    const introBlockEl = document.getElementById("introBlock");
    const tokenLeftEl = document.getElementById("tokenLeft");
    const userStatusEl = document.getElementById("userStatus");
    const balanceLineEl = document.getElementById("balanceLine");

    function addMessage(who, text){
      const bubble = document.createElement("div");
      bubble.className = "msg " + (who==="user"?"me":"bot");
      bubble.textContent = text;
      chatBoxEl.appendChild(bubble);
      chatBoxEl.scrollTop = chatBoxEl.scrollHeight;
    }

    function hideIntro(){ if(introBlockEl) introBlockEl.style.display="none"; }

    function refreshHeader(){
      if(!currentUser) return;
      tokenLeftEl.textContent = "Tokens: " + currentUser.tokens;
      balanceLineEl.textContent = "Solde: " + currentUser.tokens + " tokens restants";
    }

    async function sendToAI(){
      const msg = userInputEl.value.trim();
      if(!msg) return;
      if(currentUser.tokens<=0){ addMessage("bot","Plus de tokens ðŸ˜…"); return; }
      hideIntro(); addMessage("user", msg); userInputEl.value="";
      sendBtnEl.disabled=true; sendBtnEl.textContent="...";
      try{
        const r = await fetch(apiBase+"/api/chat",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({userId:currentUser.id,message:msg})});
        const j = await r.json();
        addMessage("bot", j.reply || "Pas de rÃ©ponse");
        if(j.remaining!==undefined){ currentUser.tokens=j.remaining; refreshHeader(); }
      }catch{ addMessage("bot","Erreur rÃ©seau."); }
      sendBtnEl.disabled=false; sendBtnEl.textContent="Envoyer";
    }

    userInputEl.addEventListener("keydown",e=>{
      if(e.key==="Enter"&&!e.shiftKey){e.preventDefault();sendToAI();}
    });
    sendBtnEl.addEventListener("click",sendToAI);

    async function initGuest(){
      try{
        const r=await fetch(apiBase+"/api/guest-start",{method:"POST"});
        const j=await r.json();
        currentUser={id:j.userId,tokens:j.tokens};
        refreshHeader();
        addMessage("bot","Bienvenue ðŸ‘‹ Tu as "+currentUser.tokens+" tokens gratuits.");
      }catch{ addMessage("bot","Erreur de connexion au serveur."); }
    }
    initGuest();
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr" style="background:#000;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Philom√®ne I.A.</title>
  <meta name="color-scheme" content="dark" />

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* HEADER */
    header {
      background:#000;
      color:#ffd84f;
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:16px;
      font-weight:500;
      position:relative;
      z-index:30;
    }
    .left-head,
    .right-head{
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }
    .burger{
      width:40px;
      height:40px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
    }
    .more{
      width:40px;
      height:40px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
      position:relative;
    }

    .token-box {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:14px;
      line-height:1.2;
      color:#ffd84f;
      font-weight:600;
    }
    .token-value {
      display:flex;
      align-items:center;
      gap:8px;
    }
    .token-value span#token-count-top{
      color:#ffd84f;
      font-feature-settings:"tnum";
    }
    .token-label {
      font-size:12px;
      color:#888;
      font-weight:400;
    }

    /* MENU DEROULANT (‚ãØ) */
    .menu-panel{
      position:absolute;
      top:52px;
      right:0;
      background:#1a1a1a;
      border:1px solid rgba(255,255,255,0.15);
      border-radius:10px;
      min-width:260px;
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      padding:12px 0;
      display:none; /* cach√© par d√©faut */
      z-index:999;
    }
    .menu-item{
      padding:14px 16px;
      border-bottom:1px solid rgba(255,255,255,0.07);
      color:#fff;
      font-size:16px;
      line-height:1.4;
    }
    .menu-item:last-child{
      border-bottom:none;
    }
    .menu-title{
      font-weight:600;
      color:#fff;
    }
    .menu-desc{
      font-size:14px;
      color:#9a9a9a;
      margin-top:4px;
    }
    .menu-item.disabled .menu-title{
      color:#777;
    }
    .menu-item.disabled .menu-desc{
      color:#555;
    }

    /* CONTENU CHAT */
    .chat-wrapper {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:16px;
      overflow-y:auto;
      background:radial-gradient(circle at 20% 20%, rgba(80,0,255,0.18) 0%, rgba(0,0,0,0) 60%);
    }

    .bubble {
      max-width:90%;
      border-radius:12px;
      padding:16px;
      line-height:1.4;
      font-size:18px;
      box-shadow:0 30px 60px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.08);
      white-space:pre-wrap;
    }

    /* bulle assistante */
    .bubble.assistant {
      align-self:flex-start;
      background:#2b2b2b;
      color:#fff;
    }

    /* bulle utilisateur */
    .bubble.user {
      align-self:flex-end;
      background:#4c3bff;
      background:radial-gradient(circle at 100% 0%, rgba(130,110,255,.6) 0%, rgba(20,10,60,0) 60%), #4c3bff;
      color:#fff;
      font-weight:500;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 40px rgba(100,60,255,0.6),0 30px 60px rgba(0,0,0,0.8);
    }

    /* bulle thinking */
    .bubble.thinking {
      align-self:flex-start;
      background:#2b2b2b;
      color:#ccc;
      font-style:italic;
    }

    /* BARRE INPUT */
    .input-zone-wrapper {
      background:#000;
      border-top:1px solid rgba(255,255,255,0.08);
      padding:16px;
    }
    .input-row {
      display:flex;
      align-items:stretch;
      gap:12px;
      background:radial-gradient(circle at 0% 0%, rgba(130,110,255,.3) 0%, rgba(0,0,0,0) 60%);
    }
    .plus-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:28px;
      line-height:0;
      font-weight:500;
    }
    .text-input {
      flex:1;
      background:#0f0f1a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      font-size:18px;
      color:#fff;
      padding:16px;
      font-family:inherit;
      outline:none;
    }
    .send-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:24px;
      line-height:0;
      font-weight:500;
    }

    .status-line {
      text-align:center;
      margin-top:12px;
      font-size:15px;
      color:#999;
      font-weight:400;
    }
    .status-line strong {
      font-weight:600;
      color:#fff;
    }
    .status-line #token-count-bottom {
      color:#fff;
      font-feature-settings:"tnum";
    }

    /* TOAST ERREUR */
    .toast {
      position:fixed;
      left:50%;
      bottom:24px;
      transform:translateX(-50%);
      background:#1f1f1f;
      color:#fff;
      border:1px solid rgba(255,255,255,0.2);
      border-radius:12px;
      padding:16px;
      font-size:17px;
      line-height:1.4;
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      max-width:90%;
      z-index:1000;
      display:none;
    }
    .toast-row-close{
      text-align:right;
      margin-top:12px;
      color:#4d8dff;
      font-weight:500;
    }
  </style>

  <!-- Clerk Frontend SDK (obligatoire pour que la pop apparaisse) -->
  <!-- <<< Clerk script avec ta cl√© publique -->
  <script
    async
    crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="left-head">
      <div class="burger">‚ò∞</div>
    </div>

    <div class="token-box">
      <div class="token-value">
        <div style="font-size:20px;">üíé</div>
        <span id="token-count-top">5000</span>
        <span>tokens</span>
      </div>
      <div class="token-label">Philom√®ne I.A.</div>
    </div>

    <div class="right-head">
      <div class="more" id="more-btn">‚ãØ
        <div class="menu-panel" id="menu-panel">
          <div class="menu-item" id="menu-login">
            <div class="menu-title">Connexion / Inscription</div>
            <div class="menu-desc">Cr√©er un compte ou se connecter</div>
          </div>
          <div class="menu-item disabled" id="menu-pay">
            <div class="menu-title">Paiement (bient√¥t)</div>
            <div class="menu-desc">Recharger ses tokens par PayPal</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- ZONE MESSAGES -->
  <div id="chat-container" class="chat-wrapper"></div>

  <!-- BARRE D'ENVOI -->
  <div class="input-zone-wrapper">
    <div class="input-row">
      <div class="plus-btn">+</div>
      <input
        id="user-input"
        class="text-input"
        placeholder="√âcrivez votre message..."
      />
      <div id="send-btn" class="send-btn">‚û§</div>
    </div>

    <div class="status-line">
      Pr√™t ‚Ä¢
      <strong>
        <span id="token-count-bottom">5000</span>
        tokens
      </strong>
      restants
    </div>
  </div>

  <!-- Toast erreur -->
  <div class="toast" id="toast">
    <div id="toast-msg">Erreur r√©seau.</div>
    <div class="toast-row-close" id="toast-close">Fermer</div>
  </div>

  <script>
    // ========================
    // CONFIG / √âTAT GLOBAL
    // ========================

    // Backend IA
    const API_URL = "https://philo-backend-su29.onrender.com/ask";

    // compteur tokens simul√©
    let tokenCount = 5000;

    // conversation m√©moire locale EN COURS DE SESSION
    const conversation = [
      {
        role:"system",
        content:
          "Tu es Philom√®ne I.A., une assistante personnelle en fran√ßais, avec un ton humain, calme et rassurant."
      },
      {
        role:"assistant",
        content:
          "üëã Bonjour ! Je suis Philom√®ne I.A., votre assistante personnelle.\n" +
          "Si vous avez un probl√®me, j‚Äôai la solution.\n" +
          "Vous avez une question, j‚Äôai la r√©ponse.\n" +
          "Ensemble, on ira plus loin üïä"
      }
    ];

    // ========================
    // SELECTEURS
    // ========================
    const chatContainer  = document.getElementById("chat-container");
    const userInput      = document.getElementById("user-input");
    const sendBtn        = document.getElementById("send-btn");
    const tokenTop       = document.getElementById("token-count-top");
    const tokenBottom    = document.getElementById("token-count-bottom");

    const moreBtn        = document.getElementById("more-btn");
    const menuPanel      = document.getElementById("menu-panel");
    const menuLogin      = document.getElementById("menu-login");

    const toastEl        = document.getElementById("toast");
    const toastMsgEl     = document.getElementById("toast-msg");
    const toastCloseEl   = document.getElementById("toast-close");

    // ========================
    // UI HELPERS
    // ========================

    function scrollToBottom(){
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    function addBubble(text, who){
      const div = document.createElement("div");
      div.classList.add("bubble");

      if (who === "user") {
        div.classList.add("user");
      } else if (who === "thinking") {
        div.classList.add("thinking");
      } else {
        div.classList.add("assistant");
      }

      div.textContent = text || "";
      chatContainer.appendChild(div);
      scrollToBottom();
      return div;
    }

    function updateTokenDisplay(){
      tokenTop.textContent    = tokenCount;
      tokenBottom.textContent = tokenCount;
    }

    function showToast(msg){
      toastMsgEl.textContent = msg;
      toastEl.style.display = "block";
    }

    function hideToast(){
      toastEl.style.display = "none";
    }

    // Affiche message d'accueil assistant
    function initConversationUI(){
      const welcomeMsg = conversation[1].content;
      addBubble(welcomeMsg,"assistant");
      updateTokenDisplay();
      scrollToBottom();
    }

    // ========================
    // CHAT LOGIQUE
    // ========================

    async function askPhilomene(){
      const text = userInput.value.trim();
      if (!text) return;

      // bulle user
      addBubble(text,"user");

      // push local
      conversation.push({ role:"user", content:text });

      userInput.value = "";

      // bulle thinking
      const thinking = addBubble("Philom√®ne r√©fl√©chit √† votre message...","thinking");

      try {
        const resp = await fetch(API_URL,{
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body:JSON.stringify({ conversation })
        });

        if(!resp.ok){
          throw new Error("R√©ponse r√©seau pas OK: "+resp.status);
        }

        const data = await resp.json();

        thinking.remove();
        addBubble(data.answer || "‚Ä¶","assistant");

        conversation.push({
          role:"assistant",
          content:data.answer || ""
        });

        tokenCount = Math.max(0, tokenCount - 20);
        updateTokenDisplay();

      } catch(err){
        // √©chec r√©seau = toast + remplacement thinking
        thinking.textContent = "D√©sol√©e, j'ai eu un probl√®me r√©seau.";
        showToast("Connexion indisponible pour le moment.");
      }
    }

    sendBtn.addEventListener("click", askPhilomene);
    userInput.addEventListener("keydown",(e)=>{
      if(e.key==="Enter"){
        e.preventDefault();
        askPhilomene();
      }
    });

    toastCloseEl.addEventListener("click", hideToast);

    // ========================
    // MENU ‚ãØ (OUVRIR / FERMER)
    // ========================
    let menuOpen = false;
    moreBtn.addEventListener("click",(e)=>{
      e.stopPropagation();
      menuOpen = !menuOpen;
      menuPanel.style.display = menuOpen ? "block" : "none";
    });

    document.addEventListener("click",()=>{
      if(menuOpen){
        menuOpen = false;
        menuPanel.style.display="none";
      }
    });

    // ========================
    // CLERK LOGIN
    // ========================
    // On attend que Clerk soit charg√© dans la page, puis on branche le clic.
    // Quand l'utilisateur tape "Connexion / Inscription", on ouvre la modale Clerk.

    function openClerkSignIn(){
      // Si Clerk n'est pas encore pr√™t, on montre l'alerte style "pas pr√™t"
      if(!window.Clerk || !window.Clerk.openSignIn){
        showToast("Connexion indisponible pour le moment.");
        return;
      }
      window.Clerk.openSignIn(); // <<< ouvre la pop Clerk
    }

    menuLogin.addEventListener("click",(e)=>{
      e.stopPropagation();
      openClerkSignIn();
      menuOpen = false;
      menuPanel.style.display="none";
    });

    // IMPORTANT:
    // on initialise Clerk apr√®s que le script remote a charg√©.
    // publishableKey = ta cl√© publique
    window.addEventListener("load", async () => {
      if (window.Clerk) {
        try {
          await window.Clerk.load({
            publishableKey: "pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
          });
        } catch(e){
          // si Clerk n'arrive pas √† se charger (ex: domaine pas autoris√©),
          // le bouton va retomber sur le toast "indisponible"
          console.warn("Clerk init error:", e);
        }
      }
    });

    // ========================
    // START
    // ========================
    initConversationUI();
  </script>
</body>
</html>

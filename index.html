<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover"/>
  <title>Philomenia Messenger (style MSN)</title>
  <style>
    :root{
      --bg:#0b1220; --panel:#0e1b2e; --text:#e8f0ff; --sub:#9fb4d6;
      --acc1:#3aa4ff; --acc2:#8ec0ff; --bubble-me:#0e66ff22; --bubble-bot:#103559aa;
      --border:#274467; --shadow: 0 10px 30px #0008;
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0}
    body{
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;
      background: radial-gradient(1200px 800px at 10% -10%, #143257, #081120 60%);
      color:var(--text);
    }
    .app{
      max-width:820px;margin:12px auto;padding:0 12px;
    }
    .window{
      background:linear-gradient(#2c6cd8,#2a60bd 60%,#214e9a);
      border-radius:16px; box-shadow:var(--shadow); overflow:hidden;
      border:1px solid #1f3f7f;
    }
    .titlebar{
      display:flex;align-items:center;gap:10px;padding:12px 14px;
    }
    .titlebar .lamp{
      width:14px;height:14px;border-radius:50%;
      background:#33ff5a;box-shadow:0 0 10px #33ff5a88 inset,0 0 8px #33ff5a88;
      margin-right:6px;
    }
    .title{font-weight:700;text-shadow:0 1px 0 #0006}
    .tb-actions{margin-left:auto;display:flex;gap:10px}
    .btn-ico{
      width:40px;height:40px;border-radius:10px;border:1px solid #19407f;
      background:linear-gradient(#0b1c36,#0a1730); color:#cfe3ff;
      display:grid;place-items:center;cursor:pointer;
    }
    .btn-ico:hover{outline:2px solid #3aa4ff55}
    .tabs{display:flex;gap:8px;padding:0 14px 12px}
    .tab{
      padding:6px 10px;border-radius:10px;border:1px solid #19407f;
      background:#0a1730;color:#cfe3ff;cursor:pointer;min-width:48px;text-align:center
    }
    .tab.active{background:#14305a;border-color:#2e6fe0}
    .panel{
      background:var(--panel); border-top:1px solid #153361;
      padding:14px;min-height:360px;max-height:55dvh;overflow:auto;
    }
    .bubble{
      background:var(--bubble-bot);padding:12px 14px;border-radius:12px;
      border:1px solid var(--border); margin:10px 0; max-width:92%;
      box-shadow: inset 0 0 0 1px #0004;
    }
    .me{margin-left:auto;background:var(--bubble-me)}
    .hint{color:var(--sub);font-size:14px;line-height:1.4}
    .footer{
      background:#0a1730;border-top:1px solid #153361;padding:10px 12px;
      position: sticky; bottom:0; z-index:2;
    }
    .composer{display:flex;gap:10px;align-items:center}
    .attach, .nudge{
      width:44px;height:44px;border-radius:12px;border:1px solid #19407f;
      background:#0e1b2e;color:#cfe3ff;display:grid;place-items:center;cursor:pointer;
    }
    .input{
      flex:1;border:1px solid #274467;background:#0e1b2e;color:var(--text);
      border-radius:12px;padding:12px 14px;min-height:44px;max-height:120px;overflow:auto
    }
    .send{
      min-width:120px;height:44px;border-radius:12px;border:1px solid #19407f;
      background:linear-gradient(#2e7bff,#2162d9);color:white;font-weight:700;cursor:pointer
    }
    .meter{
      margin:8px 0 0; height:8px;border-radius:999px;background:#0b162a;border:1px solid #18335f;
      position:relative;overflow:hidden
    }
    .meter > i{position:absolute;inset:0;width:0;background:linear-gradient(90deg,#2e7bff,#38e3ff);transition:width .25s}
    .small{font-size:13px;color:#a8c2ea;margin-top:6px}
    /* Modal settings */
    .modal{position:fixed;inset:0;background:#0008;display:none;place-items:center;padding:18px}
    .modal.open{display:grid}
    .card{
      width:min(820px,96vw); max-height:88dvh; overflow:auto;
      background:#0a1730;border:1px solid #274467;border-radius:16px; box-shadow:var(--shadow); padding:16px;
    }
    .h2{font-size:20px;margin:4px 0 14px}
    .pack{border:1px solid #274467;border-radius:12px;padding:14px;margin:10px 0;background:#0e1b2e}
    .primary{background:#2e7bff;color:#fff;border:none;border-radius:12px;padding:10px 14px;font-weight:700;cursor:pointer}
    .row{display:flex;gap:10px;flex-wrap:wrap}
    .row > *{flex:1}
    /* iOS focus fix: preserve layout height */
    .viewport{height:calc(100dvh - 24px)}
    @media (max-width:520px){ .send{min-width:100px} .panel{max-height:52dvh} }
  </style>
</head>
<body>
<div class="app viewport">
  <div class="window">
    <div class="titlebar">
      <div class="lamp"></div>
      <div class="title">Philomenia Messenger</div>
      <div class="tb-actions">
        <button class="btn-ico" id="btnDownload" title="T√©l√©charger la conversation">‚¨áÔ∏è</button>
        <button class="btn-ico" id="btnPrint" title="Imprimer">üñ®Ô∏è</button>
        <button class="btn-ico" id="btnSettings" title="Param√®tres ‚Ä¢ Recharger">‚öôÔ∏è</button>
      </div>
    </div>

    <div class="tabs">
      <button class="tab active" data-lang="fr">FR</button>
      <button class="tab" data-lang="en">EN</button>
      <button class="tab" data-lang="nl">NL</button>
      <div style="margin-left:auto;display:flex;align-items:center;gap:8px">
        <span style="background:#19325a;border:1px solid #274467;color:#cfe3ff;border-radius:12px;padding:6px 10px">
          <strong>Tokens :</strong>
          <span id="tok-free" title="Gratuits"></span> /
          <span id="tok-paid" title="Pay√©s"></span> ‚Äî
          <span id="tok-total" title="Total"></span>
        </span>
      </div>
    </div>

    <div class="panel" id="chat">
      <div class="bubble hint" id="hello"></div>
    </div>

    <div class="footer">
      <div class="composer">
        <button class="attach" id="btnAttach" title="Envoyer une image">üìé</button>
        <button class="nudge" id="btnNudge" title="Nudge">üîî</button>
        <div class="input" id="input" contenteditable="true" role="textbox" aria-multiline="true"></div>
        <button class="send" id="btnSend">Envoyer</button>
      </div>
      <div class="meter"><i id="meterFill"></i></div>
      <div class="small" id="detail"></div>
    </div>
  </div>
</div>

<!-- Sons (facultatif) -->
<audio id="snd-send" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA"></audio>
<audio id="snd-recv" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA"></audio>
<audio id="snd-nudge" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA"></audio>

<!-- Modal param√®tres -->
<div class="modal" id="settings">
  <div class="card">
    <div class="h2">Param√®tres</div>
    <div class="row">
      <div>
        <label>Actualit√©s</label>
        <div style="display:flex;gap:8px">
          <input id="newsQ" placeholder="ex : premier ministre fran√ßais" style="flex:1;border:1px solid #274467;background:#0e1b2e;color:#e8f0ff;border-radius:10px;padding:10px"/>
          <button class="primary" id="btnNews">Chercher</button>
        </div>
        <div id="newsRes" class="small" style="margin-top:8px"></div>
      </div>
    </div>

    <div class="h2" style="margin-top:16px">Recharger des tokens (PayPal)</div>
    <div class="pack">
      <div class="row" style="align-items:center">
        <div><strong>Pack 5 ‚Ç¨</strong><br/><span class="small">‚âà 12 000 tokens</span></div>
        <button class="primary" data-price="5"  data-tokens="12000">Payer 5 ‚Ç¨</button>
      </div>
    </div>
    <div class="pack">
      <div class="row" style="align-items:center">
        <div><strong>Pack 10 ‚Ç¨</strong><br/><span class="small">‚âà 28 000 tokens</span></div>
        <button class="primary" data-price="10" data-tokens="28000">Payer 10 ‚Ç¨</button>
      </div>
    </div>
    <div class="pack">
      <div class="row" style="align-items:center">
        <div><strong>Pack 20 ‚Ç¨</strong><br/><span class="small">‚âà 60 000 tokens</span></div>
        <button class="primary" data-price="20" data-tokens="60000">Payer 20 ‚Ç¨</button>
      </div>
    </div>

    <div style="text-align:right;margin-top:8px">
      <button class="primary" style="background:#274467" id="closeSettings">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ===== CONFIG ===== */
const BACKEND_URL = "https://philo-backend-su29.onrender.com";

/* ===== i18n ===== */
const STR = {
  fr:{ hello:"Bonjour üëã\n‚Ä¢ Tape @motcl√© pour l‚Äôactualit√©\n‚Ä¢ Clique sur ‚öôÔ∏è pour recharger des tokens",
       sendPH:"√âcris ton message‚Ä¶ (Entr√©e = envoyer)",
       detail:(r)=>`Solde : ${r.total.toLocaleString()} ‚Ä¢ Gratuit : ${r.free.toLocaleString()} ‚Ä¢ Payant : ${r.paid.toLocaleString()}`,
       quotaOut:"‚ö†Ô∏è Plus de tokens. Ouvre ‚öôÔ∏è pour recharger." },
  en:{ hello:"Hello üëã\n‚Ä¢ Type @keyword for news\n‚Ä¢ Tap ‚öôÔ∏è to top up tokens",
       sendPH:"Type your message‚Ä¶ (Enter to send)",
       detail:(r)=>`Balance: ${r.total.toLocaleString()} ‚Ä¢ Free: ${r.free.toLocaleString()} ‚Ä¢ Paid: ${r.paid.toLocaleString()}`,
       quotaOut:"‚ö†Ô∏è Out of tokens. Open ‚öôÔ∏è to top up." },
  nl:{ hello:"Hallo üëã\n‚Ä¢ Typ @trefwoord voor nieuws\n‚Ä¢ Tik ‚öôÔ∏è om tokens op te laden",
       sendPH:"Schrijf je bericht‚Ä¶ (Enter = verzenden)",
       detail:(r)=>`Saldo: ${r.total.toLocaleString()} ‚Ä¢ Gratis: ${r.free.toLocaleString()} ‚Ä¢ Betaald: ${r.paid.toLocaleString()}`,
       quotaOut:"‚ö†Ô∏è Tokens op. Open ‚öôÔ∏è om op te laden." }
};
let lang = (localStorage.getItem("lang")||"fr");
const $ = (s, r=document)=>r.querySelector(s);
const chat = $("#chat"), input = $("#input");
const btnSend = $("#btnSend"), btnNudge=$("#btnNudge"), btnAttach=$("#btnAttach");

/* ===== Client ID (local) ===== */
let CLIENT_ID = localStorage.getItem("client-id") || "anon";
localStorage.setItem("client-id", CLIENT_ID);

/* ===== UI init ===== */
function addMsg(who, text){
  const b = document.createElement("div");
  b.className = "bubble"+(who==="me"?" me":"");
  b.textContent = text;
  chat.appendChild(b);
  chat.scrollTop = chat.scrollHeight;
}
function setLang(l){
  lang=l; localStorage.setItem("lang",l);
  document.querySelectorAll(".tab").forEach(t=>t.classList.toggle("active", t.dataset.lang===l));
  $("#hello").textContent = STR[l].hello;
  input.setAttribute("placeholder", STR[l].sendPH);
}
document.querySelectorAll(".tab").forEach(t=>t.onclick=()=>setLang(t.dataset.lang));
setLang(lang);

/* ===== Quota / meter ===== */
async function refreshQuota(){
  const r = await fetch(`${BACKEND_URL}/api/quota`, {headers:{ "x-client-id":CLIENT_ID, "x-lang":lang }});
  const j = await r.json();
  const free = j.freeRemaining|0, paid = j.paidBalance|0, total = (j.totalRemaining|0);
  $("#tok-free").textContent = free.toLocaleString();
  $("#tok-paid").textContent = paid.toLocaleString();
  $("#tok-total").textContent = total.toLocaleString();
  $("#detail").textContent = STR[lang].detail({free,paid,total});
  const cap = 60000; // √©chelle de la barre (visuel)
  $("#meterFill").style.width = `${Math.min(100, (total/cap)*100)}%`;
  return total;
}

/* ===== Envoi ===== */
input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); btnSend.click(); }
});
btnSend.onclick = async ()=>{
  const text = (input.textContent||"").trim();
  if(!text) return;
  addMsg("me", text);
  input.textContent = "";
  $("#snd-send")?.play().catch(()=>{});
  const total = await refreshQuota();
  if(total<=0){ addMsg("bot", STR[lang].quotaOut); return; }

  // actualit√©s si @motcl√©
  if(text.startsWith("@")){
    const q = text.slice(1).trim();
    const r = await fetch(`${BACKEND_URL}/api/news?q=`+encodeURIComponent(q),{
      headers:{ "x-client-id":CLIENT_ID, "x-lang":lang }
    });
    const j = await r.json();
    const lines = (j.results||[]).slice(0,3).map(it=>"üì∞ "+it.title+" üîó "+it.url).join("\n");
    addMsg("bot", lines||"Aucun r√©sultat.");
    $("#snd-recv")?.play().catch(()=>{});
    await refreshQuota();
    return;
  }

  const r = await fetch(`${BACKEND_URL}/api/chat`,{
    method:"POST",
    headers:{ "Content-Type":"application/json","x-client-id":CLIENT_ID,"x-lang":lang },
    body: JSON.stringify({ message:text })
  });
  if(r.status===402){ addMsg("bot", STR[lang].quotaOut); return; }
  if(!r.ok){ addMsg("bot","[Erreur r√©seau]"); return; }
  const j = await r.json();
  addMsg("bot", j.reply || "‚Ä¶");
  $("#snd-recv")?.play().catch(()=>{});
  await refreshQuota();
};

/* ===== Nudge / Print / Download ===== */
btnNudge.onclick = ()=>{ $("#snd-nudge")?.play().catch(()=>{}); chat.classList.add("shake"); setTimeout(()=>chat.classList.remove("shake"),500) };
$("#btnPrint").onclick = ()=>window.print();
$("#btnDownload").onclick = ()=>{
  const texts = [...document.querySelectorAll(".bubble")].map(b=> (b.classList.contains("me")?"Moi: ":"Œ¶: ")+b.textContent);
  const blob = new Blob([texts.join("\n\n")],{type:"text/plain"});
  const a = document.createElement("a"); a.href = URL.createObjectURL(blob); a.download="conversation.txt"; a.click();
  URL.revokeObjectURL(a.href);
};

/* ===== Settings / PayPal Packs ===== */
const dlg = $("#settings");
$("#btnSettings").onclick = ()=>{ dlg.classList.add("open"); };
$("#closeSettings").onclick = ()=>{ dlg.classList.remove("open"); };
dlg.addEventListener("click", e=>{ if(e.target===dlg) dlg.classList.remove("open"); });

dlg.querySelectorAll(".pack .primary").forEach(btn=>{
  btn.onclick = async ()=>{
    const price = Number(btn.dataset.price), tokens = Number(btn.dataset.tokens);
    btn.disabled = true; btn.textContent = "‚Ä¶";
    try{
      const r = await fetch(`${BACKEND_URL}/api/paypal/create-order`,{
        method:"POST",
        headers:{ "Content-Type":"application/json","x-client-id":CLIENT_ID,"x-lang":lang },
        body: JSON.stringify({ price, tokens })
      });
      const j = await r.json();
      if(j.approveUrl){ location.href = j.approveUrl; }
      else{ alert("Paiement indisponible."); }
    }catch(err){ alert("Erreur r√©seau."); }
    finally{ btn.disabled=false; btn.textContent = `Payer ${price} ‚Ç¨`; }
  };
});

/* ===== News depuis la modale ===== */
$("#btnNews").onclick = async ()=>{
  const q = $("#newsQ").value.trim(); if(!q) return;
  $("#newsRes").textContent="‚Ä¶";
  const r = await fetch(`${BACKEND_URL}/api/news?q=`+encodeURIComponent(q), {headers:{ "x-client-id":CLIENT_ID, "x-lang":lang }});
  const j = await r.json();
  const lines = (j.results||[]).slice(0,3).map(it=>"‚Ä¢ "+it.title).join("\n");
  $("#newsRes").textContent = lines || "Aucun r√©sultat.";
};

/* ===== Attach (image) : optionnel (placeholder) ===== */
btnAttach.onclick = ()=>alert("Envoi d‚Äôimage (√† activer plus tard).");

/* ===== Boot ===== */
addMsg("bot", STR[lang].hello);
refreshQuota();

/* Visuel secousse nudge */
const style = document.createElement("style");
style.textContent = `.shake{animation:sh .08s linear 8}
@keyframes sh{0%{transform:translateX(0)}25%{transform:translateX(-4px)}50%{transform:translateX(0)}75%{transform:translateX(4px)}100%{transform:translateX(0)}}`;
document.head.appendChild(style);
</script>
</body>
</html>

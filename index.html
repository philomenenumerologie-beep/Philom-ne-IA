<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Philomenia ‚Ä¢ Messenger</title>
<style>
  :root{
    --bg:#0f1722;--panel:#121a26;--text:#dbe7ff;--sub:#9db2d7;
    --a1:#4da3ff;--a2:#2b73d9;--border:#24334a;--me:#1a2638;--bot:#121a26;--input:#0c111a;
  }
  html,body{margin:0;height:100%;background:var(--bg);color:var(--text);
    font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial;-webkit-text-size-adjust:100%}
  *{box-sizing:border-box}
  .wrap{min-height:100dvh;display:flex;align-items:stretch;justify-content:center;padding:12px}
  .win{width:100%;max-width:860px;display:flex;flex-direction:column;border:1px solid var(--border);
    border-radius:12px;background:var(--panel);box-shadow:0 10px 30px rgba(0,0,0,.35);overflow:hidden}
  .bar{display:flex;align-items:center;gap:8px;background:linear-gradient(#5aa0ff,#2d7fff);color:#fff;padding:10px 14px}
  .title{font-weight:700;flex:1}
  .lang{display:flex;gap:6px}
  .lang a{color:#fff;text-decoration:none;border:1px solid rgba(255,255,255,.4);padding:4px 8px;border-radius:8px;opacity:.9}
  .lang a.active{background:rgba(255,255,255,.25)}
  .ibtn{width:38px;height:38px;display:grid;place-items:center;background:rgba(255,255,255,.18);
    border:1px solid rgba(255,255,255,.35);border-radius:10px;cursor:pointer}
  .chat{flex:1;min-height:0;overflow:auto;padding:16px;scroll-behavior:smooth}
  .msg{max-width:92%;padding:12px 14px;border:1px solid var(--border);border-radius:14px;margin:8px 0;
    white-space:pre-wrap;word-break:break-word}
  .me{background:var(--me);margin-left:auto}
  .bot{background:var(--bot)}
  /* panneau tokens sous la discussion */
  .tokens-panel{padding:10px 14px;border-top:1px solid var(--border);background:rgba(255,255,255,.02)}
  .t-row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .t-badge{background:rgba(0,0,0,.25);border:1px solid rgba(255,255,255,.35);border-radius:999px;padding:6px 10px;font-weight:700}
  .t-detail{font-size:.9rem;color:var(--sub)}
  .t-bar{height:6px;border-radius:999px;background:rgba(255,255,255,.2);overflow:hidden;border:1px solid rgba(255,255,255,.25);margin-top:8px}
  .t-fill{height:100%;width:0;background:linear-gradient(90deg,#9be7a5,#20c997)}
  /* input */
  .input{position:sticky;bottom:0;left:0;right:0;background:var(--panel);
    border-top:1px solid var(--border);padding:10px;display:flex;gap:10px;align-items:center}
  .iconbtn{width:44px;height:44px;display:grid;place-items:center;border:1px solid var(--border);
    background:var(--panel);border-radius:12px}
  textarea{flex:1;resize:none;max-height:40vh;padding:12px 14px;border-radius:12px;
    border:1px solid var(--border);background:var(--input);color:inherit;outline:none;font-size:16px}
  button.primary{background:linear-gradient(var(--a2),var(--a1));color:#fff;border:none;padding:12px 18px;border-radius:12px;font-weight:700;min-width:110px}
  /* modal */
  .modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.45);padding:16px}
  .modal.show{display:flex}
  .card{max-width:700px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:0 12px 40px rgba(0,0,0,.35)}
  .card h3{margin:0;padding:16px;border-bottom:1px solid var(--border)}
  .content{padding:16px}
  .packs{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px}
  .pack{border:1px solid var(--border);border-radius:12px;padding:14px}
  .pill{background:#142033;border:1px solid var(--border);border-radius:999px;padding:2px 8px;margin-left:6px}
  @media (max-width:520px){.msg{max-width:100%}}
</style>
</head>
<body>
<div class="wrap">
  <div class="win" id="win">
    <div class="bar">
      <div class="title" id="t_app">Philomenia Messenger</div>
      <div class="lang">
        <a href="#" data-lang="fr" id="lng-fr">FR</a>
        <a href="#" data-lang="en" id="lng-en">EN</a>
        <a href="#" data-lang="nl" id="lng-nl">NL</a>
      </div>
      <div class="ibtn" id="btnDownload" title="T√©l√©charger">‚¨áÔ∏è</div>
      <div class="ibtn" id="btnPrint" title="Imprimer">üñ®Ô∏è</div>
      <div class="ibtn" id="btnSettings" title="Recharger & Param√®tres">‚öôÔ∏è</div>
    </div>

    <div class="chat" id="chat"></div>

    <!-- COMPTEUR TOKENS sous la discussion -->
    <div class="tokens-panel">
      <div class="t-row">
        <div class="t-badge" id="tokBadge">Tokens : ‚Äî</div>
        <div class="t-detail" id="tokDetail">‚Äî</div>
      </div>
      <div class="t-bar"><div class="t-fill" id="tokFill"></div></div>
    </div>

    <div class="input" id="inputbar" style="padding-bottom:calc(10px + env(safe-area-inset-bottom))">
      <label class="iconbtn" title="Joindre une image">
        üìé <input type="file" id="file" accept="image/*" style="display:none">
      </label>
      <div class="iconbtn" id="btnNudge" title="Nudge">üîî</div>
      <textarea id="input" rows="1" placeholder="√âcris ton message‚Ä¶"></textarea>
      <button class="primary" id="send">Envoyer</button>
    </div>
  </div>
</div>

<!-- Modal recharges -->
<div class="modal" id="settings">
  <div class="card">
    <h3 id="t_topup">Recharger des tokens (PayPal)</h3>
    <div class="content">
      <div class="packs">
        <div class="pack"><strong id="p1_title">Pack 5 ‚Ç¨</strong> <span class="pill" id="p1_tokens">‚âà 12 000 tokens</span><div id="pp-5" style="margin-top:8px"></div></div>
        <div class="pack"><strong id="p2_title">Pack 10 ‚Ç¨</strong> <span class="pill" id="p2_tokens">‚âà 28 000 tokens</span><div id="pp-10" style="margin-top:8px"></div></div>
        <div class="pack"><strong id="p3_title">Pack 20 ‚Ç¨</strong> <span class="pill" id="p3_tokens">‚âà 60 000 tokens</span><div id="pp-20" style="margin-top:8px"></div></div>
      </div>
      <div style="text-align:right;margin-top:12px"><button id="closeSettings">OK</button></div>
    </div>
  </div>
</div>

<!-- sons (facultatif) -->
<audio id="snd-send" preload="auto"></audio>
<audio id="snd-recv" preload="auto"></audio>
<audio id="snd-nudge" preload="auto"></audio>

<script>
// ===== CONFIG =====
const BACKEND_URL = "https://philo-backend-xxxx.onrender.com"; // ‚Üê mets ton URL backend

// i18n
const STR = {
  fr:{app:"Philomenia Messenger",hello:"Bonjour üëã\n‚Ä¢ Tape @motcl√© pour l‚Äôactualit√©\n‚Ä¢ Clique sur ‚öôÔ∏è pour recharger des tokens",
      topup:"Recharger des tokens (PayPal)",
      p1:"Pack 5 ‚Ç¨",p1t:"‚âà 12 000 tokens",p2:"Pack 10 ‚Ç¨",p2t:"‚âà 28 000 tokens",p3:"Pack 20 ‚Ç¨",p3t:"‚âà 60 000 tokens",
      msgPH:"√âcris ton message‚Ä¶",send:"Envoyer",
      detail:(r,t,p)=>`Solde: ${r.toLocaleString()}  ‚Ä¢  Gratuit: ${t.toLocaleString()}  ‚Ä¢  Payant: ${p.toLocaleString()}`,
      out:"‚ö†Ô∏è Plus de tokens. Ouvre ‚öôÔ∏è pour recharger."},
  en:{app:"Philomenia Messenger",hello:"Hello üëã\n‚Ä¢ Type @keyword for news\n‚Ä¢ Click ‚öôÔ∏è to top up tokens",
      topup:"Top up tokens (PayPal)",
      p1:"Pack ‚Ç¨5",p1t:"‚âà 12,000 tokens",p2:"Pack ‚Ç¨10",p2t:"‚âà 28,000 tokens",p3:"Pack ‚Ç¨20",p3t:"‚âà 60,000 tokens",
      msgPH:"Type your message‚Ä¶",send:"Send",
      detail:(r,t,p)=>`Balance: ${r.toLocaleString()}  ‚Ä¢  Free: ${t.toLocaleString()}  ‚Ä¢  Paid: ${p.toLocaleString()}`,
      out:"‚ö†Ô∏è Out of tokens. Open ‚öôÔ∏è to top up."},
  nl:{app:"Philomenia Messenger",hello:"Hallo üëã\n‚Ä¢ Typ @trefwoord voor nieuws\n‚Ä¢ Klik ‚öôÔ∏è om tokens op te laden",
      topup:"Tokens opladen (PayPal)",
      p1:"Pakket ‚Ç¨5",p1t:"‚âà 12.000 tokens",p2:"Pakket ‚Ç¨10",p2t:"‚âà 28.000 tokens",p3:"Pakket ‚Ç¨20",p3t:"‚âà 60.000 tokens",
      msgPH:"Schrijf je bericht‚Ä¶",send:"Versturen",
      detail:(r,t,p)=>`Saldo: ${r.toLocaleString()}  ‚Ä¢  Gratis: ${t.toLocaleString()}  ‚Ä¢  Betaald: ${p.toLocaleString()}`,
      out:"‚ö†Ô∏è Tokens op. Open ‚öôÔ∏è om op te laden."}
};
const $=(s,r=document)=>r.querySelector(s);
const chat=$("#chat"), input=$("#input"), send=$("#send");
const tokBadge=$("#tokBadge"), tokFill=$("#tokFill"), tokDetail=$("#tokDetail");
const btnPrint=$("#btnPrint"), btnDownload=$("#btnDownload");
const btnSettings=$("#btnSettings"), modal=$("#settings"), closeSettings=$("#closeSettings");
const file=$("#file"), win=$("#win");

let lang = localStorage.getItem("lang") || (navigator.language||"fr").slice(0,2);
if(!["fr","en","nl"].includes(lang)) lang="fr";
setLang(lang);
$("#lng-fr").onclick=(e)=>{e.preventDefault();setLang("fr"); refreshQuota();};
$("#lng-en").onclick=(e)=>{e.preventDefault();setLang("en"); refreshQuota();};
$("#lng-nl").onclick=(e)=>{e.preventDefault();setLang("nl"); refreshQuota();};
function setLang(l){
  lang=l; localStorage.setItem("lang",l);
  $("#t_app").textContent=STR[l].app;
  $("#t_topup").textContent=STR[l].topup;
  $("#p1_title").textContent=STR[l].p1; $("#p1_tokens").textContent=STR[l].p1t;
  $("#p2_title").textContent=STR[l].p2; $("#p2_tokens").textContent=STR[l].p2t;
  $("#p3_title").textContent=STR[l].p3; $("#p3_tokens").textContent=STR[l].p3t;
  input.placeholder=STR[l].msgPH; send.textContent=STR[l].send;
}

// identit√© client
const CLIENT_ID = localStorage.getItem("client-id") || (crypto.randomUUID?.() || String(Math.random()));
localStorage.setItem("client-id", CLIENT_ID);

// UI
function addMsg(who,text){ const m=document.createElement("div"); m.className=`msg ${who}`; m.textContent=text; chat.appendChild(m); chat.scrollTop=chat.scrollHeight; return m; }
async function toBase64(file){ return await new Promise((res,rej)=>{ const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file); }); }
function approxTokens(s){ return Math.ceil((s||"").length/4); }

// Intro
addMsg("bot", STR[lang].hello);

// TOKEN STATE
let maxSeen=0, lastPaid=0, lastTrial=0, remaining=0;
function updateTokenUI(rem, trial, paid){
  remaining=rem; lastTrial=trial; lastPaid=paid;
  tokBadge.textContent = (lang==="fr"?"Tokens : ":"Tokens: ")+ rem.toLocaleString();
  tokDetail.textContent = STR[lang].detail(rem, trial, paid);
  if(rem>maxSeen) maxSeen=rem;
  const p = Math.max(0, Math.min(1, rem / Math.max(maxSeen,1)));
  tokFill.style.width = (p*100).toFixed(1)+"%";
  tokFill.style.background = p>0.6 ? "linear-gradient(90deg,#9be7a5,#20c997)"
                        : p>0.25? "linear-gradient(90deg,#ffd36e,#ffb020)"
                                : "linear-gradient(90deg,#ff9aa5,#ff6b6b)";
}

async function refreshQuota(){
  try{
    const r=await fetch(`${BACKEND_URL}/api/quota`,{ headers:{ "x-client-id":CLIENT_ID }});
    const j=await r.json();
    const rem = Number(j.remaining||0);
    const trial = j.tier==="free" ? rem : 0;
    const paid  = j.tier!=="free" ? rem : 0;
    updateTokenUI(rem, trial, paid);
  }catch{ tokBadge.textContent=(lang==="fr"?"Tokens : ‚Äî":"Tokens: ‚Äî"); }
}
refreshQuota();

// mod√®le souhait√© (mini si que du gratuit, sinon turbo)
function currentModel(){ return lastPaid>0 ? "turbo" : "mini"; }

// Envoi
send.onclick = sendMessage;
input.addEventListener("keydown", e=>{
  if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
});
file.addEventListener("change", ()=>{ if(file.files[0]) addMsg("me", lang==="fr"?"üìé Image pr√™te":"üìé Image attached"); });

async function sendMessage(){
  const text=input.value.trim();
  if(!text && !file.files[0]) return;
  if(text){ addMsg("me", text); input.value=""; }

  let image=null;
  if(file.files[0]){ image=await toBase64(file.files[0]); file.value=""; }

  // Actus si @/news/actu
  if(text && /^@|^actu|^news/i.test(text)){
    const q=text.replace(/^@/,'').trim()||text;
    try{
      const r=await fetch(`${BACKEND_URL}/api/news?q=`+encodeURIComponent(q));
      const j=await r.json();
      addMsg("bot", (j?.results?.length? j.results.map(n=>`üì∞ ${n.title}\nüîó ${n.link}`).join("\n\n")
                                       : (lang==="fr"?"(Aucune actualit√© trouv√©e)":"(No news found)")));
    }catch{ addMsg("bot","(news error)"); }
    refreshQuota(); return;
  }

  // D√©cr√©ment local estimatif (retour visuel imm√©diat)
  const est = approxTokens(text) + (image?256:64);
  updateTokenUI(Math.max(remaining-est,0), lastTrial, lastPaid);

  try{
    const r=await fetch(`${BACKEND_URL}/api/chat`,{
      method:"POST",
      headers:{ "Content-Type":"application/json","x-client-id":CLIENT_ID,"x-lang":lang,"x-model":currentModel() },
      body: JSON.stringify({ message:text, image })
    });
    if(r.status===402){ addMsg("bot", STR[lang].out ); await refreshQuota(); return; }
    const j=await r.json();
    addMsg("bot", j.reply || "(‚Ä¶)"); 
    await refreshQuota(); // valeur serveur = r√©f√©rence
  }catch{
    addMsg("bot","[Erreur r√©seau]");
    await refreshQuota();
  }
}

// Imprimer / T√©l√©charger / Nudge / Settings
btnPrint.onclick = ()=>window.print();
btnDownload.onclick = ()=>{
  const lines=[...document.querySelectorAll(".msg")].map(m=> (m.classList.contains("me")?"Moi: ":"Œ¶: ")+m.textContent);
  const blob=new Blob([lines.join("\n\n")],{type:"text/plain"}), a=document.createElement("a");
  a.href=URL.createObjectURL(blob); a.download="philomenia-conversation.txt"; a.click();
};
$("#btnNudge").onclick = ()=>{ win.classList.remove("shake"); void win.offsetWidth; win.classList.add("shake"); $("#snd-nudge")?.play?.(); };

btnSettings.onclick = ()=>{
  modal.classList.add("show");
  renderBuy("#pp-5",5,12000);
  renderBuy("#pp-10",10,28000);
  renderBuy("#pp-20",20,60000);
};
closeSettings.onclick = ()=> modal.classList.remove("show");
modal.addEventListener("click", e=>{ if(e.target===modal) closeSettings.click(); });

function renderBuy(sel, price, tokens){
  const host=$(sel); host.innerHTML="";
  const btn=document.createElement("button");
  btn.textContent = (lang==="fr"?"Payer ":"Pay ") + price+"‚Ç¨";
  btn.className="primary";
  btn.onclick = async ()=>{
    try{
      const r=await fetch(`${BACKEND_URL}/api/paypal/create-order`,{
        method:"POST",
        headers:{ "Content-Type":"application/json","x-client-id":CLIENT_ID },
        body: JSON.stringify({ price, tokens })
      });
      const j=await r.json();
      if(j?.approveUrl){ location.href=j.approveUrl; }
      else if(j?.id){ addMsg("bot",(lang==="fr"?"Commande PayPal cr√©√©e":"PayPal order created")); }
      else { addMsg("bot","PayPal indisponible."); }
    }catch{ addMsg("bot","Erreur PayPal"); }
  };
  host.appendChild(btn);
}

// Mobile: input toujours visible (iOS/Android)
if(window.visualViewport){
  const vv=window.visualViewport, inputbar=$("#inputbar");
  const onVV=()=>{
    const bottomInset = Math.max(0,(window.innerHeight - vv.height - vv.offsetTop));
    inputbar.style.marginBottom = bottomInset ? (bottomInset+6)+"px":"0px";
    chat.scrollTop = chat.scrollHeight;
  };
  vv.addEventListener("resize", onVV);
  vv.addEventListener("scroll", onVV);
  window.addEventListener("orientationchange", onVV);
  onVV();
}
</script>
</body>
</html>

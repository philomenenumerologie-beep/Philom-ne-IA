<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Philom√®ne IA ‚Äî Soci√©t√©</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üèôÔ∏è</text></svg>">
  <style>
    /* Arri√®re-plan & typo (m√™me esprit que l'accueil) */
    :root{
      --grad1:#7d2cff; /* violet */
      --grad2:#ff2cc3; /* rose fuchsia */
      --card:#12101aEE;
      --ring:rgba(197, 155, 255, .25);
      --text:#ffffff;
      --muted:#a7a0b8;
      --accent: #c59bff;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      color:var(--text);
      font-family: "Poppins", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background:
        radial-gradient(1200px 900px at 10% -10%, #1f1330, transparent 60%),
        radial-gradient(1200px 900px at 110% 10%, #140f22, transparent 60%),
        radial-gradient(1600px 1200px at 50% 120%, #0a0711, transparent 60%),
        #08050d;
      min-height:100%;
    }

    header{
      max-width: 980px;
      margin: 24px auto 8px;
      padding: 0 16px;
      display:flex;align-items:center;gap:12px;flex-wrap:wrap
    }
    .logo{
      width:38px;height:38px;border-radius:10px;
      background: linear-gradient(135deg,var(--grad1),var(--grad2));
      display:grid;place-items:center;
      box-shadow: 0 0 0 6px var(--ring), 0 10px 40px rgba(197,155,255,.25);
      font-size:22px;
    }
    h1{
      margin:0;
      font-size: clamp(1.25rem, 1rem + 1.2vw, 1.8rem);
      color: var(--accent);
      letter-spacing:.2px
    }
    .sub{
      margin: 0 16px;
      color: var(--muted);
      font-size: .95rem;
    }
    .back{
      margin-left:auto;
      color:var(--text);
      text-decoration:none;
      border:1px solid rgba(197,155,255,.25);
      padding:8px 12px;border-radius:12px;
      background:#0e0b16AA; backdrop-filter: blur(6px);
    }
    .back:hover{border-color:rgba(197,155,255,.5)}

    /* Carte chat */
    .wrap{
      max-width:980px;margin:16px auto;padding:16px;
    }
    .card{
      background: var(--card);
      border: 1px solid rgba(197,155,255,.2);
      border-radius: 18px;
      overflow: clip;
      box-shadow: 0 12px 60px rgba(0,0,0,.35), 0 0 0 10px var(--ring);
      min-height: 60vh;
      display:flex; flex-direction:column;
    }

    /* Zone messages */
    .messages{
      padding: 18px;
      display:flex; flex-direction: column; gap:14px;
      overflow:auto; scroll-behavior: smooth;
    }
    .msg{
      display:grid; grid-template-columns: 38px 1fr; gap:12px; align-items:flex-start;
    }
    .avatar{
      width:38px; height:38px; border-radius:10px;
      display:grid;place-items:center; font-size:20px;
      background: #221a33; color:#d9c8ff;
      border: 1px solid rgba(197,155,255,.25);
    }
    .ai .avatar{ background: linear-gradient(135deg,var(--grad1),var(--grad2)); color:white }
    .bubble{
      background:#0f0c17; border:1px solid rgba(197,155,255,.2);
      border-radius:14px; padding:12px 14px; line-height:1.5;
      box-shadow: 0 6px 18px rgba(0,0,0,.25);
      white-space: pre-wrap;
    }
    .user .bubble{ background:#121022; }
    .meta{color:var(--muted); font-size:.8rem; margin-bottom:6px}

    /* Composer */
    .composer{
      display:flex; gap:10px; padding:12px; border-top:1px solid rgba(197,155,255,.2);
      background: #0b0812aa; backdrop-filter: blur(4px);
    }
    textarea{
      flex:1; resize:none; min-height:48px; max-height:160px;
      padding:12px 14px; border-radius:14px; border:1px solid rgba(197,155,255,.3);
      background:#100d19; color:var(--text); outline:none; line-height:1.5;
    }
    button.send{
      border:0; border-radius:14px; padding:0 18px; font-weight:700; color:white;
      background: linear-gradient(135deg,var(--grad1),var(--grad2));
      box-shadow:0 8px 24px rgba(197,155,255,.35);
    }
    button.send[disabled]{opacity:.6; filter:grayscale(30%)}
    .hint{ color:var(--muted); font-size:.85rem; padding: 0 14px 14px }

    /* Petites animations */
    @keyframes dots {
      0%{content:"‚óè  "} 33%{content:"‚óè‚óè "} 66%{content:"‚óè‚óè‚óè"} 100%{content:"‚óè  "}
    }
    .typing::after{
      content:"‚óè  "; animation: dots 1.2s infinite steps(1,end);
      letter-spacing:.2em
    }
  </style>
</head>
<body>
  <header>
    <div class="logo">üèôÔ∏è</div>
    <div>
      <h1>Philom√®ne Soci√©t√©</h1>
      <p class="sub">IA citoyenne & moderne ‚Äî environnement, politique, actualit√©, culture et vie sociale.</p>
    </div>
    <a class="back" href="index.html">‚Üê Retour</a>
  </header>

  <div class="wrap">
    <div class="card" id="chatCard">
      <div class="messages" id="messages">
        <div class="msg ai">
          <div class="avatar">‚ú®</div>
          <div>
            <div class="meta">Soci√©t√©</div>
            <div class="bubble">
Bienvenue üëã  
Je suis <b>Philom√®ne Soci√©t√©</b>. Pose-moi tes questions sur l‚Äôenvironnement, la politique, les enjeux sociaux, l‚Äôactualit√©, le travail, l‚Äô√©ducation, la tech au quotidien‚Ä¶  
Je r√©ponds clairement, sans parti pris, avec des explications et des sources quand c‚Äôest utile.
            </div>
          </div>
        </div>
      </div>

      <div class="composer">
        <textarea id="input" placeholder="√âcris ta question‚Ä¶ (Maj+Entr√©e pour un retour √† la ligne)"></textarea>
        <button id="send" class="send">Envoyer</button>
      </div>
      <div class="hint">Astuce : ‚ÄúExplique-moi simplement‚Ä¶‚Äù, ‚ÄúDonne-moi les arguments pour/contre‚Ä¶‚Äù, ‚ÄúComment agir √† mon √©chelle sur‚Ä¶‚Äù.</div>
    </div>
  </div>

  <script>
    // üëâ IMPORTANT : mets ici l‚ÄôURL de ton backend Render (qui d√©tient la cl√©)
    // Tu as mapp√© le domaine vers le backend : https://philomeneia.com
    const BACKEND_URL = 'https://philomeneia.com';
    // On essaie /chat (comme propos√©) puis /api/chat si besoin
    const PRIMARY_ENDPOINT = '/chat';
    const FALLBACK_ENDPOINT = '/api/chat';

    const messagesEl = document.getElementById('messages');
    const inputEl = document.getElementById('input');
    const sendBtn = document.getElementById('send');

    // Historique local (format OpenAI)
    const history = [
      { role: 'system', content:
        "Tu es Philom√®ne Soci√©t√©, une IA sp√©cialis√©e en soci√©t√©, environnement et actualit√©. " +
        "Style : clair, nuanc√©, accessible, sans parti pris. " +
        "Toujours expliquer les termes, proposer des angles d‚Äôaction et citer des pistes/sources quand c‚Äôest utile. " +
        "Quand un sujet est sensible ou incertain, pr√©cise les limites."
      }
    ];

    function appendMessage(role, text, isTyping=false){
      const msg = document.createElement('div');
      msg.className = 'msg ' + (role === 'assistant' ? 'ai' : 'user');
      msg.innerHTML = `
        <div class="avatar">${role === 'assistant' ? '‚ú®' : 'üôÇ'}</div>
        <div>
          <div class="meta">${role === 'assistant' ? 'Soci√©t√©' : 'Toi'}</div>
          <div class="bubble ${isTyping ? 'typing' : ''}">${text}</div>
        </div>`;
      messagesEl.appendChild(msg);
      messagesEl.scrollTop = messagesEl.scrollHeight;
      return msg.querySelector('.bubble');
    }

    async function callBackend(payload, endpoint){
      const res = await fetch(BACKEND_URL + endpoint, {
        method:'POST',
        headers:{ 'Content-Type':'application/json' },
        body: JSON.stringify(payload),
      });
      if(!res.ok) throw new Error('Erreur serveur: ' + res.status);
      // Supporte renvoi non-stream JSON {reply:"..."} ou texte brut
      const ct = res.headers.get('content-type') || '';
      if (ct.includes('application/json')) {
        const data = await res.json();
        return data.reply || data.content || JSON.stringify(data);
      }
      return await res.text();
    }

    async function sendMessage(){
      const content = inputEl.value.trim();
      if(!content) return;
      sendBtn.disabled = true;

      // Affiche le message user
      appendMessage('user', content);
      history.push({ role:'user', content });

      inputEl.value = '';

      // Bulle de frappe IA
      const typingBubble = appendMessage('assistant', ' ', true);

      const payload = {
        agent: 'societe',        // permet de router c√¥t√© serveur si tu veux des prompts diff√©rents par agent
        messages: history,       // ton backend reformule en requ√™te OpenAI
        // optionnel : temp√©rature, mod√®les, etc.
      };

      try {
        // on tente /chat puis /api/chat si le premier n‚Äôexiste pas
        let reply;
        try {
          reply = await callBackend(payload, PRIMARY_ENDPOINT);
        } catch(e){
          reply = await callBackend(payload, FALLBACK_ENDPOINT);
        }

        typingBubble.classList.remove('typing');
        typingBubble.textContent = reply;
        history.push({ role:'assistant', content: reply });
      } catch (err){
        typingBubble.classList.remove('typing');
        typingBubble.textContent = "Oups, impossible de r√©pondre pour le moment. R√©essaie dans un instant.";
        console.error(err);
      } finally {
        sendBtn.disabled = false;
        inputEl.focus();
      }
    }

    sendBtn.addEventListener('click', sendMessage);
    inputEl.addEventListener('keydown', (e)=>{
      if(e.key === 'Enter' && !e.shiftKey){
        e.preventDefault();
        sendMessage();
      }
    });
  </script>
  <!-- ton HTML principal ici -->
<div class="card">
  <label for="q">Ta question</label>
  <input id="q" placeholder="Ex. : Comment agir pour l‚Äôenvironnement ?" />
  <button id="askBtn">Interroger Philom√®ne</button>
  <div id="answer"></div>
</div>

<!-- üëá ICI tu colles le script -->
<script>
  const BACKEND = "https://philo-backend-cfxz.onrender.com";
  const BOT = "societe"; // üëà change selon la page

  async function ask(question) {
    const res = await fetch(`${BACKEND}/ask/${BOT}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ question })
    });
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const data = await res.json();
    return data.answer || "Je n‚Äôai pas pu r√©pondre.";
  }

  const input = document.getElementById("q");
  const btn = document.getElementById("askBtn");
  const ans = document.getElementById("answer");

  btn.addEventListener("click", async () => {
    const q = input.value.trim();
    if (!q) return;
    btn.disabled = true;
    ans.textContent = "R√©flexion en cours‚Ä¶";
    try {
      ans.textContent = await ask(q);
    } catch (e) {
      console.error(e);
      ans.textContent = "Oups, une erreur s‚Äôest produite. R√©essaie.";
    } finally {
      btn.disabled = false;
    }
  });
</script>
</body>
</html>

<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Philomenia ‚Ä¢ Messenger (style MSN)</title>
<style>
:root{
  --bg:#eaf3ff; --panel:#fff; --text:#0b1b33; --sub:#4b5a73;
  --accent1:#3a84ff; --accent2:#8ec0ff; --input:#fff;
  --bubble-me:#e6f2ff; --bubble-bot:#f0f5ff; --border:#c8d6f2;
  --shadow:0 6px 20px rgba(18,44,96,.15);
}
[data-theme="dark"]{
  --bg:#0f172a; --panel:#0b1222; --text:#e5eeff; --sub:#a9bbda;
  --accent1:#60a5ff; --accent2:#3b82f6; --input:#0f192f;
  --bubble-me:#0f274a; --bubble-bot:#0b1d3a; --border:#1e2c49;
  --shadow:0 10px 24px rgba(0,0,0,.35);
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,-apple-system,Segoe UI,Roboto,Arial}
.app{min-height:100svh;display:flex;flex-direction:column}
.msnbar{position:sticky;top:0;z-index:2;display:flex;gap:8px;align-items:center;padding:10px;background:linear-gradient(#6fb3ff,#3b7dff);color:#fff;box-shadow:var(--shadow)}
.title{font-weight:700}
.spacer{flex:1}
.icon{background:rgba(255,255,255,.25);border:1px solid rgba(255,255,255,.35);border-radius:10px;padding:8px 10px;cursor:pointer}
.chat{flex:1;display:flex;flex-direction:column}
.log{flex:1;overflow:auto;padding:12px;background:var(--panel);border-top:1px solid var(--border);border-bottom:1px solid var(--border)}
.bubble{max-width:88%;white-space:pre-wrap;word-break:break-word;overflow-wrap:anywhere;padding:10px 12px;border:1px solid var(--border);border-radius:12px;box-shadow:0 3px 10px rgba(0,0,0,.05);margin:8px 0;background:var(--bubble-bot)}
.me{background:var(--bubble-me);margin-left:auto}
.meta{color:var(--sub);font-size:12px;margin:2px 4px}
.composer{display:flex;gap:8px;align-items:flex-end;padding:10px;background:var(--panel)}
#input{flex:1;min-height:44px;max-height:160px;resize:none;border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:var(--input);color:var(--text);outline:none}
.actions{display:flex;gap:8px;align-items:center}
button.primary{min-width:110px;border-radius:10px;border:1px solid #2b5cff;color:#fff;background:linear-gradient(#6aa2ff,#2f6fff);padding:10px 14px;cursor:pointer;box-shadow:0 8px 20px rgba(69,120,255,.25);font-weight:700}
input[type=file]{display:none}
label.attach{border:1px solid var(--border);border-radius:10px;padding:10px 12px;background:var(--bubble-bot);color:var(--text);cursor:pointer}
.badge{border:1px solid var(--border);border-radius:999px;padding:4px 8px;background:var(--bubble-bot);color:var(--sub);font-size:12px}
.toolbar{display:flex;gap:8px}
@keyframes nudge{0%,100%{transform:translate(0,0)}10%{transform:translate(-6px,0)}20%{transform:translate(6px,0)}30%{transform:translate(-4px,0)}40%{transform:translate(4px,0)}50%{transform:translate(-3px,0)}60%{transform:translate(3px,0)}70%{transform:translate(-2px,0)}80%{transform:translate(2px,0)}90%{transform:translate(-1px,0)}}
.shake{animation:nudge .6s ease-in-out}
.modal{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;place-items:center;padding:16px;z-index:5}
.modal.on{display:grid}
.card{width:min(760px,96vw);background:var(--panel);color:var(--text);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow);padding:16px}
.plans{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.plan{border:1px solid var(--border);border-radius:12px;padding:12px;background:var(--bubble-me)}
.price{font-weight:700;margin:4px 0 10px}
.row{display:flex;gap:8px}
input.inline{flex:1;padding:10px;border:1px solid var(--border);border-radius:10px;background:var(--input);color:var(--text)}
.btn{border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
.btn.solid{background:var(--accent1);color:#fff}
.hint{color:var(--sub);font-size:12px}
@media (max-width:700px){.plans{grid-template-columns:1fr}}
</style>
<!-- PayPal SDK ‚Äî SANDBOX (A). Pour Live, remplace par l‚ÄôID Live -->
<script src="https://www.paypal.com/sdk/js?client-id=YOUR-PAYPAL-CLIENT-ID&vault=true&intent=subscription&currency=EUR"></script>
</head>
<body>
<div class="app" id="app">
  <div class="msnbar">
    <div class="title">Philomenia Messenger</div>
    <span class="badge" id="quota">Quota: ‚Äî</span>
    <div class="spacer"></div>
    <div class="toolbar">
      <button class="icon" id="btnNews">üì∞</button>
      <button class="icon" id="btnNudge">üí•</button>
      <button class="icon" id="btnDownload">üíæ</button>
      <button class="icon" id="btnPrint">üñ®Ô∏è</button>
      <button class="icon" id="btnTheme">üåô</button>
      <button class="icon" id="btnSub">üí≥</button>
    </div>
  </div>

  <div class="chat" id="chatWin">
    <div class="log" id="log"></div>

    <div class="composer" id="composer">
      <textarea id="input" placeholder="√âcris ton message‚Ä¶ (Entr√©e pour envoyer)" rows="2"></textarea>
      <div class="actions">
        <input type="file" id="file" accept="image/*" />
        <label class="attach" for="file">üìé Joindre</label>
        <button id="send" class="primary">Envoyer</button>
      </div>
    </div>
  </div>
</div>

<!-- Modale Abonnements -->
<div class="modal" id="subModal">
  <div class="card">
    <h3>Abonnement Philomenia</h3>
    <p class="hint">Mini/Pro en mensuel ou annuel. Code promo possible (1 mois gratuit PRO).</p>

    <div class="row" style="margin:6px 0 12px">
      <input id="coupon" class="inline" placeholder="Code promo (ex: PHILO1MOIS)" />
      <button id="applyCoupon" class="btn solid">Activer</button>
      <span id="couponMsg" class="hint"></span>
    </div>

    <div class="plans">
      <div class="plan">
        <h4>Mini</h4>
        <div class="price">1,49 ‚Ç¨/mois</div><div id="pp-mini-m"></div>
        <div class="price">15 ‚Ç¨/an</div><div id="pp-mini-y"></div>
      </div>
      <div class="plan">
        <h4>Pro</h4>
        <div class="price">4,90 ‚Ç¨/mois</div><div id="pp-pro-m"></div>
        <div class="price">50 ‚Ç¨/an</div><div id="pp-pro-y"></div>
      </div>
    </div>

    <div style="text-align:right;margin-top:12px">
      <button class="btn ghost" id="subClose">Fermer</button>
    </div>
  </div>
</div>

<!-- Modale News -->
<div class="modal" id="newsModal">
  <div class="card">
    <h3>Actualit√©s</h3>
    <div class="row" style="margin-bottom:10px">
      <input id="newsQuery" class="inline" placeholder="Sujet (ex: Ligue des Champions, IA‚Ä¶)" />
      <button id="newsGo" class="btn solid">Chercher</button>
    </div>
    <div id="newsList" class="hint">Tape un sujet puis ‚ÄúChercher‚Äù.</div>
    <div style="text-align:right;margin-top:12px">
      <button class="btn ghost" id="newsClose">Fermer</button>
    </div>
  </div>
</div>

<script>
/* ====== CONFIG ====== */
const BACKEND_URL = "https://philo-backend-su29.onrender.com"; // <- mets ton URL backend
// PayPal plan IDs (mets les tiens)
const PLAN_MINI_MOIS = "P-XXXXMINIMONTH";
const PLAN_MINI_AN   = "P-XXXXMINIYEAR";
const PLAN_PRO_MOIS  = "P-XXXXPROMONTH";
const PLAN_PRO_AN    = "P-XXXXPROYEAR";

/* ====== STATE ====== */
const $ = s => document.querySelector(s);
const app = $("#app"), log = $("#log"), input = $("#input"), send = $("#send");
const file = $("#file"), quotaEl = $("#quota");
const btnTheme=$("#btnTheme"), btnPrint=$("#btnPrint"), btnDownload=$("#btnDownload");
const btnNudge=$("#btnNudge"), chatWin=$("#chatWin");
const btnSub=$("#btnSub"), subModal=$("#subModal"), subClose=$("#subClose");
const coupon=$("#coupon"), applyCoupon=$("#applyCoupon"), couponMsg=$("#couponMsg");
const btnNews=$("#btnNews"), newsModal=$("#newsModal"), newsClose=$("#newsClose");
const newsQuery=$("#newsQuery"), newsGo=$("#newsGo");
let imageData = ""; // dataURL si pi√®ce jointe
let theme = localStorage.getItem("theme") || "light";
document.documentElement.setAttribute("data-theme", theme);

// clientId persistant (pour quota serveur)
let cid = localStorage.getItem("philo.cid");
if(!cid){ cid = (crypto.randomUUID ? crypto.randomUUID() : String(Date.now())+Math.random()); localStorage.setItem("philo.cid", cid); }

// abonnement local (juste indicatif c√¥t√© front)
function currentTier(){
  const sub = JSON.parse(localStorage.getItem("philo.sub") || "{}");
  // sub.plan = "Mini Mensuel" / "Pro Annuel" / etc.
  if((sub.plan||"").toLowerCase().includes("pro")) return "pro";
  if((sub.plan||"").toLowerCase().includes("mini")) return "mini";
  return "free";
}
function currentToken(){
  return localStorage.getItem("philo.token") || "";
}

/* ====== UI HELPERS ====== */
function addBubble(text, me=false){
  const b = document.createElement("div");
  b.className = "bubble" + (me ? " me" : "");
  b.innerHTML = text.replace(/\n/g,"<br>");
  log.appendChild(b);
  log.scrollTop = log.scrollHeight;
}
function setQuota(q){
  if(!q) { quotaEl.textContent = "Quota: ‚Äî"; return; }
  quotaEl.textContent = `Quota: ${q.percent}% restants`;
}

/* ====== SOUNDS & NUDGE ====== */
function beep(freq=880, dur=0.08){
  try{
    const ac = new (window.AudioContext||window.webkitAudioContext)();
    const o = ac.createOscillator(), g = ac.createGain();
    o.type="triangle"; o.frequency.value=freq;
    o.connect(g); g.connect(ac.destination);
    g.gain.setValueAtTime(0.0001, ac.currentTime);
    g.gain.exponentialRampToValueAtTime(0.2, ac.currentTime + 0.02);
    o.start();
    setTimeout(()=>{ g.gain.exponentialRampToValueAtTime(0.0001, ac.currentTime + 0.02); o.stop(); }, dur*1000);
  }catch(_){}
}
btnNudge.addEventListener("click", ()=>{
  app.classList.add("shake"); setTimeout(()=>app.classList.remove("shake"), 650);
  beep(440,0.1); setTimeout(()=>beep(660,0.1),120);
});

/* ====== THEME / PRINT / DOWNLOAD ====== */
btnTheme.onclick = ()=>{
  theme = (theme==="light" ? "dark":"light");
  document.documentElement.setAttribute("data-theme", theme);
  localStorage.setItem("theme", theme);
};
btnPrint.onclick = ()=>window.print();
btnDownload.onclick = ()=>{
  const text = [...log.querySelectorAll(".bubble")].map(x=>x.innerText).join("\n\n");
  const blob = new Blob([text], {type:"text/plain;charset=utf-8"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = "conversation-"+Date.now()+".txt";
  a.click();
  URL.revokeObjectURL(a.href);
};

/* ====== FILE ATTACH ====== */
file.addEventListener("change", ()=>{
  const f = file.files[0];
  if(!f) return;
  const reader = new FileReader();
  reader.onload = e => { imageData = e.target.result; addBubble("üìé Image jointe ajout√©e (sera envoy√©e avec le prochain message)"); };
  reader.readAsDataURL(f);
});

/* ====== NEWS ====== */
btnNews.onclick = ()=> newsModal.classList.add("on");
newsClose.onclick = ()=> newsModal.classList.remove("on");
newsGo.onclick = async ()=>{
  const q = newsQuery.value.trim(); if(!q) return;
  $("#newsList").textContent = "Chargement‚Ä¶";
  try{
    const r = await fetch(`${BACKEND_URL}/api/news?q=`+encodeURIComponent(q));
    const d = await r.json();
    if(!Array.isArray(d.results) || d.results.length===0){
      $("#newsList").textContent = "Aucun r√©sultat.";
      return;
    }
    $("#newsList").innerHTML = d.results.map(n => `
      <div class="bubble">
        <strong>${n.title || "Sans titre"}</strong><br>
        <span class="meta">${n.source||""} ‚Äî ${n.date||""}</span><br>
        <a href="${n.link}" target="_blank" rel="noopener">Ouvrir</a>
      </div>
    `).join("");
  }catch(e){
    $("#newsList").textContent = "Erreur.";
  }
};

/* ====== SUBSCRIPTIONS (PayPal) & COUPON ====== */
btnSub.onclick = ()=> subModal.classList.add("on");
subClose.onclick = ()=> subModal.classList.remove("on");

applyCoupon.onclick = async ()=>{
  couponMsg.textContent = "V√©rification‚Ä¶";
  try{
    const r = await fetch(`${BACKEND_URL}/api/coupon/redeem`, {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({ code: coupon.value.trim() })
    });
    const d = await r.json();
    if(!r.ok || !d.ok){ couponMsg.textContent = d.error || "Code invalide."; return; }
    localStorage.setItem("philo.token", d.token);
    localStorage.setItem("philo.sub", JSON.stringify({ plan:"Pro (coupon)", expiresAt:d.expiresAt }));
    couponMsg.textContent = "‚úÖ 1 mois PRO activ√© !";
    updateQuota();
  }catch(_){ couponMsg.textContent = "Erreur r√©seau."; }
};

// rendu des 4 boutons PayPal
function renderPayPal(target, planId, label){
  if(!window.paypal){ console.warn("PayPal SDK absent"); return; }
  paypal.Buttons({
    style:{ layout:'vertical', color:'blue', shape:'pill', label:'subscribe' },
    createSubscription: (data, actions) => actions.subscription.create({ plan_id: planId }),
    onApprove: (data) => {
      localStorage.setItem("philo.sub", JSON.stringify({ plan: label, subId: data.subscriptionID }));
      alert("Merci ! Abonnement "+label+" activ√©.");
      subModal.classList.remove("on");
      updateQuota();
    }
  }).render("#"+target);
}
renderPayPal("pp-mini-m", PLAN_MINI_MOIS, "Mini Mensuel");
renderPayPal("pp-mini-y", PLAN_MINI_AN,   "Mini Annuel");
renderPayPal("pp-pro-m",  PLAN_PRO_MOIS,  "Pro Mensuel");
renderPayPal("pp-pro-y",  PLAN_PRO_AN,    "Pro Annuel");

/* ====== QUOTA ====== */
async function updateQuota(){
  try{
    const r = await fetch(`${BACKEND_URL}/api/quota`, {
      headers:{
        "x-client-id": cid,
        "x-tier": currentTier(),
        ...(currentToken()? { "Authorization":"Bearer "+currentToken() } : {})
      }
    });
    const d = await r.json();
    if(d && typeof d.percent === "number"){ setQuota(d); }
  }catch(_){ quotaEl.textContent = "Quota: ‚Äî"; }
}
updateQuota();

/* ====== SEND ====== */
async function sendMessage(){
  const text = input.value.trim(); if(!text && !imageData) return;
  addBubble(text || "(image)", true);
  input.value = "";

  try{
    const r = await fetch(`${BACKEND_URL}/api/chat`, {
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-client-id": cid,
        "x-tier": currentTier(),
        ...(currentToken()? { "Authorization":"Bearer "+currentToken() } : {})
      },
      body: JSON.stringify({ message: text, image: imageData })
    });
    const d = await r.json();
    if(!r.ok){ addBubble("‚ùå "+(d.error||"Erreur")); return; }
    addBubble(d.reply || "‚Ä¶");
    updateQuota();
  }catch(e){
    addBubble("‚ùå Erreur de connexion.");
  }finally{
    imageData = ""; // consomme la pi√®ce jointe une fois
  }
}
send.onclick = sendMessage;
input.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }});

// message d‚Äôaccueil
addBubble("Bonjour üëã\nTu peux chatter, joindre une image, voir les actus (üì∞) et t‚Äôabonner (üí≥).");

/* ====== iPhone UX : √©viter les sauts quand le clavier s‚Äôouvre ====== */
const composer = document.getElementById("composer");
function lockHeight(){ composer.style.position="sticky"; composer.style.bottom="env(safe-area-inset-bottom)"; }
lockHeight();
</script>
</body>
</html>

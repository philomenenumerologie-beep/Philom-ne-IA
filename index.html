<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover">
  <title>Philom√®ne I.A.</title>

  <style>
    :root{
      --bg:#0e0e12;
      --panel:#16161d;
      --panel-2:#1d1d27;
      --text:#f3f3f7;
      --text-dim:#b8b8c7;
      --accent:#a784ff;
      --accent-2:#6f5bd6;
      --chip:#262636;
      --ok:#2ecc71;
      --danger:#ff5d73;
      --shadow:0 8px 24px rgba(0,0,0,.35);
      --radius:14px;
      --safe-b: env(safe-area-inset-bottom, 0px);
      --safe-t: env(safe-area-inset-top, 0px);
    }
    .light{
      --bg:#fafafa;
      --panel:#ffffff;
      --panel-2:#f3f3f7;
      --text:#101015;
      --text-dim:#4b4b55;
      --accent:#7b61ff;
      --accent-2:#5b49d6;
      --chip:#e9e9f5;
      --shadow:0 10px 26px rgba(13,11,60,.10);
    }

    *{box-sizing:border-box}
    html,body{height:100%; background:var(--bg); color:var(--text); margin:0}
    body{font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Inter, Arial, sans-serif;}

    /* Layout */
    .app{
      height:100dvh; /* stable avec clavier mobile */
      display:grid;
      grid-template-rows: auto 1fr auto;
    }

    /* Header */
    .header{
      position:sticky; top:0; z-index:20;
      background:var(--bg);
      padding: calc(10px + var(--safe-t)) 14px 10px;
      display:flex; align-items:center; gap:10px; justify-content:space-between;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .brand{display:flex; align-items:center; gap:10px; font-weight:700; font-size:20px}
    .heart{filter: drop-shadow(0 2px 8px rgba(0,0,0,.25))}
    .row{display:flex; align-items:center; gap:10px}
    .chip{
      background:var(--chip); color:var(--text);
      border-radius:12px; padding:8px 10px; display:flex; align-items:center; gap:8px;
      box-shadow: var(--shadow);
    }
    .btn{
      background:var(--chip);
      border:none; color:var(--text);
      border-radius:12px; padding:10px 12px; display:inline-flex; align-items:center; justify-content:center;
      font-size:16px;
    }
    .btn:active{transform:scale(.98)}

    .menu{position:relative}
    .menu .sheet{
      position:absolute; right:0; top:48px; width:220px;
      background:var(--panel); border:1px solid rgba(255,255,255,.08);
      border-radius:14px; box-shadow:var(--shadow); display:none;
      overflow:hidden;
    }
    .menu.open .sheet{display:block}
    .sheet button{
      width:100%; background:transparent; border:none; color:var(--text);
      text-align:left; padding:12px 14px; font-size:15px;
    }
    .sheet button+button{border-top:1px solid rgba(255,255,255,.06)}

    /* Chat */
    .chat{
      padding:14px; padding-bottom: 8px;
      overflow:auto;
    }
    .bubble{
      max-width:86vw;
      background:var(--panel);
      border:1px solid rgba(255,255,255,.06);
      margin:10px 0; padding:12px 14px; border-radius:16px; line-height:1.4;
      box-shadow: var(--shadow);
    }
    .me{background:#6a4ff1; border-color:#6a4ff1; color:white; margin-left:auto}

    /* Footer / input */
    .composer{
      position:sticky; bottom:0; z-index:15;
      background: linear-gradient(180deg, transparent, var(--bg) 18%);
      padding: 10px 10px calc(10px + var(--safe-b));
    }
    .bar{
      display:flex; align-items:center; gap:8px;
      background:var(--panel-2);
      border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:8px; box-shadow:var(--shadow);
    }
    .plus{width:40px; height:40px; border-radius:12px; font-size:20px}
    .input{
      flex:1; background:transparent; border:none; color:var(--text);
      font-size:16px; outline:none; padding:10px 8px;
    }
    .send{width:48px; height:40px; border-radius:12px; font-weight:700; background:#4a3ed6}
    .send:disabled{opacity:.5}

    /* Drawer vertical */
    .drawer{
      position:absolute; right:64px; bottom: calc(72px + var(--safe-b)); /* juste au-dessus de la barre */
      display:flex; flex-direction:column; gap:8px; align-items:center;
      transition:.2s ease; opacity:0; pointer-events:none; transform: translateY(8px);
    }
    .drawer.open{opacity:1; pointer-events:auto; transform: translateY(0)}
    .tool{
      width:44px; height:44px; border-radius:14px; border:1px solid rgba(255,255,255,.08);
      background:var(--panel); display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow)
    }

    /* FAQ modal */
    .modal{
      position:fixed; inset:0; display:none; align-items:center; justify-content:center; z-index:50;
      background:rgba(0,0,0,.45);
      padding:20px;
    }
    .modal.open{display:flex}
    .card{
      width:min(680px, 96vw);
      background:var(--panel); border:1px solid rgba(255,255,255,.08);
      border-radius:16px; padding:18px; color:var(--text); box-shadow:var(--shadow);
    }
    .card h2{margin:0 0 6px; font-size:22px; color:var(--accent)}
    .card h3{margin:14px 0 6px; font-size:18px}
    .close-x{float:right; background:transparent; border:none; color:var(--text); font-size:22px}

    /* ‚ÄúPropuls√© par‚Äù */
    .powered{
      text-align:center; color:var(--text-dim); font-size:14px; padding:6px 0 6px;
    }
    .powered b{color:var(--accent)}

    /* Evite les sauts quand le clavier mobile s‚Äôouvre */
    @supports (height: 100svh){
      .app{height:100svh}
    }
  </style>
</head>
<body class="">
  <div class="app">

    <!-- HEADER -->
    <div class="header">
      <div class="brand">
        <span class="heart">ü§ç</span>
        <span>Philom√®ne I.A.</span>
      </div>

      <div class="row">
        <button id="modeBtn" class="btn chip" title="Jour/Nuit">üåó</button>

        <div class="chip" id="wallet" title="Solde de tokens">
          üíé <span id="tokenDigits">1 000 000</span>
        </div>

        <div class="menu">
          <button id="menuBtn" class="btn">‚â°</button>
          <div class="sheet" id="menuSheet">
            <button id="openFaq">‚ùì FAQ</button>
            <button id="newChat">üîÑ Nouvelle discussion</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CHAT -->
    <div id="chat" class="chat" aria-live="polite">
      <div class="bubble">
        Bonjour üëã Je suis Philom√®ne I.A., propuls√©e par <b>GPT-5 Thinking</b>.
      </div>
    </div>

    <!-- COMPOSER -->
    <div class="composer">
      <div class="bar">
        <button id="plusBtn" class="btn plus" aria-expanded="false">Ôºã</button>
        <input id="msg" class="input" placeholder="√âcrivez votre message‚Ä¶" autocomplete="off" />
        <button id="sendBtn" class="btn send">‚û§</button>
      </div>

      <!-- Drawer vertical -->
      <div id="drawer" class="drawer">
        <button class="tool" id="micBtn" title="Micro üé§">üé§</button>
        <button class="tool" id="camBtn" title="Photo üì∑">üì∑</button>
        <button class="tool" id="docBtn" title="Document üìÑ">üìÑ</button>
      </div>

      <div class="powered">Propuls√© par <b>GPT-5 Thinking</b></div>
    </div>
  </div>

  <!-- FAQ MODAL -->
  <div id="faqModal" class="modal" role="dialog" aria-modal="true" aria-labelledby="faqTitle">
    <div class="card">
      <button class="close-x" id="faqClose">‚úï</button>
      <h2 id="faqTitle">üí¨ Foire aux questions</h2>

      <h3>Quelle IA utilise Philom√®ne ?</h3>
      <p>Philom√®ne I.A. est propuls√©e par <b>GPT-5 Thinking</b>, la version la plus avanc√©e d‚ÄôOpenAI.</p>

      <h3>Comment fonctionnent les tokens ?</h3>
      <p>Chaque question et chaque r√©ponse consomment un petit nombre de tokens (selon la longueur).
        Le diamant üíé affiche votre <b>solde</b>.</p>

      <h3>Packs disponibles</h3>
      <p>üíé 1 000 000 tokens ‚Üí 5 ‚Ç¨<br>
         üíé 2 000 000 tokens ‚Üí 10 ‚Ç¨<br>
         üíé 4 000 000 tokens ‚Üí 20 ‚Ç¨</p>
      <p>üéÅ <b>Premier achat : +50 % offerts</b> (1,5 M ‚Äì 3 M ‚Äì 6 M).</p>

      <h3>Abonnement ?</h3>
      <p>Aucun abonnement. Toute la puissance de GPT-5 : vous payez uniquement ce que vous consommez.</p>

      <h3>Confidentialit√©</h3>
      <p>Vos √©changes restent priv√©s et ne sont pas utilis√©s √† d‚Äôautres fins.</p>
    </div>
  </div>

  <script>
    /********** CONFIG **********/
    const API_URL = "https://api.philomeneia.com/ask"; // ton backend Render/proxy
    const GUEST_START = 1_000_000;                      // affichage de d√©part si aucun compte
    const USER_ID = "guest";                            // √† remplacer si tu branches l‚Äôauth

    /********** ETAT **********/
    let tokenBalance = GUEST_START;
    const chat = document.getElementById('chat');
    const msg  = document.getElementById('msg');
    const send = document.getElementById('sendBtn');
    const plus = document.getElementById('plusBtn');
    const drawer = document.getElementById('drawer');
    const tokenDigits = document.getElementById('tokenDigits');

    // M√©moire locale d‚Äôaffichage (la vraie m√©moire est c√¥t√© serveur)
    let conversation = [];

    /********** UTIL **********/
    const fmt = n => n.toLocaleString('fr-FR');

    function addBubble(text, mine=false){
      const b = document.createElement('div');
      b.className = 'bubble' + (mine ? ' me' : '');
      b.innerHTML = text.replace(/\n/g,'<br>');
      chat.appendChild(b);
      chat.scrollTop = chat.scrollHeight;
    }

    function setTokens(n){
      tokenBalance = Math.max(0, n);
      tokenDigits.textContent = fmt(tokenBalance);
    }

    // Th√®me
    const modeBtn = document.getElementById('modeBtn');
    modeBtn.addEventListener('click', ()=>{
      document.body.classList.toggle('light');
    });

    // Menu
    const menu = document.querySelector('.menu');
    document.getElementById('menuBtn').addEventListener('click', ()=>{
      menu.classList.toggle('open');
    });
    document.addEventListener('click',(e)=>{
      if(!menu.contains(e.target)) menu.classList.remove('open');
    });

    // FAQ
    const faqModal = document.getElementById('faqModal');
    document.getElementById('openFaq').addEventListener('click', ()=>{
      faqModal.classList.add('open'); menu.classList.remove('open');
    });
    document.getElementById('faqClose').addEventListener('click', ()=> faqModal.classList.remove('open'));
    faqModal.addEventListener('click', (e)=>{ if(e.target===faqModal) faqModal.classList.remove('open'); });

    // Nouvelle discussion (reset affichage)
    document.getElementById('newChat').addEventListener('click', ()=>{
      conversation = [];
      chat.innerHTML = '';
      addBubble("Bonjour üëã Nouvelle discussion. Comment puis-je vous aider aujourd‚Äôhui ?");
      menu.classList.remove('open');
    });

    // Plus / Drawer
    plus.addEventListener('click', ()=>{
      const open = drawer.classList.toggle('open');
      plus.textContent = open ? '‚àí' : 'Ôºã';
      plus.setAttribute('aria-expanded', open ? 'true' : 'false');
    });

    // Outils (stubs √† brancher)
    document.getElementById('micBtn').addEventListener('click', ()=> alert('üé§ Dict√©e vocale : √† activer'));
    document.getElementById('camBtn').addEventListener('click', ()=> alert('üì∑ Envoi photo : √† activer'));
    document.getElementById('docBtn').addEventListener('click', ()=> alert('üìÑ Envoi document : √† activer'));

    // Envoi
    async function sendMsg(){
      const text = msg.value.trim();
      if(!text) return;
      addBubble(text, true);
      msg.value = '';
      send.disabled = true;

      // On n‚Äôenvoie au serveur que l‚ÄôID user + la derni√®re phrase (la m√©moire est c√¥t√© serveur)
      try{
        const payload = {
          conversation: [{role:'user', content:text}],
          userId: USER_ID
        };
        const r = await fetch(API_URL, {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify(payload)
        });

        if(!r.ok){
          const t = await r.text();
          console.error('Erreur API', r.status, t);
          addBubble("D√©sol√©e, j‚Äôai eu un petit souci r√©seau. R√©essaie.");
          return;
        }

        const data = await r.json();
        addBubble(data.answer || "‚Ä¶");

        // Mise √† jour VRAIE si le backend renvoie tokensLeft
        if(typeof data.tokensLeft === 'number'){
          setTokens(data.tokensLeft);
        }

      }catch(e){
        console.error(e);
        addBubble("Oups, connexion interrompue.");
      }finally{
        send.disabled = false;
        chat.scrollTop = chat.scrollHeight;
      }
    }

    send.addEventListener('click', sendMsg);
    msg.addEventListener('keydown', (e)=>{ if(e.key==='Enter' && !e.shiftKey){ e.preventDefault(); sendMsg(); } });

    // Anti ‚Äúsauts‚Äù quand le clavier iOS/Android s‚Äôouvre
    if(window.visualViewport){
      const fix = ()=>{
        document.documentElement.style.setProperty('--safe-b', `calc(env(safe-area-inset-bottom, 0px) + ${Math.max(0,(window.innerHeight - visualViewport.height))}px)`);
      };
      visualViewport.addEventListener('resize', fix);
      visualViewport.addEventListener('scroll', fix);
      fix();
    }

    // Init
    setTokens(tokenBalance);
  </script>
</body>
</html>

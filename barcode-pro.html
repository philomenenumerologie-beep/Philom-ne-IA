<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Scanner Pro (ZXing) üì∑</title>

  <script src="https://unpkg.com/@zxing/browser@latest"></script>

  <style>
    body { background:#020814; color:#fff; font-family:system-ui; padding:20px; }
    h1 { font-size:24px; }
    video { width:100%; max-width:650px; border-radius:16px; background:#000; }
    #status { margin-top:10px; padding:10px; border-radius:8px; }
    .ok { background:#065f46; color:#bbf7d0; }
    .err { background:#7f1d1d; color:#fee2e2; }
    button {
      padding:14px; border-radius:999px; margin:10px 5px; border:none;
      font-size:16px; font-weight:600;
    }
    #start { background:#22c55e; color:#020817; }
    #stop { background:#111827; color:#e5e7eb; }
    #result { margin-top:12px; font-size:16px; }
    #code { color:#22c55e; font-size:18px; font-weight:700; }
  </style>
</head>
<body>

<h1>Scanner Pro (ZXing) üì∑</h1>
<p>Scanner nouvelle g√©n√©ration bas√© sur ZXing. Fiable & rapide sur iPhone.</p>

<video id="video" autoplay playsinline></video>

<div id="status" class="err">En attente‚Ä¶</div>

<button id="start">D√©marrer</button>
<button id="stop">Arr√™ter</button>

<div id="result">
  <span>Aucun produit scann√© pour le moment.</span><br>
  <span id="code"></span>
</div>

<script>
  const video = document.getElementById("video");
  const status = document.getElementById("status");
  const result = document.getElementById("result");
  const codeSpan = document.getElementById("code");

  let controls = null;

  function setStatus(msg, ok = false) {
    status.textContent = msg;
    status.className = ok ? "ok" : "err";
  }

  async function startScan() {
    try {
      const codeReader = new ZXingBrowser.BrowserMultiFormatReader();

      controls = await ZXingBrowser.BrowserMultiFormatReader.decodeFromVideoDevice(
        undefined, // cam√©ra arri√®re
        video,
        (result, err) => {
          if (result) {
            const code = result.text;
            setStatus("Code d√©tect√© : " + code, true);
            codeSpan.textContent = code;
            searchProduct(code);
          }
        }
      );

      setStatus("üì∑ Scanner actif. Scanne un code-barres.", true);
    } catch (e) {
      setStatus("‚ùå Impossible de d√©marrer la cam√©ra.", false);
      console.error(e);
    }
  }

  function stopScan() {
    if (controls) controls.stop();
    setStatus("‚èπÔ∏è Scan arr√™t√©.");
  }

  async function searchProduct(code) {
    try {
      const resp = await fetch("https://api.philomeneia.com/barcode?code=" + code);
      if (!resp.ok) {
        result.innerHTML = "Code OK mais erreur API.<br><span id='code'>" + code + "</span>";
        return;
      }

      const data = await resp.json();
      if (!data.found) {
        result.innerHTML = "Produit non trouv√©.<br><span id='code'>" + code + "</span>";
        return;
      }

      // Produit trouv√©
      result.innerHTML =
        `${data.name || ""} ‚Ä¢ ${data.brand || ""} ‚Ä¢ ${data.quantity || ""}` +
        `<br>NutriScore : ${data.nutriscore || "?"} ‚Ä¢ Nova : ${data.nova || "?"}<br>` +
        `<span id='code'>${code}</span>`;
    } catch (e) {
      result.innerHTML = "Erreur API.<br><span id='code'>" + code + "</span>";
    }
  }

  document.getElementById("start").onclick = startScan;
  document.getElementById("stop").onclick = stopScan;
</script>

</body>
</html>

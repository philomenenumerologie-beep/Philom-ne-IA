<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>PhilomÃ¨ne I.A.</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='.9em' font-size='90'%3EğŸ”®%3C/text%3E%3C/svg%3E">
<style>
/* ===== Reset ultra lÃ©ger ===== */
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0b0b0e;
  --fg:#e9e9f1;
  --muted:#b7b7c7;
  --card:#13131a;
  --accent:#7a43ff;
  --accent-2:#9f7fff;
  --line:#2a2540;
  --ok:#2ecc71;
  --warn:#ffcc00;
}
.light{
  --bg:#ffffff;
  --fg:#111218;
  --muted:#535566;
  --card:#f4f5f8;
  --accent:#6a3cff;
  --accent-2:#a289ff;
  --line:#dedee9;
}

/* ===== Layout ===== */
html,body{height:100%;background:var(--bg);color:var(--fg);font:16px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif}
.container{display:flex;flex-direction:column;height:100%}
.header{position:sticky;top:0;z-index:5;background:linear-gradient(0deg, transparent, rgba(0,0,0,.35)) , var(--bg);border-bottom:1px solid var(--line)}
.head-row{display:flex;align-items:center;gap:.6rem;padding:.9rem .95rem}
.brand-dot{width:.7rem;height:.7rem;background:#7d4dff;border-radius:50%;box-shadow:0 0 8px #7d4dff}
.title{font-weight:700;letter-spacing:.2px;margin-right:auto}
.head-btn{appearance:none;border:1px solid var(--line);background:var(--card);color:var(--fg);padding:.45rem .75rem;border-radius:.75rem;font-weight:600}
.moon{font-size:1.1rem;cursor:pointer;user-select:none;margin-left:.25rem}
.diamond{display:flex;align-items:center;gap:.35rem;font-weight:800;color:var(--accent-2);text-shadow:0 0 12px rgba(122,67,255,.35)}
.burger{font-size:1.4rem;line-height:1;cursor:pointer}

/* sous-entÃªte version */
.subhead{display:flex;align-items:center;gap:.5rem;padding:.35rem .95rem .6rem;border-bottom:1px solid var(--line);color:var(--muted);font-size:.9rem}
.subhead small{opacity:.9}

/* chat */
.chat{flex:1;overflow:auto;padding:1rem .95rem 7.5rem}
.msg{max-width:80%;background:var(--card);padding:.85rem 1rem;border-radius:1rem;margin:.35rem 0;box-shadow:0 2px 12px rgba(0,0,0,.12)}
.me{margin-left:auto;background:transparent;border:1px solid var(--line)}
.system{width:fit-content;color:var(--muted);font-size:.9rem;background:transparent}

/* input bar */
.input-wrap{position:fixed;left:0;right:0;bottom:0;background:var(--bg);border-top:1px solid var(--line)}
.input-row{display:flex;align-items:center;gap:.6rem;padding:.6rem .8rem}
.plus{width:36px;height:36px;border-radius:.8rem;border:1px solid var(--line);background:var(--card);font-weight:700}
.input{flex:1;display:flex;align-items:center;background:var(--card);border:1px solid var(--line);border-radius:1rem}
.input input{flex:1;background:transparent;border:0;color:var(--fg);padding:.8rem 1rem;font-size:1rem}
.icon-btn{border:0;background:transparent;font-size:1.15rem;opacity:.85;cursor:pointer;padding:.5rem .6rem}
.send{background:var(--accent);border:0;color:white;border-radius:.9rem;padding:.6rem .8rem;font-weight:800}

/* action sheet (plus) */
.sheet-bg{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:blur(2px);display:none}
.sheet{position:fixed;left:0;right:0;bottom:0;background:var(--card);border-top:1px solid var(--line);border-radius:1rem 1rem 0 0;padding:1rem .9rem;display:none}
.sheet h4{margin:.2rem 0 .7rem}
.sheet-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:.6rem}
.sheet-btn{display:flex;flex-direction:column;align-items:center;gap:.35rem;border:1px solid var(--line);background:transparent;border-radius:.8rem;padding:.75rem .5rem}
.sheet-btn span{font-size:.9rem;color:var(--muted)}

/* modales */
.modal-bg{position:fixed;inset:0;background:rgba(0,0,0,.45);display:none;z-index:20}
.modal{position:fixed;inset:auto .8rem 1rem .8rem;background:var(--card);border:1px solid var(--line);border-radius:1rem;padding:1rem;display:none;max-height:70vh;overflow:auto}
.modal h3{margin-bottom:.6rem}
.close-x{float:right;cursor:pointer;font-weight:800}

/* badge pied */
.power{padding:.6rem .95rem;border-top:1px dashed var(--line);color:var(--muted);font-size:.9rem}
.power b{color:var(--accent-2)}

/* helper */
.hidden{display:none !important}
.hr{height:1px;background:var(--line);margin:.6rem 0}
.small{font-size:.9rem;color:var(--muted)}
</style>
</head>
<body>
<div class="container">

  <!-- ===== HEADER ===== -->
  <header class="header">
    <div class="head-row">
      <span class="brand-dot"></span>
      <div class="title">PhilomÃ¨ne I.A.</div>

      <button id="btnLogin" class="head-btn">Connexion</button>
      <button id="btnBuy" class="head-btn">Acheter</button>

      <div id="toggleMode" class="moon" title="Jour/Nuit">ğŸŒ™</div>
      <div class="diamond" title="Solde tokens">
        ğŸ’ <span id="tokenCount">1000000</span>
      </div>
      <div id="btnMenu" class="burger" title="Menu">â˜°</div>
    </div>

    <!-- sous-ligne version -->
    <div class="subhead">
      <small>ğŸ”® PhilomÃ¨ne I.A. â€” <b>version 1.0</b></small>
    </div>
  </header>

  <!-- ===== MESSAGES ===== -->
  <main id="chat" class="chat">
    <div class="msg system">Nouvelle discussion commencÃ©e.</div>
    <div class="msg">Bonjour ğŸ‘‹ Je suis PhilomÃ¨ne I.A., propulsÃ©e par GPT-5 Thinking.</div>
  </main>

  <!-- ===== INPUT BAR ===== -->
  <footer class="input-wrap">
    <div class="input-row">
      <button id="plusBtn" class="plus">+</button>

      <div class="input">
        <input id="userInput" placeholder="Ã‰crivez votre messageâ€¦" autocomplete="off" />
        <button id="micBtn" class="icon-btn" title="Parler ğŸ¤">ğŸ¤</button>
        <button id="photoBtn" class="icon-btn" title="Envoyer une image ğŸ“·">ğŸ“·</button>
        <button id="docBtn" class="icon-btn" title="Envoyer un fichier ğŸ“„">ğŸ“„</button>
      </div>

      <button id="sendBtn" class="send">â¤</button>
    </div>

    <div class="power small">
      PropulsÃ© par <b>GPT-5 Thinking</b> â€” la version la plus avancÃ©e de PhilomÃ¨ne I.A.
    </div>
  </footer>
</div>

<!-- ===== HIDDEN PICKERS ===== -->
<input id="imgLibPicker" type="file" accept="image/*" class="hidden">
<input id="imgCamPicker" type="file" accept="image/*" capture="environment" class="hidden">
<input id="docPicker" type="file" class="hidden" accept=".pdf,.txt,.md,.doc,.docx,image/*">

<!-- ===== ACTION SHEET ===== -->
<div id="sheetBg" class="sheet-bg"></div>
<div id="sheet" class="sheet">
  <h4>Ajouterâ€¦</h4>
  <div class="sheet-grid">
    <button id="takePhoto" class="sheet-btn">ğŸ“·<span>Prendre une photo</span></button>
    <button id="pickPhoto" class="sheet-btn">ğŸ–¼ï¸<span>Depuis la galerie</span></button>
    <button id="pickFile"  class="sheet-btn">ğŸ“„<span>Choisir un fichier</span></button>
  </div>
</div>

<!-- ===== MODALES ===== -->
<div id="modalBg" class="modal-bg"></div>

<div id="faq" class="modal">
  <div class="close-x" data-close="faq">âœ•</div>
  <h3>ğŸ’¬ Foire aux questions</h3>
  <div class="hr"></div>
  <p><b>Quelle IA utilise PhilomÃ¨ne ?</b><br>
  PhilomÃ¨ne I.A. est propulsÃ©e par <b>GPT-5 Thinking</b>, la version la plus avancÃ©e.</p>
  <p class="hr"></p>
  <p><b>Comment fonctionnent les tokens ?</b><br>
  Chaque question + rÃ©ponse consomment quelques tokens selon leur longueur. Le diamant ğŸ’ affiche ton solde.</p>
  <p class="hr"></p>
  <p><b>Packs disponibles</b></p>
  <ul class="small" style="margin:.35rem 0 0 1rem;line-height:1.7">
    <li>ğŸ’ 1 000 000 tokens â†’ 5 â‚¬</li>
    <li>ğŸ’ 2 000 000 tokens â†’ 10 â‚¬</li>
    <li>ğŸ’ 4 000 000 tokens â†’ 20 â‚¬</li>
  </ul>
  <p class="small" style="margin-top:.4rem">ğŸ Premier achat : <b>+50%</b> offerts.</p>
</div>

<div id="buy" class="modal">
  <div class="close-x" data-close="buy">âœ•</div>
  <h3>ğŸ’ Acheter des tokens</h3>
  <div class="hr"></div>
  <p class="small">Paiement Ã  venir (PayPal/Stripe). SÃ©lectionne un pack :</p>
  <div class="hr"></div>
  <button class="head-btn" style="width:100%;margin:.25rem 0">ğŸ’ 1 000 000 â€” 5 â‚¬</button>
  <button class="head-btn" style="width:100%;margin:.25rem 0">ğŸ’ 2 000 000 â€” 10 â‚¬</button>
  <button class="head-btn" style="width:100%;margin:.25rem 0">ğŸ’ 4 000 000 â€” 20 â‚¬</button>
  <p class="small" style="margin-top:.5rem">ğŸ +50% sur le 1er achat</p>
</div>

<div id="login" class="modal">
  <div class="close-x" data-close="login">âœ•</div>
  <h3>ğŸ” Connexion</h3>
  <div class="hr"></div>
  <p class="small">Clerk arrivera ici. Pour lâ€™instant, entre un pseudo :</p>
  <input id="pseudoInput" class="head-btn" style="width:100%;margin-top:.5rem" placeholder="Pseudoâ€¦" />
  <button id="savePseudo" class="head-btn" style="width:100%;margin-top:.5rem">Valider</button>
</div>

<script>
(() => {
  // ===== CONFIG =====
  const API_URL = "https://api.philomeneia.com/ask";
  const API_IMG = "https://api.philomeneia.com/analyze-image";

  let tokenCount = 1_000_000; // visible compteur
  const userId = "guest_" + Math.random().toString(36).slice(2,7);
  let dark = true;
  let conversation = [];

  // ===== DOM =====
  const chat = document.getElementById('chat');
  const userInput = document.getElementById('userInput');
  const sendBtn = document.getElementById('sendBtn');

  const plusBtn = document.getElementById('plusBtn');
  const micBtn  = document.getElementById('micBtn');
  const photoBtn= document.getElementById('photoBtn');
  const docBtn  = document.getElementById('docBtn');

  const imgLibPicker = document.getElementById('imgLibPicker');
  const imgCamPicker = document.getElementById('imgCamPicker');
  const docPicker    = document.getElementById('docPicker');

  const sheet = document.getElementById('sheet');
  const sheetBg = document.getElementById('sheetBg');
  const takePhoto = document.getElementById('takePhoto');
  const pickPhoto = document.getElementById('pickPhoto');
  const pickFile  = document.getElementById('pickFile');

  const tokenEl = document.getElementById('tokenCount');
  const modeBtn = document.getElementById('toggleMode');
  const menuBtn = document.getElementById('btnMenu');

  const modalBg = document.getElementById('modalBg');
  const faq = document.getElementById('faq');
  const buy = document.getElementById('buy');
  const login = document.getElementById('login');
  const btnBuy = document.getElementById('btnBuy');
  const btnLogin = document.getElementById('btnLogin');
  const savePseudo = document.getElementById('savePseudo');
  const pseudoInput = document.getElementById('pseudoInput');

  // ===== Helpers UI =====
  function scrollEnd(){ chat.scrollTop = chat.scrollHeight; }
  function addMessage(txt, who="bot"){
    const div = document.createElement('div');
    div.className = "msg" + (who==="me" ? " me" : "");
    div.textContent = txt;
    chat.appendChild(div);
    scrollEnd();
  }
  function setTyping(on){
    if(on){
      typingEl = document.createElement('div');
      typingEl.className = "msg";
      typingEl.id = "typing";
      typingEl.textContent = "â€¦";
      chat.appendChild(typingEl);
      scrollEnd();
    }else{
      const t = document.getElementById('typing');
      if(t) t.remove();
    }
  }
  function updateTokens(){ tokenEl.textContent = tokenCount.toLocaleString('fr-FR').replace(/\s/g,''); }

  // ===== ThÃ¨me =====
  modeBtn.addEventListener('click', () => {
    dark = !dark;
    document.body.classList.toggle('light', !dark);
  });

  // ===== Menu â†’ FAQ =====
  function openModal(el){
    modalBg.style.display = "block";
    el.style.display = "block";
  }
  function closeModals(){
    modalBg.style.display = "none";
    [faq,buy,login].forEach(e=>e.style.display="none");
  }
  modalBg.addEventListener('click', closeModals);
  menuBtn.addEventListener('click', ()=>openModal(faq));
  btnBuy.addEventListener('click', ()=>openModal(buy));
  btnLogin.addEventListener('click', ()=>openModal(login));
  document.querySelectorAll('.close-x').forEach(x => x.addEventListener('click', closeModals));
  savePseudo.addEventListener('click', () => {
    const p = (pseudoInput.value||"").trim();
    if(p){ addMessage("ConnectÃ© comme Â« "+p+" Â»", "bot"); closeModals(); }
  });

  // ===== Sheet (plus) =====
  function openSheet(){ sheet.style.display="block"; sheetBg.style.display="block"; }
  function closeSheet(){ sheet.style.display="none"; sheetBg.style.display="none"; }
  plusBtn.addEventListener('click', openSheet);
  sheetBg.addEventListener('click', closeSheet);

  // boutons du sheet
  takePhoto.addEventListener('click', ()=> imgCamPicker.click());
  pickPhoto.addEventListener('click', ()=> imgLibPicker.click());
  pickFile .addEventListener('click', ()=> docPicker.click());

  // raccourcis icÃ´nes haute barre dâ€™input
  photoBtn.addEventListener('click', ()=> imgLibPicker.click());
  docBtn  .addEventListener('click', ()=> docPicker.click());

  // ===== Micro (Web Speech API) =====
  let recognition = null;
  if('webkitSpeechRecognition' in window){
    const Rec = window.webkitSpeechRecognition;
    recognition = new Rec();
    recognition.lang = 'fr-FR';
    recognition.interimResults = false;
    recognition.maxAlternatives = 1;
    recognition.onresult = (e)=>{
      const txt = e.results[0][0].transcript;
      userInput.value = (userInput.value ? userInput.value+' ' : '') + txt;
    };
  }
  micBtn.addEventListener('click', ()=>{
    if(!recognition){ alert("Micro non supportÃ© ici."); return; }
    try { recognition.start(); } catch(_){}
  });

  // ===== Estimation tokens simple =====
  const estTokens = (s)=> Math.ceil((s||"").length/4); // ~4 chars/token
  function debitForTurn(userTxt, assistantTxt){
    const used = estTokens(userTxt) + estTokens(assistantTxt||"Bonjour");
    tokenCount = Math.max(0, tokenCount - used);
    updateTokens();
  }

  // ===== Envoi texte =====
  async function sendMessage(){
    const txt = (userInput.value||"").trim();
    if(!txt) return;
    userInput.value="";
    addMessage(txt,"me");

    // construit convo minimale pour le backend (il garde sa mÃ©moire cÃ´tÃ© serveur)
    const convo = conversation.concat([{role:"user",content:txt}]);

    setTyping(true);
    try{
      const resp = await fetch(API_URL,{
        method:"POST",
        headers:{"Content-Type":"application/json"},
        body:JSON.stringify({conversation:convo,userId,tokens:tokenCount})
      });
      const data = await resp.json();
      setTyping(false);

      const answer = (data && data.answer) ? data.answer : "DÃ©solÃ©e, une erreur s'est produite.";
      addMessage(answer,"bot");
      conversation.push({role:"user",content:txt},{role:"assistant",content:answer});
      debitForTurn(txt, answer);

    }catch(e){
      setTyping(false);
      addMessage("Erreur rÃ©seau. RÃ©essaie.", "bot");
    }
  }
  sendBtn.addEventListener('click', sendMessage);
  userInput.addEventListener('keydown', e=>{ if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); } });

  // ===== Images & Docs â†’ /analyze-image =====
  async function handleImageOrDoc(file, prompt){
    if(!file) return;
    setTyping(true);
    try{
      const form = new FormData();
      form.append("image", file);
      form.append("userId", userId);
      form.append("prompt", prompt || "Analyse ce fichier et aide-moi.");

      const resp = await fetch(API_IMG,{ method:"POST", body:form });
      const data = await resp.json();
      setTyping(false);

      const answer = (data && data.answer) ? data.answer : "Fichier reÃ§u mais je n'ai pas pu l'analyser.";
      addMessage(answer,"bot");
      conversation.push({role:"user",content: (prompt||"Analyse du fichier")+" [fichier]"}, {role:"assistant",content:answer});
      debitForTurn(prompt||"", answer);

    }catch(e){
      setTyping(false);
      addMessage("Erreur lors de lâ€™envoi du fichier.", "bot");
    }
  }
  imgLibPicker.addEventListener('change', ()=> handleImageOrDoc(imgLibPicker.files[0], "Peux-tu analyser cette image ?"));
  imgCamPicker.addEventListener('change', ()=> handleImageOrDoc(imgCamPicker.files[0], "Analyse la photo prise."));
  docPicker.addEventListener('change', ()=> handleImageOrDoc(docPicker.files[0], "Lis ce document et rÃ©sume."));

  // ===== FAQ depuis â˜° =====
  document.getElementById('btnMenu').addEventListener('click', ()=>openModal(faq));

  // init
  updateTokens();
})();
</script>
</body>
</html>

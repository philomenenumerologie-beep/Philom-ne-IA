<!DOCTYPE html>
<html lang="fr" style="background:#000;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Philom√®ne I.A.</title>
  <meta name="color-scheme" content="dark" />

  <!-- Clerk client pour l'auth -->
  <script src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js"></script>

  <style>
    body {
      margin:0;
      background:#000;
      color:#fff;
      font-family:-apple-system,BlinkMacSystemFont,"Inter",Roboto,"Helvetica Neue",Arial,sans-serif;
      display:flex;
      flex-direction:column;
      min-height:100vh;
    }

    /* HEADER BAR */
    header {
      position:relative;
      background:#000;
      color:#ffd84f;
      border-bottom:1px solid rgba(255,255,255,0.08);
      padding:16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      font-size:16px;
      font-weight:500;
    }

    .left-head,
    .right-head{
      display:flex;
      align-items:center;
      gap:12px;
      color:#fff;
    }

    .burger {
      width:40px;
      height:40px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
    }

    .more {
      width:40px;
      height:40px;
      background:#111;
      border:1px solid rgba(255,255,255,0.1);
      border-radius:8px;
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:20px;
      font-weight:500;
      cursor:pointer;
    }

    .token-box {
      display:flex;
      flex-direction:column;
      align-items:center;
      font-size:14px;
      line-height:1.2;
      color:#ffd84f;
      font-weight:600;
    }

    .token-value {
      display:flex;
      align-items:center;
      gap:8px;
    }

    .token-value span#token-count-top{
      color:#ffd84f;
      font-feature-settings:"tnum";
    }

    .token-label {
      font-size:12px;
      color:#888;
      font-weight:400;
    }

    /* MENU FLOTTANT MORE (‚ãØ) */
    #menu-panel {
      position:absolute;
      right:16px;
      top:70px;
      min-width:230px;
      background:#111;
      border:1px solid rgba(255,255,255,0.2);
      box-shadow:0 30px 60px rgba(0,0,0,0.8);
      border-radius:8px;
      color:#fff;
      font-size:16px;
      padding:8px 0;
      display:none;
      z-index:9999;
    }

    #menu-panel .item {
      padding:12px 16px;
      border-bottom:1px solid rgba(255,255,255,0.07);
      line-height:1.3;
      font-weight:500;
      cursor:pointer;
      display:flex;
      flex-direction:column;
    }

    #menu-panel .item:last-child {
      border-bottom:none;
    }

    #menu-connect-btn {
      color:#fff;
    }
    #menu-logout-btn {
      color:#ff4d4d;
      display:none;
    }
    #menu-help-btn {
      color:#9dd0ff;
    }
    #menu-panel small {
      font-size:13px;
      font-weight:400;
      color:#888;
    }

    /* ZONE MESSAGES */
    .chat-wrapper {
      flex:1;
      display:flex;
      flex-direction:column;
      padding:16px;
      gap:16px;
      overflow-y:auto;
      background:radial-gradient(circle at 20% 20%, rgba(80,0,255,0.18) 0%, rgba(0,0,0,0) 60%);
    }

    .bubble {
      max-width:90%;
      border-radius:12px;
      padding:16px;
      line-height:1.4;
      font-size:18px;
      box-shadow:0 30px 60px rgba(0,0,0,0.6);
      border:1px solid rgba(255,255,255,0.08);
      white-space:pre-wrap;
    }

    /* bulle assistante / system */
    .assistant {
      align-self:flex-start;
      background:#2b2b2b;
      color:#fff;
    }

    /* bulle utilisateur */
    .user {
      align-self:flex-end;
      background:#4c3bff;
      background:radial-gradient(circle at 100% 0%, rgba(130,110,255,.6) 0%, rgba(20,10,60,0) 60%), #4c3bff;
      color:#fff;
      font-weight:500;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 40px rgba(100,60,255,0.6),0 30px 60px rgba(0,0,0,0.8);
    }

    .thinking-bubble {
      font-size:16px;
      color:#ddd;
      background:#2b2b2b;
    }

    /* BARRE D'ENVOI */
    .input-zone-wrapper {
      background:#000;
      border-top:1px solid rgba(255,255,255,0.08);
      padding:16px;
    }

    .input-row {
      display:flex;
      align-items:stretch;
      gap:12px;
      background:radial-gradient(circle at 0% 0%, rgba(130,110,255,.3) 0%, rgba(0,0,0,0) 60%);
    }

    .plus-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:28px;
      line-height:0;
      font-weight:500;
    }

    .text-input {
      flex:1;
      background:#0f0f1a;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.25);
      font-size:18px;
      color:#fff;
      padding:16px;
      font-family:inherit;
      outline:none;
    }

    .send-btn {
      min-width:52px;
      min-height:52px;
      background:#1a0aff;
      border-radius:12px;
      border:1px solid rgba(255,255,255,0.15);
      box-shadow:0 0 30px rgba(120,80,255,0.8),0 30px 60px rgba(0,0,0,0.8);
      display:flex;
      align-items:center;
      justify-content:center;
      color:#fff;
      font-size:24px;
      line-height:0;
      font-weight:500;
      cursor:pointer;
    }

    .status-line {
      text-align:center;
      margin-top:12px;
      font-size:15px;
      color:#999;
      font-weight:400;
    }

    .status-line strong {
      font-weight:600;
      color:#fff;
    }

    .status-line #token-count-bottom {
      color:#fff;
      font-feature-settings:"tnum";
    }
  </style>
</head>

<body>

  <!-- HEADER -->
  <header>
    <div class="left-head">
      <div class="burger">‚ò∞</div>
    </div>

    <div class="token-box">
      <div class="token-value">
        <div style="font-size:20px;">üíé</div>
        <span id="token-count-top">5000</span>
        <span>tokens</span>
      </div>
      <div class="token-label">Philom√®ne I.A.</div>
    </div>

    <div class="right-head">
      <div class="more" id="more-btn">‚ãØ</div>
    </div>

    <!-- MENU FLOTTANT -->
    <div id="menu-panel">
      <div class="item" id="menu-connect-btn">
        <span>Se connecter üîê</span>
        <small>Cr√©er un compte ou se connecter</small>
      </div>
      <div class="item" id="menu-logout-btn" style="display:none;">
        <span>Se d√©connecter</span>
        <small>Fermer la session</small>
      </div>
      <div class="item" id="menu-help-btn">
        <span>Aide / Comment je t'aide ‚ùì</span>
        <small>Support, utilisation, tokens</small>
      </div>
    </div>
  </header>

  <!-- CHAT -->
  <div id="chat-container" class="chat-wrapper"></div>

  <!-- BARRE ENVOI -->
  <div class="input-zone-wrapper">
    <div class="input-row">
      <div class="plus-btn">+</div>
      <input
        id="user-input"
        class="text-input"
        placeholder="√âcrivez votre message..."
      />
      <div id="send-btn" class="send-btn">‚û§</div>
    </div>

    <div class="status-line">
      Pr√™t ‚Ä¢
      <strong>
        <span id="token-count-bottom">5000</span>
        tokens
      </strong>
      restants
    </div>
  </div>

  <!-- LOGIQUE APP -->
  <script>
  // ===============================
  // CONFIG
  // ===============================

  const API_URL = "https://philo-backend-su29.onrender.com/ask";

  // ta cl√© publique Clerk (celle qui commence par pk_test_...)
  const CLERK_PUBLISHABLE_KEY = "pk_test_ZW5vdWdoLXRyZWVvcmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA";

  // Etat utilisateur courant
  let currentUserId = "guest"; // par d√©faut pas connect√©
  let isSignedIn = false;

  // m√©moire locale de la conversation (pour l'affichage + envoyer au backend)
  const conversation = [
    {
      role: "assistant",
      content:
        "üëã Bonjour ! Je suis Philom√®ne I.A., votre assistante personnelle.\n" +
        "Si vous avez un probl√®me, j‚Äôai la solution.\n" +
        "Vous avez une question, j‚Äôai la r√©ponse.\n" +
        "Ensemble, on ira plus loin üïä"
    }
  ];

  // ===============================
  // S√âLECTEURS DOM
  // ===============================

  const chatContainer   = document.getElementById("chat-container");
  const userInput       = document.getElementById("user-input");
  const sendBtn         = document.getElementById("send-btn");

  const menuBtn         = document.getElementById("menu-btn");        // le bouton "‚Ä¶"
  const menuPanel       = document.getElementById("menu-panel");      // le petit menu d√©roulant
  const loginBtn        = document.getElementById("login-btn");       // ligne "Connexion / Inscription"
  const logoutBtn       = document.getElementById("logout-btn");      // ligne "Se d√©connecter"

  const tokenTop        = document.getElementById("token-count-top");     // compteur haut
  const tokenBottom     = document.getElementById("token-count-bottom");  // compteur bas

  // compteur de tokens local pour l'affichage
  let tokenCount = 5000;

  // ===============================
  // FONCTIONS UI
  // ===============================

  function scrollToBottom() {
    chatContainer.scrollTop = chatContainer.scrollHeight;
  }

  function addBubble(text, who) {
    const div = document.createElement("div");
    div.classList.add("bubble");

    if (who === "user") {
      div.classList.add("user");
    } else if (who === "assistant") {
      div.classList.add("assistant");
    } else if (who === "thinking") {
      div.classList.add("assistant","thinking-bubble");
    } else {
      div.classList.add("assistant");
    }

    div.textContent = text || "";
    chatContainer.appendChild(div);
    scrollToBottom();
    return div;
  }

  function updateTokenDisplay() {
    tokenTop.textContent    = tokenCount;
    tokenBottom.textContent = tokenCount;
  }

  // ===============================
  // CLERK (auth)
  // ===============================
  // On charge Clerk dans la page (si pas d√©j√† dans ton <head>, ajoute ceci dans <head>):
  // <script
  //   async
  //   crossorigin="anonymous"
  //   data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVvcmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
  //   src="https://cdn.clerk.dev/clerk.js">
  // </script>
  //
  // Important: ce script doit √™tre VRAIMENT dans le HTML final, sinon rien ne s'ouvre.

  async function initClerk() {
    // Clerk injecte window.Clerk
    if (!window.Clerk) {
      console.warn("Clerk pas charg√©.");
      return;
    }

    try {
      await window.Clerk.load();

      const user = window.Clerk.user;
      const session = window.Clerk.session;

      if (user && session) {
        // connect√©
        isSignedIn = true;
        currentUserId = user.id || "guest";
      } else {
        // pas connect√©
        isSignedIn = false;
        currentUserId = "guest";
      }

      refreshMenuUI();
    } catch (e) {
      console.error("Erreur initClerk:", e);
    }
  }

  function refreshMenuUI() {
    if (isSignedIn) {
      // cacher "Se connecter", montrer "Se d√©connecter"
      loginBtn.style.display  = "none";
      logoutBtn.style.display = "block";
    } else {
      loginBtn.style.display  = "block";
      logoutBtn.style.display = "none";
    }
  }

  // quand on tape sur "Connexion / Inscription"
  loginBtn.addEventListener("click", async () => {
    // ouvre le popup Clerk
    if (!window.Clerk) return;

    await window.Clerk.openSignIn({
      // apr√®s succ√®s
      afterSignIn: async () => {
        await initClerk(); // on recharge l'√©tat
        menuPanel.style.display = "none";
      },
      // apr√®s cr√©ation de compte
      afterSignUp: async () => {
        await initClerk();
        menuPanel.style.display = "none";
      }
    });
  });

  // quand on tape sur "Se d√©connecter"
  logoutBtn.addEventListener("click", async () => {
    if (!window.Clerk) return;

    try {
      await window.Clerk.signOut();
      isSignedIn = false;
      currentUserId = "guest";
      refreshMenuUI();
      menuPanel.style.display = "none";
    } catch (err) {
      console.error("Erreur signOut:", err);
    }
  });

  // ouvrir / fermer le petit menu "‚Ä¶"
  menuBtn.addEventListener("click", () => {
    if (menuPanel.style.display === "block") {
      menuPanel.style.display = "none";
    } else {
      menuPanel.style.display = "block";
    }
  });

  // ===============================
  // ENVOI MESSAGE √Ä PHILOM√àNE
  // ===============================

  async function askPhilomene() {
    const text = userInput.value.trim();
    if (!text) return;

    // bulle utilisateur (violet)
    addBubble(text, "user");

    // push aussi dans la conversation locale AVANT d'appeler le serveur
    conversation.push({
      role: "user",
      content: text
    });

    // clear champ
    userInput.value = "";

    // bulle "elle r√©fl√©chit..."
    const thinkingBubble = addBubble("Philom√®ne r√©fl√©chit √† votre message...", "thinking");

    try {
      // requ√™te backend
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          // j'envoie tout l'historique pour que le mod√®le garde le contexte
          conversation: conversation,
          // j'envoie aussi l'ID utilisateur pour qu'on puisse plus tard faire m√©moire par compte
          userId: currentUserId
        })
      });

      if (!resp.ok) {
        throw new Error("R√©ponse r√©seau pas OK: " + resp.status);
      }

      const data = await resp.json();

      // remplace la bulle thinking par la vraie r√©ponse
      thinkingBubble.remove();
      addBubble(data.answer || "‚Ä¶", "assistant");

      // push la r√©ponse dans la conv locale
      conversation.push({
        role: "assistant",
        content: data.answer || ""
      });

      // d√©cr√©mente les tokens simul√©s
      tokenCount = Math.max(0, tokenCount - 20);
      updateTokenDisplay();

    } catch (err) {
      console.error("Erreur fetch /ask:", err);

      thinkingBubble.textContent =
        "D√©sol√©e, j'ai eu un probl√®me r√©seau.";
    }
  }

  // bouton envoyer
  sendBtn.addEventListener("click", askPhilomene);

  // touche Entr√©e
  userInput.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      askPhilomene();
    }
  });

  // ===============================
  // INIT AU CHARGEMENT
  // ===============================

  // on affiche d√©j√† le message d'accueil (le premier √©l√©ment de conversation)
  function initUI() {
    addBubble(conversation[0].content, "assistant");
    updateTokenDisplay();
    scrollToBottom();
  }

  initUI();
  initClerk();
</script>

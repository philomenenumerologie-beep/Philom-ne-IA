<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Philomenia ‚Ä¢ Messenger (style MSN)</title>
  <style>
    :root{
      /* Th√®me clair MSN */
      --bg:#eaf3ff; --panel:#fff; --text:#0b1b33; --sub:#4b5a73;
      --accent1:#3a84ff; --accent2:#8ec0ff; --input:#fff;
      --bubble-me:#e6f2ff; --bubble-bot:#f2f7fb; --border:#c8d6f2;
      --shadow:0 10px 30px rgba(0,0,0,.12);
    }
    [data-theme="dark"]{
      --bg:#0f1722; --panel:#121a26; --text:#dbe7ff; --sub:#9db2d7;
      --accent1:#4da3ff; --accent2:#2b73d9; --input:#0c111a;
      --bubble-me:#1a2638; --bubble-bot:#121a26; --border:#24334a;
      --shadow:0 12px 40px rgba(0,0,0,.35);
    }
    html,body{margin:0;height:100%;background:var(--bg);color:var(--text);font:16px/1.4 system-ui,Segoe UI,Roboto,Helvetica,Arial}
    .app{max-width:860px;margin:16px auto;padding:0 12px}
    .window{background:var(--panel);border:1px solid var(--border);border-radius:12px;box-shadow:var(--shadow);overflow:hidden}
    .titlebar{display:flex;align-items:center;gap:10px;background:linear-gradient(#5aa0ff,#2d7fff);color:#fff;padding:10px 14px;position:sticky;top:0;z-index:3}
    .dot{width:14px;height:14px;border-radius:50%;background:radial-gradient(#bff,#3cf)}
    .title{font-weight:700;flex:1}
    .tbtn{width:38px;height:38px;display:grid;place-items:center;background:rgba(255,255,255,.18);border:1px solid rgba(255,255,255,.35);border-radius:10px;cursor:pointer}
    .tbtn:hover{background:rgba(255,255,255,.28)}
    .chat{height:65vh;min-height:420px;overflow:auto;padding:16px;scroll-behavior:smooth}
    .msg{max-width:90%;padding:12px 14px;border:1px solid var(--border);border-radius:14px;margin:8px 0;white-space:pre-wrap;word-wrap:break-word}
    .me{background:var(--bubble-me);margin-left:auto}
    .bot{background:var(--bubble-bot)}
    .avatar{float:right;margin-left:8px;width:40px;height:40px;border-radius:10px;background:#cfe2ff;display:grid;place-items:center}
    .inputbar{display:flex;gap:10px;align-items:center;border-top:1px solid var(--border);padding:10px;background:var(--panel);position:sticky;bottom:0}
    textarea{flex:1;resize:none;max-height:40vh;padding:12px 14px;border-radius:12px;border:1px solid var(--border);background:var(--input);color:var(--text);outline:none}
    textarea:focus{border-color:var(--accent1);box-shadow:0 0 0 3px color-mix(in srgb, var(--accent1) 20%, transparent)}
    button.primary{background:linear-gradient(var(--accent2),var(--accent1));color:#fff;border:none;padding:12px 18px;border-radius:12px;font-weight:700;min-width:120px}
    button.primary:active{transform:translateY(1px)}
    .iconbtn{width:44px;height:44px;border:1px solid var(--border);background:var(--panel);border-radius:12px;display:grid;place-items:center}
    .row{display:flex;gap:10px;align-items:center}
    .hint{font-size:.85rem;color:var(--sub);padding:8px 16px}
    .pill{background:#e8f1ff;border:1px solid var(--border);color:var(--sub);padding:2px 8px;border-radius:999px;margin-left:6px}
    [data-theme="dark"] .pill{background:#142033}
    /* Modal */
    .modal{position:fixed;inset:0;display:none;justify-content:center;align-items:center;background:rgba(0,0,0,.4);padding:16px}
    .modal.show{display:flex}
    .card{max-width:680px;width:100%;background:var(--panel);border:1px solid var(--border);border-radius:14px;box-shadow:var(--shadow)}
    .card h3{margin:0;padding:16px;border-bottom:1px solid var(--border)}
    .card .content{padding:16px}
    .pack{border:1px solid var(--border);border-radius:12px;padding:14px;margin-bottom:12px}
    .shake{animation:shake .5s linear 1}
    @keyframes shake{
      10%{transform:translate(-3px,0)} 20%{transform:translate(3px,0)}
      30%{transform:translate(-3px,0)} 40%{transform:translate(3px,0)}
      50%{transform:translate(-2px,0)} 60%{transform:translate(2px,0)}
      70%{transform:translate(-2px,0)} 80%{transform:translate(2px,0)}
      90%{transform:translate(-1px,0)} 100%{transform:translate(0,0)}
    }
    @media (max-width:520px){
      .chat{height:70dvh}
      .titlebar{border-radius:12px 12px 0 0}
      .avatar{display:none}
      .msg{max-width:100%}
    }
  </style>
</head>
<body>
  <div class="app">
    <div class="window" id="win">
      <div class="titlebar">
        <div class="dot"></div>
        <div class="title">Philomenia Messenger</div>
        <div class="tbtn" id="btnDownload" title="T√©l√©charger la conversation">‚¨áÔ∏è</div>
        <div class="tbtn" id="btnPrint" title="Imprimer">üñ®Ô∏è</div>
        <div class="tbtn" id="btnSettings" title="Param√®tres & recharges">‚öôÔ∏è</div>
      </div>

      <div class="chat" id="chat"></div>
      <div class="hint" id="quotaHint">Forfait actuel : <span id="tierLabel">free</span> ‚Äî Tokens restants : <strong id="left">‚Ä¶</strong></div>

      <div class="inputbar">
        <label class="iconbtn" title="Joindre une image (jpeg/png)">
          üìé
          <input type="file" id="file" accept="image/*" style="display:none">
        </label>
        <button class="iconbtn" id="btnNudge" title="Nudge MSN">üîî</button>
        <textarea id="input" rows="1" placeholder="√âcris ton message‚Ä¶ (Entr√©e pour envoyer)"></textarea>
        <button class="primary" id="send">Envoyer</button>
      </div>
    </div>
  </div>

  <!-- Modal param√®tres / recharges -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="card">
      <h3>Param√®tres</h3>
      <div class="content">
        <div class="row" style="justify-content:space-between;flex-wrap:wrap;gap:14px">
          <div>
            <label>Th√®me</label><br/>
            <select id="themeSel">
              <option value="light">Clair (MSN)</option>
              <option value="dark">Sombre</option>
            </select>
          </div>
          <div>
            <label>Langue</label><br/>
            <select id="langSel">
              <option value="fr">Fran√ßais</option>
              <option value="en">English</option>
              <option value="nl">Nederlands</option>
            </select>
          </div>
          <div>
            <label>Actualit√©s</label><br/>
            <input id="newsQuery" placeholder="ex: premier ministre fran√ßais" style="width:240px">
            <button id="btnNews">Chercher</button>
          </div>
        </div>

        <hr style="border:none;border-top:1px solid var(--border);margin:16px 0">
        <h4 style="margin:0 0 8px">Recharger des tokens (PayPal)</h4>
        <div class="pack">
          <strong>Pack 5 ‚Ç¨</strong> <span class="pill">‚âà 4 000 tokens</span>
          <div id="pp-5" style="margin-top:8px"></div>
        </div>
        <div class="pack">
          <strong>Pack 10 ‚Ç¨</strong> <span class="pill">‚âà 9 000 tokens</span>
          <div id="pp-10" style="margin-top:8px"></div>
        </div>
        <div class="pack">
          <strong>Pack 20 ‚Ç¨</strong> <span class="pill">‚âà 20 000 tokens</span>
          <div id="pp-20" style="margin-top:8px"></div>
        </div>
        <div class="row" style="justify-content:flex-end">
          <button id="closeSettings">Fermer</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Sons (petits bips int√©gr√©s) -->
  <audio id="snd-send" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..."></audio>
  <audio id="snd-recv" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..."></audio>
  <audio id="snd-nudge" preload="auto" src="data:audio/mp3;base64,//uQZAAAAAAAAAAAAAAAAAAAA..."></audio>

  <!-- PayPal SDK (SANDBOX par d√©faut) -->
  <script>
    // TODO: mets ton CLIENT-ID sandbox (puis tu passeras l'URL en live quand tu seras pr√™t)
    const PAYPAL_CLIENT_ID = "EJKOBEaO53LvLlA8KbN__haTgvLJejkXY9LCIT6PCdDNFRt3sG5ckFU4NERx-ml1NXMzUp6xgIHdiIkX";
    if (PAYPAL_CLIENT_ID && !document.getElementById('pp-sdk')) {
      const s=document.createElement('script');
      s.id='pp-sdk';
      s.src=`https://www.paypal.com/sdk/js?client-id=${PAYPAL_CLIENT_ID}&currency=EUR&intent=capture`;
      document.head.appendChild(s);
    }
  </script>

  <script>
  // === Config ===
  // TODO: remplace par l‚ÄôURL de ton backend Render
  const BACKEND_URL = "https://philo-backend-su29.onrender.com";

  // id client pour quota
  const clientId = localStorage.getItem("client-id") || (crypto.randomUUID?.() || String(Math.random())).toString();
  localStorage.setItem("client-id", clientId);

  // i18n minimal
  const STR = {
    fr:{ hello:"Bonjour üëã √âcris-moi ci-dessous (style MSN activ√© !)", ready:"Pr√™t.", noNews:"Aucun r√©sultat d‚Äôactualit√© trouv√©." },
    en:{ hello:"Hello! How can I assist you today?", ready:"Ready.", noNews:"No news results found." },
    nl:{ hello:"Hallo! Hoe kan ik je vandaag helpen?", ready:"Klaar.", noNews:"Geen nieuws gevonden." }
  };
  let lang = localStorage.getItem("lang") || "fr";
  let theme = localStorage.getItem("theme") || (matchMedia('(prefers-color-scheme:dark)').matches?'dark':'light');
  document.documentElement.setAttribute("data-theme", theme);

  // DOM
  const chat = $("#chat"), input=$("#input"), send=$("#send");
  const left=$("#left"), tierLabel=$("#tierLabel");
  const btnSettings=$("#btnSettings"), modal=$("#settingsModal");
  $("#themeSel").value = theme; $("#langSel").value = lang;

  // Helpers
  function $(sel,root=document){ return root.querySelector(sel); }
  function el(tag,cls,txt){ const e=document.createElement(tag); if(cls) e.className=cls; if(txt!=null) e.textContent=txt; return e; }
  const play = id => { const a=$("#"+id); a && a.play().catch(()=>{}); };

  // UI
  function addMsg(who,text,avatar=false){
    const m=el("div","msg "+(who==="me"?"me":"bot"));
    m.textContent=text;
    if(avatar){ const av=el("div","avatar"); av.textContent="Œ¶"; m.appendChild(av); }
    chat.appendChild(m); chat.scrollTop = chat.scrollHeight; return m;
  }

  // Intro
  addMsg("bot", STR[lang].hello, true);
  $(".hint").textContent = STR[lang].ready;

  // Quota
  async function refreshQuota(){
    const r = await fetch(`${BACKEND_URL}/api/quota`, { headers:{ "x-client-id":clientId }});
    const j = await r.json();
    left.textContent = j.remaining ?? "‚Äî";
    tierLabel.textContent = j.tier ?? "free";
  }
  refreshQuota();

  // Envoi message
  async function sendMessage(){
    const text = input.value.trim();
    if(!text) return;
    addMsg("me", text);
    input.value=""; play("snd-send");

    // Actu rapide si @ ou mot clef
    const isNews = /^actu|actualit√©|news|aujourd|qui est|^@/i.test(text);
    if(isNews){
      const q = text.replace(/^@/,'').trim() || text;
      const r = await fetch(`${BACKEND_URL}/api/news?q=`+encodeURIComponent(q));
      const j = await r.json().catch(()=>null);
      addMsg("bot", (j?.results?.length? j.results.map(n=>`üì∞ ${n.title}\nüîó ${n.link}`).join('\n\n') : STR[lang].noNews));
      play("snd-recv"); return;
    }

    // image optionnelle
    const file = $("#file").files[0];
    let imageBase64=null;
    if(file){ imageBase64 = await fileToBase64(file); $("#file").value=""; }

    const r = await fetch(`${BACKEND_URL}/api/chat`,{
      method:"POST",
      headers:{
        "Content-Type":"application/json",
        "x-client-id":clientId,
        "x-lang":lang
      },
      body: JSON.stringify({ message:text, image:imageBase64 })
    });
    const j = await r.json();
    if(r.status===402){ addMsg("bot","‚ö†Ô∏è Quota atteint. Ouvre ‚öôÔ∏è pour recharger."); return; }
    addMsg("bot", j.reply || "(pas de r√©ponse)"); play("snd-recv");
    refreshQuota();
  }
  send.onclick = sendMessage;
  input.addEventListener("keydown", e=>{
    if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
  });

  $("#file").addEventListener("change", ()=>{
    if($("#file").files[0]) addMsg("me","üìé Image jointe pr√™te (elle sera envoy√©e au prochain message).");
  });

  // Nudge
  $("#btnNudge").onclick = ()=>{
    const w=$("#win"); w.classList.remove("shake"); void w.offsetWidth; w.classList.add("shake"); play("snd-nudge");
  };

  // Download / Print
  $("#btnDownload").onclick = ()=>{
    let txt=[...document.querySelectorAll(".msg")].map(m=>m.classList.contains("me")?"Moi: "+m.textContent:"Œ¶: "+m.textContent).join("\n\n");
    const blob=new Blob([txt],{type:"text/plain"}), a=document.createElement("a");
    a.href=URL.createObjectURL(blob); a.download="conversation.txt"; a.click();
  };
  $("#btnPrint").onclick = ()=>window.print();

  // Param√®tres + actu
  btnSettings.onclick = ()=>{ modal.classList.add("show"); initPayPal(); };
  $("#closeSettings").onclick = ()=>modal.classList.remove("show");
  $("#themeSel").onchange = (e)=>{ theme=e.target.value; localStorage.setItem("theme",theme); document.documentElement.setAttribute("data-theme",theme); };
  $("#langSel").onchange = (e)=>{ lang=e.target.value; localStorage.setItem("lang",lang); };
  $("#btnNews").onclick = async ()=>{
    const q=$("#newsQuery").value.trim(); if(!q) return;
    const r = await fetch(`${BACKEND_URL}/api/news?q=`+encodeURIComponent(q));
    const j = await r.json().catch(()=>null);
    addMsg("bot", (j?.results?.length? j.results.map(n=>`üì∞ ${n.title}\nüîó ${n.link}`).join('\n\n') : STR[lang].noNews));
  };

  // PayPal ‚Äî top-up
  function initPayPal(){
    if(!window.paypal) return; // SDK non charg√© (pas de client id)
    const mounts = [
      { id:"pp-5",  packId:"PACK_5"  },
      { id:"pp-10", packId:"PACK_10" },
      { id:"pp-20", packId:"PACK_20" },
    ];
    mounts.forEach(m=>{
      const node = $("#"+m.id); if(!node) return; node.innerHTML="";
      paypal.Buttons({
        style:{ shape:"pill", color:"blue", layout:"horizontal", label:"pay" },
        createOrder: ()=> fetch(`${BACKEND_URL}/api/paypal/create-order`,{
          method:"POST", headers:{ "Content-Type":"application/json","x-client-id":clientId },
          body: JSON.stringify({ packId:m.packId })
        }).then(r=>r.json()).then(j=>j.id),
        onApprove: data => fetch(`${BACKEND_URL}/api/paypal/capture-order`,{
          method:"POST", headers:{ "Content-Type":"application/json","x-client-id":clientId },
          body: JSON.stringify({ orderId:data.orderID })
        }).then(r=>r.json()).then(j=>{
          if(j.ok){ addMsg("bot","‚úÖ Paiement confirm√©. Tokens ajout√©s : "+j.added); refreshQuota(); }
          else{ addMsg("bot","‚ùå Paiement refus√©."); }
        }),
        onError: err => addMsg("bot","‚ùå Erreur PayPal: "+(err?.message||err))
      }).render(node);
    });
  }

  // Utils
  function fileToBase64(file){
    return new Promise((res,rej)=>{
      const r=new FileReader(); r.onload=()=>res(r.result); r.onerror=rej; r.readAsDataURL(file);
    });
  }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>Philom√®ne IA</title>
  <style>
    :root {
      --bg-page: #0a0a0f;
      --bg-chat: #0f1017;
      --bg-bubble-user: #1f2937;
      --bg-bubble-ai: #1a1030;
      --text-main: #ffffff;
      --text-dim: #8b91a6;
      --accent: #6366f1;
      --accent-strong: #4f46e5;
      --border-soft: rgba(255,255,255,0.08);
      --border-mid: rgba(255,255,255,0.12);
      --radius-bubble: 14px;
      --radius-ui: 12px;
      --radius-menu: 16px;
      --shadow-menu: 0 30px 80px rgba(0,0,0,0.9), 0 0 100px rgba(99,102,241,0.35);
      font-size: 16px;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", Roboto, system-ui, sans-serif;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      margin: 0;
      padding: 0;
    }

    body {
      background: var(--bg-page);
      color: var(--text-main);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      max-width: 600px;
      margin: 0 auto;
      position: relative;
      padding-top: 12px;
      padding-bottom: 110px; /* espace pour la barre d'envoi */
    }

    /* HEADER TOP BAR */
    .topbar-wrapper {
      position: relative;
      padding: 0 12px 12px;
      z-index: 20;
    }

    .topbar {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      width: 100%;
    }

    .left-group {
      display: flex;
      align-items: flex-start;
      gap: 10px;
    }

    .burger-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      border-radius: var(--radius-ui);
      font-size: 18px;
      line-height: 1;
      padding: 10px 12px;
    }

    .brand-block {
      display: flex;
      flex-direction: column;
      min-width: 0;
    }

    .brand-row {
      display: flex;
      align-items: center;
      gap: 8px;
      line-height: 1.2;
    }

    .avatar-circle {
      width: 30px;
      height: 30px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #ff7de2 0%, #4f1a91 60%);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 12px;
      font-weight: 600;
      color: #fff;
      border: 1px solid rgba(255,255,255,0.3);
      box-shadow: 0 10px 30px rgba(255,0,200,0.4);
    }

    .brand-texts {
      display: flex;
      flex-direction: column;
    }

    .brand-name {
      font-size: 15px;
      font-weight: 600;
      color: var(--text-main);
    }

    .brand-desc {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.2;
    }

    .tokens-line {
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 6px;
      font-size: 12px;
      color: var(--text-dim);
    }

    .badge-tokens {
      background: rgba(99,102,241,0.15);
      border: 1px solid rgba(99,102,241,0.4);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: #c7c9ff;
      font-weight: 500;
    }

    .badge-user {
      background: rgba(255,255,255,0.07);
      border: 1px solid var(--border-mid);
      padding: 2px 8px;
      border-radius: 999px;
      font-size: 11px;
      color: var(--text-main);
      font-weight: 500;
    }

    .right-group {
      display: flex;
      align-items: flex-start;
      gap: 8px;
    }

    .icon-btn {
      background: rgba(255,255,255,0.05);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-ui);
      color: var(--text-main);
      font-size: 17px;
      line-height: 1;
      padding: 10px 12px;
      min-width: 38px;
      text-align: center;
    }

    /* CHAT AREA */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      padding: 0 12px;
      overflow-y: auto;
    }

    .messages {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      row-gap: 12px;
    }

    .bubble-row {
      display: flex;
      width: 100%;
    }

    .bubble.ai {
      max-width: 80%;
      background: var(--bg-bubble-ai);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-bubble);
      border-bottom-left-radius: 4px;
      color: var(--text-main);
      font-size: 15px;
      line-height: 1.4;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user {
      margin-left: auto;
      max-width: 80%;
      background: var(--bg-bubble-user);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius-bubble);
      border-bottom-right-radius: 4px;
      color: #fff;
      font-size: 15px;
      line-height: 1.4;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.system-welcome {
      max-width: 90%;
      margin: 0 auto 8px;
      background: radial-gradient(circle at 20% 20%, rgba(99,102,241,0.18) 0%, rgba(0,0,0,0) 70%);
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: var(--radius-ui);
      color: var(--text-main);
      font-size: 14px;
      line-height: 1.45;
      padding: 12px 14px;
      text-align: center;
    }

    .bubble.system-welcome .title {
      font-weight: 600;
      font-size: 15px;
      margin-bottom: 6px;
      color: #fff;
    }

    .bubble.system-welcome .subtitle {
      color: var(--text-dim);
      font-size: 13px;
      line-height: 1.4;
    }

    /* INPUT BAR (BOTTOM) */
    .input-area-wrapper {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(to top, rgba(10,10,15,1) 0%, rgba(10,10,15,0.6) 60%, rgba(10,10,15,0) 100%);
      padding: 16px 12px 24px;
      display: flex;
      flex-direction: column;
      max-width: 600px;
      margin: 0 auto;
    }

    .input-bar {
      display: flex;
      align-items: flex-end;
      gap: 8px;
      background: #1a1b24;
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: var(--radius-ui);
      padding: 10px;
    }

    .left-action {
      background: rgba(255,255,255,0.07);
      border: 1px solid var(--border-mid);
      border-radius: var(--radius-ui);
      color: var(--text-main);
      font-size: 14px;
      line-height: 1;
      padding: 10px;
      min-width: 38px;
      text-align: center;
    }

    .msg-input {
      flex: 1;
      display: flex;
    }

    textarea {
      background: transparent;
      border: 0;
      outline: 0;
      resize: none;
      width: 100%;
      max-height: 80px;
      font-size: 15px;
      line-height: 1.4;
      color: var(--text-main);
    }

    textarea::placeholder {
      color: var(--text-dim);
    }

    .send-btn {
      background: var(--accent);
      border: 0;
      color: #fff;
      font-weight: 600;
      border-radius: var(--radius-ui);
      font-size: 14px;
      line-height: 1;
      padding: 12px 14px;
      min-width: 64px;
      text-align: center;
    }

    .send-btn[disabled] {
      background: #3f3f46;
      color: #888;
    }

    .status-row {
      text-align: center;
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.4;
      margin-top: 8px;
    }

    .status-row span.tokens-left {
      color: #c7c9ff;
    }

    /* SIDE MENU (burger ‚ò∞) */
    .side-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      z-index: 999;
    }

    .side-panel {
      position: absolute;
      top: 0;
      left: 0;
      width: 80%;
      max-width: 300px;
      height: 100%;
      background: #111218;
      border-right: 1px solid var(--border-mid);
      box-shadow: var(--shadow-menu);
      border-top-right-radius: var(--radius-menu);
      border-bottom-right-radius: var(--radius-menu);
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .side-header {
      display: flex;
      flex-direction: column;
      row-gap: 6px;
    }

    .user-line {
      font-size: 14px;
      color: var(--text-main);
      font-weight: 600;
      display: flex;
      align-items: center;
      flex-wrap: wrap;
      gap: 6px;
    }

    .user-sub {
      font-size: 12px;
      color: var(--text-dim);
      line-height: 1.4;
    }

    .menu-block {
      background: rgba(255,255,255,0.03);
      border: 1px solid var(--border-mid);
      border-radius: var(--radius-ui);
      padding: 12px;
      display: flex;
      flex-direction: column;
      row-gap: 10px;
    }

    .menu-btn {
      background: rgba(255,255,255,0.06);
      border: 1px solid var(--border-soft);
      border-radius: var(--radius-ui);
      color: var(--text-main);
      font-size: 14px;
      font-weight: 500;
      line-height: 1.3;
      padding: 10px 12px;
      text-align: left;
      width: 100%;
    }

    .menu-btn.paypal {
      background: rgba(16,185,129,0.12); /* vert l√©ger */
      border: 1px solid rgba(16,185,129,0.4);
      color: #6ee7b7;
      font-weight: 600;
    }

    .danger-btn {
      background: rgba(220,38,38,0.12);
      border: 1px solid rgba(220,38,38,0.4);
      color: #f87171;
      font-weight: 600;
    }

    .promo-text {
      font-size: 12px;
      line-height: 1.4;
      color: var(--text-dim);
    }

    .promo-strong {
      color: var(--text-main);
      font-weight: 600;
    }

  </style>
</head>
<body>

  <!-- OVERLAY MENU (hidden by default) -->
  <div id="overlay" class="side-overlay">
    <div class="side-panel">
      <div class="side-header">
        <div class="user-line">
          <span id="sideUserStatus">Invit√© üë•</span>
          <span class="badge-tokens" id="sideTokens">Tokens: 0</span>
        </div>
        <div class="user-sub">
          Connecte-toi pour garder ton historique, r√©cup√©rer 5000 tokens et d√©bloquer PayPal.
        </div>
      </div>

      <div class="menu-block">
        <button class="menu-btn" id="btnSignup">Cr√©er un compte / Se connecter</button>
        <button class="menu-btn paypal" id="btnBuy">Recharger mes tokens (PayPal)</button>
        <button class="menu-btn" id="btnHistory">Historique</button>
        <button class="menu-btn" id="btnSettings">Param√®tres</button>
        <button class="danger-btn" id="btnClear">Vider le chat</button>
      </div>

      <div class="promo-text">
        <div class="promo-strong">Philom√®ne IA</div>
        Tu as un probl√®me, j‚Äôai une solution.<br/>
        Tu as une question, j‚Äôai une r√©ponse.<br/>
        Ensemble, on ira plus loin üíú
      </div>

      <div class="promo-text" style="opacity:.6;">
        Disponible FR ‚Ä¢ EN ‚Ä¢ NL<br/>
        Vision, devoirs, recettes, id√©es business, d√©pannage photo.
      </div>

      <div class="menu-btn" style="text-align:center;" id="btnCloseMenu">Fermer le menu ‚úï</div>
    </div>
  </div>

  <!-- TOP BAR -->
  <div class="topbar-wrapper">
    <div class="topbar">
      <div class="left-group">
        <button class="burger-btn" id="openMenu">‚ò∞</button>

        <div class="brand-block">
          <div class="brand-row">
            <div class="avatar-circle">IA</div>
            <div class="brand-texts">
              <div class="brand-name">Philom√®ne IA</div>
              <div class="brand-desc">Assistante personnelle intelligente</div>
            </div>
          </div>

          <div class="tokens-line">
            <span class="badge-user" id="mainUserStatus">Invit√© üë•</span>
            <span class="badge-tokens" id="mainTokens">Tokens: 0</span>
          </div>
        </div>
      </div>

      <div class="right-group">
        <button class="icon-btn" id="plusBtn">+</button>
        <button class="icon-btn" id="moreBtn">‚ãØ</button>
      </div>
    </div>
  </div>

  <!-- CHAT AREA -->
  <div class="chat-area">
    <div class="messages" id="messages">
      <!-- Message de bienvenue de Philom√®ne -->
      <div class="bubble-row">
        <div class="bubble system-welcome">
          <div class="title">Salut üëã Je suis Philom√®ne IA.</div>
          <div class="subtitle">
            Tu as un probl√®me, j‚Äôai une solution.<br/>
            Tu as une question, j‚Äôai une r√©ponse.<br/>
            Ensemble, on ira plus loin.
          </div>
        </div>
      </div>

      <!-- Premier message IA -->
      <div class="bubble-row">
        <div class="bubble ai">
          Je peux t‚Äôaider pour tes devoirs, un texte important,
          un e-mail pro, une recette rapide, une panne technique
          (tu peux m√™me m‚Äôenvoyer une photo üì∏). Dis-moi juste ce dont tu as besoin.
        </div>
      </div>
    </div>
  </div>

  <!-- INPUT AREA -->
  <div class="input-area-wrapper">
    <div class="input-bar">
      <button class="left-action" id="photoBtn">üì∑</button>

      <div class="msg-input">
        <textarea
          id="userInput"
          placeholder="√âcris ton message‚Ä¶"
          rows="1"
        ></textarea>
      </div>

      <button class="send-btn" id="sendBtn">Envoyer</button>
    </div>

    <div class="status-row">
      <span id="statusText">Pr√™t.</span>
      &nbsp;‚Ä¢&nbsp;
      <span class="tokens-left" id="footerTokens">0 tokens restants</span>
    </div>
  </div>

  <script>
    // CONFIG -------------------------------------------------
    const API_BASE = "https://api.philomeneia.com"; // backend Render
    const DEFAULT_USER = "guest"; // en attendant Clerk
    //---------------------------------------------------------

    // DOM refs
    const messagesEl = document.getElementById("messages");
    const inputEl = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const statusText = document.getElementById("statusText");
    const footerTokens = document.getElementById("footerTokens");
    const mainTokens = document.getElementById("mainTokens");
    const sideTokens = document.getElementById("sideTokens");
    const mainUserStatus = document.getElementById("mainUserStatus");
    const sideUserStatus = document.getElementById("sideUserStatus");

    const overlayEl = document.getElementById("overlay");
    const openMenuBtn = document.getElementById("openMenu");
    const closeMenuBtn = document.getElementById("btnCloseMenu");
    const clearBtn = document.getElementById("btnClear");

    // UI helpers
    function addBubble(text, who="ai") {
      const row = document.createElement("div");
      row.className = "bubble-row";

      const bubble = document.createElement("div");
      bubble.className = "bubble " + (who === "user" ? "user" : "ai");
      bubble.textContent = text;
      row.appendChild(bubble);

      messagesEl.appendChild(row);
      messagesEl.scrollTop = messagesEl.scrollHeight;
    }

    function setTokensDisplay(v) {
      const t = Number(v||0);
      footerTokens.textContent = t + " tokens restants";
      mainTokens.textContent = "Tokens: " + t;
      sideTokens.textContent = "Tokens: " + t;
    }

    function setUserStatus(emailOrGuest) {
      if (!emailOrGuest || emailOrGuest === "guest") {
        mainUserStatus.textContent = "Invit√© üë•";
        sideUserStatus.textContent = "Invit√© üë•";
      } else {
        mainUserStatus.textContent = "Connect√© ‚úÖ";
        sideUserStatus.textContent = emailOrGuest;
      }
    }

    async function safeFetch(url, options={}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (err) {
        console.error(err);
        statusText.textContent = "Erreur r√©seau.";
        return null;
      }
    }

    async function refreshBalance() {
      const data = await safeFetch(API_BASE + "/api/balance?userId=" + encodeURIComponent(DEFAULT_USER));
      if (data && typeof data.free !== "undefined") {
        setTokensDisplay(data.free);
        statusText.textContent = "Pr√™t.";
      }
    }

    async function sendMessage() {
      const text = (inputEl.value || "").trim();
      if (!text) return;
      inputEl.value = "";

      addBubble(text, "user");

      sendBtn.disabled = true;
      sendBtn.textContent = "‚Ä¶";
      statusText.textContent = "Philom√®ne r√©fl√©chit‚Ä¶";

      const body = {
        userId: DEFAULT_USER,
        message: text
      };

      const rep = await safeFetch(API_BASE + "/api/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (rep && rep.reply) {
        addBubble(rep.reply, "ai");
        if (typeof rep.remaining !== "undefined") {
          setTokensDisplay(rep.remaining);
        }
        statusText.textContent = "Pr√™t.";
      } else if (rep && rep.error === "Solde insuffisant") {
        addBubble("Tu n'as plus de tokens gratuits. Va dans le menu ‚ò∞ et recharge via PayPal pour continuer üí≥.", "ai");
        statusText.textContent = "Plus de tokens.";
      } else {
        addBubble("D√©sol√©, impossible d‚Äôobtenir une r√©ponse maintenant.", "ai");
        statusText.textContent = "Erreur serveur.";
      }

      sendBtn.disabled = false;
      sendBtn.textContent = "Envoyer";
    }

    async function clearChat() {
      // c√¥t√© visuel
      const keep = document.querySelectorAll(".system-welcome");
      messagesEl.innerHTML = "";
      keep.forEach(k => {
        const row = document.createElement("div");
        row.className = "bubble-row";
        row.appendChild(k.cloneNode(true));
        messagesEl.appendChild(row);
      });

      // message IA apr√®s reset
      addBubble("Historique effac√©. On repart de z√©ro ü§ù", "ai");

      // c√¥t√© serveur
      await safeFetch(API_BASE + "/api/clear", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: DEFAULT_USER })
      });
    }

    // menu overlay open/close
    function openMenu() {
      overlayEl.style.display = "block";
    }
    function closeMenu() {
      overlayEl.style.display = "none";
    }

    // EVENTS
    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    openMenuBtn.addEventListener("click", openMenu);
    closeMenuBtn.addEventListener("click", closeMenu);
    overlayEl.addEventListener("click", (e) => {
      // si on tape dehors du panneau, on ferme
      if (e.target.id === "overlay") closeMenu();
    });

    clearBtn.addEventListener("click", async () => {
      await clearChat();
      closeMenu();
    });

    // init
    (async () => {
      setUserStatus("guest");
      await refreshBalance();
    })();
  </script>
</body>
</html>

import express from "express";
import multer from "multer";
import OpenAI from "openai";
import fs from "fs";

const router = express.Router();
const upload = multer({ dest: "uploads/" });

// ---------------------
// üîß CONFIG OPENAI
// ---------------------
const client = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

// ---------------------
// üß† SYSTEM PROMPT
// ---------------------
const SYSTEM_PROMPT = `
Tu es **Philom√®ne ‚Äì Prof priv√©**, un professeur particulier patient, clair et rassurant.

üéØ **Ta mission**
Aider l'√©l√®ve √† comprendre et r√©ussir ses exercices **sans juste donner la r√©ponse**, mais en expliquant **pas √† pas**.

üë©‚Äçüè´ **Niveaux & programmes**
- Tu peux aider pour l'√©cole en **Belgique** üáßüá™ et en **France** üá´üá∑.
- Si le niveau n‚Äôest pas pr√©cis√©, tu **d√©duis** le niveau (primaire, coll√®ge, secondaire‚Ä¶) d‚Äôapr√®s l‚Äô√©nonc√©.
- Si l‚Äôexercice est trop vague, tu poses **1 petite question de clarification maximum**.

üì∏ **Exercices en texte ou en photo**
L‚Äôutilisateur peut :
- √©crire l‚Äô√©nonc√©,
- ou envoyer une **photo**,
- ou les deux.
Tu consid√®res que tout le contenu est d√©j√† fourni dans le message utilisateur.

üß† **M√©thode de r√©ponse**
Tu dois toujours suivre ce format :

1. **Reformulation simple**
   ¬´ Si je r√©sume, on te demande de‚Ä¶ ¬ª

2. **Petit rappel du cours**
   Court, clair, utile.

3. **Explication √©tape par √©tape**
   Avec des phrases simples et p√©dagogiques.

4. **R√©ponse finale**
   Bien mise en valeur :  
   **R√©ponse : ‚Ä¶**

5. **Mini r√©sum√© + 1 exercice similaire**
   Pour aider l‚Äô√©l√®ve √† retenir.

üö´ **Tu ne dois pas :**
- Donner une r√©ponse brute sans explication.
- Inventer des informations absentes de l'exercice.
- Faire des explications compliqu√©es : reste simple et gentil.

Tu parles toujours en **fran√ßais**, avec un ton **bienveillant**, comme un vrai prof particulier.
`;

// ---------------------
// üìå ROUTE PRINCIPALE
// ---------------------
router.post("/", upload.single("image"), async (req, res) => {
  try {
    const userText = req.body.text || "";
    let imageContent = null;

    // ‚Üí Si une image est envoy√©e
    if (req.file) {
      const imageBuffer = fs.readFileSync(req.file.path);
      imageContent = imageBuffer.toString("base64");

      // on efface l'image apr√®s lecture
      fs.unlinkSync(req.file.path);
    }

    // ---------------------
    // üî• APPEL OPENAI
    // ---------------------
    const response = await client.responses.create({
      model: "gpt-4.1",
      max_output_tokens: 800,
      input: [
        {
          role: "system",
          content: SYSTEM_PROMPT,
        },
        {
          role: "user",
          content: [
            { type: "text", text: userText },
            imageContent
              ? {
                  type: "input_image",
                  image_url: `data:image/jpeg;base64,${imageContent}`,
                }
              : null,
          ].filter(Boolean),
        },
      ],
    });

    const aiText =
      response.output_text || response.output[0]?.content || "Erreur texte.";

    res.json({ success: true, result: aiText });
  } catch (error) {
    console.error("Erreur prof :", error);
    res.json({
      success: false,
      error: "Erreur lors de la g√©n√©ration. R√©essaie dans un instant.",
    });
  }
});

export default router;

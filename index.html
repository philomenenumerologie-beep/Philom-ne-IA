<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>Philomenia Messenger üí¨</title>
  <style>
    :root{
      --bg:#eaf3ff;--panel:#fff;--text:#0b1b33;--border:#c8d6f2;
      --a1:#3a84ff;--a2:#8ec0ff;
      --me:#e6f0ff;--bot:#f1f5ff;
    }
    @media (prefers-color-scheme:dark){
      :root{
        --bg:#0e1117;--panel:#171c24;--text:#eef2ff;--border:#2a3550;
        --a1:#3a84ff;--a2:#68a2ff;--me:#20335a;--bot:#222838;
      }
    }
    html,body{height:100%;margin:0}
    body{
      background:var(--bg);color:var(--text);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Ubuntu,"Helvetica Neue",Arial;
      display:flex;justify-content:flex-start;align-items:center;flex-direction:column;
      min-height:100dvh;
    }
    .win{
      width:min(640px,95vw);height:min(90dvh,900px);margin:1rem 0;background:var(--panel);
      border:2px solid var(--border);border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,.15);
      display:flex;flex-direction:column;overflow:hidden;transform:translateZ(0);
    }
    header{
      background:linear-gradient(#5aa3ff,#8ec0ff);color:#fff;display:flex;align-items:center;justify-content:space-between;
      padding:.45rem .6rem;user-select:none
    }
    header h1{margin:0;font-size:.95rem;display:flex;gap:.5rem;align-items:center}
    .btns{display:flex;gap:.35rem}
    .icon{
      border:none;border-radius:6px;padding:.25rem .45rem;background:rgba(255,255,255,.22);color:#fff;cursor:pointer
    }
    .icon:hover{background:rgba(255,255,255,.35)}
    #chat{
      flex:1;overflow:auto;padding:1rem;display:flex;flex-direction:column;gap:.6rem;scroll-behavior:smooth;
      background:
        radial-gradient(ellipse at top left, rgba(255,255,255,.25) 0 30%, transparent 30%) top 12px left 12px/14px 14px no-repeat,
        transparent;
    }
    .msg{max-width:82%;padding:.5rem .6rem;border-radius:8px;word-wrap:break-word;overflow-wrap:anywhere;border:1px solid var(--border)}
    .bot{background:var(--bot)}
    .me{background:var(--me);align-self:flex-end}
    .sys{opacity:.8;font-style:italic}
    footer{
      border-top:1px solid var(--border);padding:.5rem;display:flex;gap:.45rem;align-items:center;
      position:relative
    }
    textarea#input{
      flex:1;min-height:42px;max-height:120px;padding:.55rem .6rem;border:1px solid var(--border);
      border-radius:8px;resize:none;font:inherit;background:#fff;color:inherit
    }
    .send{background:var(--a1);color:#fff;border:none;border-radius:8px;padding:.6rem .9rem;font-weight:600;cursor:pointer}
    .send:hover{background:var(--a2)}
    .quota{font-size:.83rem;color:#6b7280;border-top:1px solid var(--border);padding:.35rem .8rem}
    /* mobile barre input fixe */
    .win{contain:layout size style}
    /* modale param√®tres / abonnements */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;padding:1rem}
    .modal.open{display:flex}
    .card{width:min(700px,95vw);max-height:85dvh;overflow:auto;background:var(--panel);color:var(--text);
      border:1px solid var(--border);border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.25);padding:1rem}
    .card h2{margin:.2rem 0 .4rem}
    .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:.8rem}
    .plan{border:1px solid var(--border);border-radius:10px;padding:.8rem}
    .plan h3{margin:.2rem 0}
    .badge{display:inline-block;background:var(--a1);color:#fff;border-radius:999px;padding:.15rem .5rem;font-size:.75rem}
    .row{display:flex;gap:.5rem;align-items:center;flex-wrap:wrap}
    .hint{font-size:.85rem;opacity:.8}
    .pill{background:#eef3ff;color:#111;border:1px solid var(--border);border-radius:999px;padding:.2rem .5rem;font-size:.8rem}
    .hide{display:none}
    /* mini toaster */
    .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:14px;background:#111;color:#fff;padding:.6rem .9rem;border-radius:8px;opacity:0;transition:.25s}
    .toast.show{opacity:1}
  </style>
  <!-- PayPal SDK (Sandbox). Remplace client-id (YOUR-PAYPAL-CLIENT-ID). Pour LIVE, utilise https://www.paypal.com/sdk/js?... -->
  <script src="https://www.paypal.com/sdk/js?client-id=YOUR-PAYPAL-CLIENT-ID&currency=EUR&vault=true" defer></script>
</head>
<body>
  <div class="win" id="win">
    <header>
      <h1>üí¨ Philomenia Messenger</h1>
      <div class="btns">
        <button class="icon" id="nudgeBtn" title="Nudge (secousse)">ü´®</button>
        <button class="icon" id="downloadBtn" title="T√©l√©charger">‚¨áÔ∏è</button>
        <button class="icon" id="printBtn" title="Imprimer">üñ®Ô∏è</button>
        <button class="icon" id="attachBtn" title="Joindre une image">üìé</button>
        <button class="icon" id="settingsBtn" title="Param√®tres & Abonnements">‚öôÔ∏è</button>
        <input type="file" id="imageInput" accept="image/*" class="hide" />
      </div>
    </header>

    <div id="chat" aria-live="polite">
      <div class="msg bot">Bonjour üëã √âcris-moi ci-dessous (style MSN activ√© !)</div>
    </div>

    <footer>
      <textarea id="input" placeholder="√âcris ton message‚Ä¶ (Entr√©e pour envoyer)"></textarea>
      <button class="send" id="sendBtn">Envoyer</button>
    </footer>

    <div class="quota" id="quotaInfo">Pr√™t.</div>
  </div>

  <!-- MODALE param√®tres / abonnements -->
  <div class="modal" id="settingsModal" aria-hidden="true">
    <div class="card">
      <div class="row" style="justify-content:space-between">
        <h2>Param√®tres & Abonnements</h2>
        <button class="icon" id="closeSettings">‚úñ</button>
      </div>

      <p class="hint">Forfait actuel : <span id="tierLabel" class="pill">free</span> ‚Äî Tokens restants : <span id="remainLabel">‚Äî</span></p>

      <h3>Abonnements PayPal</h3>
      <div class="plans">
        <div class="plan">
          <h3>Mini Mensuel <span class="badge">1,49 ‚Ç¨</span></h3>
          <p class="hint">‚âà 1 000 tokens / mois</p>
          <div id="pp-mini-month"></div>
        </div>
        <div class="plan">
          <h3>Pro Mensuel <span class="badge">4,90 ‚Ç¨</span></h3>
          <p class="hint">‚âà 5 000 tokens / mois</p>
          <div id="pp-pro-month"></div>
        </div>
        <div class="plan">
          <h3>Mini Annuel <span class="badge">15 ‚Ç¨</span></h3>
          <p class="hint">‚âà 12 000 tokens / an</p>
          <div id="pp-mini-year"></div>
        </div>
        <div class="plan">
          <h3>Pro Annuel <span class="badge">50 ‚Ç¨</span></h3>
          <p class="hint">‚âà 60 000 tokens / an</p>
          <div id="pp-pro-year"></div>
        </div>
      </div>

      <hr style="margin:1rem 0;border-color:var(--border)">
      <h3>Options</h3>
      <div class="row">
        <button class="icon" id="forceFree">Basculer sur Free</button>
        <button class="icon" id="forceMini">Basculer sur Mini</button>
        <button class="icon" id="forcePro">Basculer sur Pro</button>
        <button class="icon" id="refreshQuota">Rafra√Æchir quota</button>
      </div>
      <p class="hint">Les bascules locales servent pour tester l‚ÄôUI. Le vrai statut vient de PayPal c√¥t√© serveur quand tu l‚Äôint√©greras compl√®tement.</p>
    </div>
  </div>

  <!-- Sons MSN (data URI l√©gers) -->
  <audio id="snd-send" preload="auto" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAA..."></audio>
  <audio id="snd-recv" preload="auto" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAA..."></audio>
  <audio id="snd-nudge" preload="auto" src="data:audio/wav;base64,UklGRiQAAABXQVZFZm10IBAAAAABAAEAESsAACJWAAACABYAAAAA..."></audio>

  <div class="toast" id="toast"></div>

  <script>
    // ===================== CONFIG =====================
    const BACKEND_URL = "https://philo-backend-su29.onrender.com"; // ton backend Render
    const CLIENT_ID = localStorage.getItem("clientId") || crypto.randomUUID();
    localStorage.setItem("clientId", CLIENT_ID);
    let tier = localStorage.getItem("tier") || "free"; // free | mini | pro
    // ==================================================

    // ======= UI refs
    const win = document.getElementById("win");
    const chat = document.getElementById("chat");
    const input = document.getElementById("input");
    const sendBtn = document.getElementById("sendBtn");
    const attachBtn = document.getElementById("attachBtn");
    const imageInput = document.getElementById("imageInput");
    const printBtn = document.getElementById("printBtn");
    const downloadBtn = document.getElementById("downloadBtn");
    const settingsBtn = document.getElementById("settingsBtn");
    const nudgeBtn = document.getElementById("nudgeBtn");
    const quotaInfo = document.getElementById("quotaInfo");

    const settingsModal = document.getElementById("settingsModal");
    const closeSettings = document.getElementById("closeSettings");
    const tierLabel = document.getElementById("tierLabel");
    const remainLabel = document.getElementById("remainLabel");
    const forceFree = document.getElementById("forceFree");
    const forceMini = document.getElementById("forceMini");
    const forcePro = document.getElementById("forcePro");
    const refreshQuota = document.getElementById("refreshQuota");

    const sndSend = document.getElementById("snd-send");
    const sndRecv = document.getElementById("snd-recv");
    const sndNudge = document.getElementById("snd-nudge");
    const toast = document.getElementById("toast");

    // ======= helper
    function addMessage(text, who="bot"){
      const div=document.createElement("div");
      div.className=`msg ${who}`;
      div.textContent=text;
      chat.appendChild(div);
      chat.scrollTop=chat.scrollHeight;
    }
    function showToast(msg){
      toast.textContent=msg; toast.classList.add("show");
      setTimeout(()=>toast.classList.remove("show"),1700);
    }

    // ======= nudge (secousse + son)
    function nudge(){
      sndNudge?.play().catch(()=>{});
      win.animate(
        [{transform:"translateX(0)"},{transform:"translateX(-6px)"},{transform:"translateX(6px)"},{transform:"translateX(0)"}],
        {duration:400,iterations:2}
      );
    }

    // ======= Quota
    async function updateQuota(){
      try{
        const r=await fetch(`${BACKEND_URL}/api/quota`,{
          headers:{ "x-client-id":CLIENT_ID,"x-tier":tier }
        });
        const d=await r.json();
        tierLabel.textContent=d.tier||tier;
        remainLabel.textContent=d.remaining ?? "‚Äî";
        quotaInfo.textContent=`Forfait : ${d.tier||tier} ‚Ä¢ ${d.remaining} tokens restants`;
      }catch(e){
        quotaInfo.textContent=`Forfait : ${tier} ‚Ä¢ (quota indisponible)`;
      }
    }

    // ======= envoyer
    async function sendMessage(imageData){
      const text = input.value.trim();
      if(!text && !imageData) return;

      if(text){ addMessage(text,"me"); sndSend?.play().catch(()=>{}); }
      input.value="";

      const body = { message:text };
      if(imageData) body.image = imageData;

      const r=await fetch(`${BACKEND_URL}/api/chat`,{
        method:"POST",
        headers:{
          "Content-Type":"application/json",
          "x-client-id":CLIENT_ID,
          "x-tier":tier
        },
        body:JSON.stringify(body)
      });
      const d=await r.json();

      if(d.reply){ addMessage(d.reply,"bot"); sndRecv?.play().catch(()=>{}); }
      if(d.quota){
        quotaInfo.textContent=`Forfait : ${d.quota.tier} ‚Ä¢ ${d.quota.remaining} tokens restants`;
        tierLabel.textContent=d.quota.tier;
        remainLabel.textContent=d.quota.remaining;
      }
      if(d.error){ showToast(d.error); }
    }

    // ======= events
    sendBtn.onclick=()=>sendMessage();
    input.addEventListener("keydown",e=>{
      if(e.key==="Enter" && !e.shiftKey){ e.preventDefault(); sendMessage(); }
    });

    attachBtn.onclick=()=>imageInput.click();
    imageInput.onchange=()=>{
      const f=imageInput.files?.[0]; if(!f) return;
      const reader=new FileReader();
      reader.onload=()=>{ sendMessage(reader.result); showToast("Image jointe envoy√©e"); };
      reader.readAsDataURL(f);
    };

    printBtn.onclick=()=>window.print();
    downloadBtn.onclick=()=>{
      const lines=[...chat.querySelectorAll(".msg")].map(m=> (m.classList.contains("me")?"Moi: ":"Œ¶: ")+m.textContent );
      const blob=new Blob([lines.join("\n\n")],{type:"text/plain;charset=utf-8"});
      const a=document.createElement("a"); a.href=URL.createObjectURL(blob);
      a.download=`philomenia_chat_${Date.now()}.txt`; a.click();
      URL.revokeObjectURL(a.href);
    };

    settingsBtn.onclick=()=>{ settingsModal.classList.add("open"); settingsModal.setAttribute("aria-hidden","false"); };
    closeSettings.onclick=()=>{ settingsModal.classList.remove("open"); settingsModal.setAttribute("aria-hidden","true"); };
    settingsModal.addEventListener("click",e=>{ if(e.target===settingsModal) closeSettings.click(); });

    nudgeBtn.onclick=()=>nudge();

    // boutons test de forfait local (UI only)
    function setTier(t){ tier=t; localStorage.setItem("tier",t); updateQuota(); showToast(`Forfait local : ${t}`); }
    forceFree.onclick=()=>setTier("free");
    forceMini.onclick=()=>setTier("mini");
    forcePro.onclick=()=>setTier("pro");
    refreshQuota.onclick=()=>updateQuota();

    // ======= Mobile: garder la fen√™tre stable quand clavier s‚Äôouvre
    // (100dvh + scrollIntoView si besoin)
    input.addEventListener("focus",()=>{
      setTimeout(()=>{ sendBtn.scrollIntoView({block:"nearest"}); },100);
    });

    // ======= init
    addMessage("Hello! How can I assist you today?","bot");
    updateQuota();

    // ======= PayPal Buttons (montants fixes ‚Äî Sandbox)
    // NOTE: Remplace "YOUR-PAYPAL-CLIENT-ID" dans la balise <script> en haut.
    // Ici on cr√©e des paiements simples (non-subscription) pour d√©mo.
    function renderPP(id, valueEUR, label){
      if(!window.paypal){ document.getElementById(id).innerHTML='<div class="hint">‚ö†Ô∏è Configure ton Client ID PayPal (Sandbox) pour afficher le bouton.</div>'; return; }
      paypal.Buttons({
        style:{ layout:"vertical", color:"blue", shape:"pill", label:"paypal" },
        createOrder:(data,actions)=>{
          return actions.order.create({
            purchase_units:[{ amount:{ currency_code:"EUR", value:String(valueEUR) }, description:`${label}` }]
          });
        },
        onApprove: async (data,actions)=>{
          await actions.order.capture();
          // Ici, c√¥t√© vrai app : appeler ton backend pour valider et enregistrer niveau
          // await fetch(`${BACKEND_URL}/api/paypal/verify`, { ... })
          // Pour la d√©mo on bascule l‚ÄôUI localement :
          if(/Mini/.test(label)) setTier("mini"); else setTier("pro");
          showToast(`Paiement valid√© : ${label}`);
        },
        onError: ()=> showToast("Erreur PayPal")
      }).render(`#${id}`);
    }

    window.addEventListener("load",()=>{
      renderPP("pp-mini-month", 1.49, "Mini Mensuel");
      renderPP("pp-pro-month",  4.90, "Pro Mensuel");
      renderPP("pp-mini-year", 15.00, "Mini Annuel");
      renderPP("pp-pro-year",  50.00, "Pro Annuel");
    });
  </script>
</body>
</html>

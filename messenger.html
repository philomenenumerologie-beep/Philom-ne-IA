<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Philomenia Messenger</title>

  <!-- Clerk Frontend -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { --bg:#071826; --panel:#0e2238; --muted:#9bb3c9; --accent:#3aa0ff; --danger:#ff4646; }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }
    .wrap { max-width:920px; margin:0 auto; padding:22px; }
    h1 { margin:6px 0; font-size:28px; text-align:center; }
    .topline { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:8px; color:var(--muted); margin-bottom:14px; font-size:14px; }
    .badge { display:inline-flex; align-items:center; gap:6px; padding:4px 10px; background:#0f2b47; border:1px solid #234c77; border-radius:999px; }
    .tokens { font-weight:700; color:#fff; }
    .logout { background:var(--danger); color:#fff; border:0; border-radius:10px; padding:8px 12px; font-weight:600; cursor:pointer; }
    .panel { background:var(--panel); border:1px solid #173a5c; border-radius:12px; padding:14px; }
    .alert { margin:0 4px 8px; color:var(--muted); }
    .chatbox { height:56vh; min-height:280px; overflow:auto; padding:12px; background:#0b1d31; border:1px solid #153150; border-radius:10px; }
    .msg { max-width:88%; margin:8px 0; padding:10px 12px; border-radius:10px; line-height:1.35; font-size:15px; white-space:pre-wrap; word-wrap:break-word; }
    .me { margin-left:auto; background:#133a6d; border:1px solid #2d65a2; }
    .bot { background:#0f2b47; border:1px solid #2a527e; }
    .row { display:flex; gap:10px; margin-top:10px; }
    textarea { flex:1; height:54px; resize:none; background:#0b1d31; border:1px solid #173a5c; color:#fff; border-radius:10px; padding:12px; font-size:15px; outline:none; }
    button { cursor:pointer; border:0; border-radius:10px; padding:12px 14px; font-weight:600; }
    .send { background:var(--accent); color:#001427; min-width:120px; }
    .photo { background:#00bcd4; color:#001427; min-width:120px; }
    .right { text-align:right; color:var(--muted); font-size:13px; margin-top:10px; }
    input[type=file] { display:none; }
    .preview { font-size:12px; color:#beddff; opacity:.9; margin-top:6px; }
  </style>
</head>
<body>
  <div class="wrap">
    <h1>Philomenia Messenger</h1>

    <div class="topline">
      <span id="connectedAs" class="badge">Connexion…</span>
      <span class="badge tokens">Tokens : <span id="tokFree">0</span> / <span id="tokPaid">0</span></span>
      <button id="logout" class="logout">Se déconnecter</button>
    </div>

    <div class="panel">
      <div id="alert" class="alert">Bonjour 👋 Tape un message et envoie.</div>

      <div id="chat" class="chatbox">
        <div class="msg bot">Bonjour ! Comment puis-je vous aider aujourd’hui ?</div>
      </div>

      <div id="preview" class="preview"></div>

      <div class="row">
        <textarea id="input" placeholder="Écris ton message… (Entrée = envoyer)"></textarea>
        <button id="send" class="send">Envoyer</button>
        <label for="file" class="photo">📷 Photo</label>
        <input id="file" type="file" accept="image/*" />
      </div>
    </div>

    <div class="right">
      Solde • Gratuit : <span id="fBalance">0</span> • Payant : <span id="pBalance">0</span>
    </div>
  </div>

  <script>
    const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    const fileInput = $("file");
    const preview = $("preview");

    function addMsg(text, cls) {
      const div = document.createElement("div");
      div.className = "msg " + cls;
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function safeFetch(url, options={}) {
      try {
        const res = await fetch(url, options);
        if (!res.ok) throw new Error("HTTP " + res.status);
        return await res.json();
      } catch (e) {
        console.error(e);
        $("alert").textContent = "⚠️ Échec de chargement (" + (e.message || "erreur") + ")";
        return null;
      }
    }

    // Clerk + page
    window.addEventListener("load", async () => {
      await Clerk.load();
      if (!Clerk.user) { window.location.href = "/"; return; }

      const mail = Clerk.user.primaryEmailAddress?.emailAddress || "inconnu";
      $("connectedAs").textContent = "Connecté ✅ : " + mail;

      $("logout").onclick = async () => { await Clerk.signOut(); window.location.href = "/"; };

      refreshBalances();

      const sendBtn = $("send");
      const input = $("input");

      async function sendText() {
        const text = input.value.trim();
        if (!text) return;
        input.value = "";
        addMsg(text, "me");

        sendBtn.disabled = true; sendBtn.textContent = "…";

        const payload = { message: text, email: mail };
        const data = await safeFetch("/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        if (data && data.reply) {
          addMsg(data.reply, "bot");
          refreshBalances();
        } else {
          addMsg("Désolé, impossible d’obtenir une réponse pour le moment.", "bot");
        }

        sendBtn.disabled = false; sendBtn.textContent = "Envoyer";
      }

      sendBtn.onclick = sendText;

      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendText(); }
      });

      // Photo upload
      fileInput.addEventListener("change", async () => {
        if (!fileInput.files?.length) return;
        const f = fileInput.files[0];
        preview.textContent = f ? `Photo sélectionnée: ${f.name} (${Math.round(f.size/1024)} Ko)` : "";

        const form = new FormData();
        form.append("photo", f);
        form.append("instruction", "Analyse complète (objets, panne/erreur, OCR, conseils).");

        addMsg("(Photo envoyée)", "me");

        const resp = await fetch("/api/photo", { method: "POST", body: form }).catch(() => null);
        if (!resp || !resp.ok) {
          addMsg("Désolé, impossible d’analyser la photo pour le moment.", "bot");
          return;
        }
        const data = await resp.json();
        if (data && data.reply) addMsg(data.reply, "bot");
        else addMsg("Analyse indisponible.", "bot");

        preview.textContent = "";
        fileInput.value = "";
      });
    });

    async function refreshBalances() {
      const data = await safeFetch("/api/balance");
      if (!data) return;
      const free = Number(data.free || 0);
      const paid = Number(data.paid || 0);
      $("tokFree").textContent = free;
      $("tokPaid").textContent = paid;
      $("fBalance").textContent = free;
      $("pBalance").textContent = paid;
      $("alert").textContent = "Prêt ✅";
    }
  </script>
</body>
</html>

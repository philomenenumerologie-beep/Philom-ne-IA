<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <!-- CONFIG GLOBALE -->
  <meta name="api-base" content="https://api.philomeneia.com" />
  <meta name="clerk-publishable-key" content="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA" />

  <title>Philom√®ne IA</title>
  <style>
    :root {
      --bg-app: #0d1f2e;
      --bg-card: #142a3f;
      --bg-header: #0d1f2e;
      --text-main: #ffffff;
      --text-dim: #9bb1c7;
      --accent-blue: #0066ff;
      --accent-red: #ff3b30;
      --accent-green: #00c853;
      --accent-yellow: #ffc400;
      --border-soft: rgba(255,255,255,0.08);
      --bubble-user: #003b82;
      --bubble-assistant: #142a3f;
      --bubble-system: #0f2538;
    }

    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
    }

    body {
      margin: 0;
      background-color: var(--bg-app);
      color: var(--text-main);
      font-family: -apple-system, BlinkMacSystemFont, "Inter", "SF Pro Text", Roboto, system-ui, sans-serif;
      display: flex;
      flex-direction: column;
      min-height: 100vh;
    }

    header {
      background: var(--bg-header);
      color: var(--text-main);
      border-bottom: 1px solid var(--border-soft);
      padding: 12px;
      position: sticky;
      top: 0;
      z-index: 20;
    }

    .header-topline {
      display: flex;
      flex-wrap: wrap;
      align-items: flex-start;
      justify-content: space-between;
      row-gap: 8px;
    }

    .user-block {
      display: flex;
      flex-direction: column;
      font-size: 14px;
      line-height: 1.3;
    }
    .user-row1 {
      display: flex;
      flex-wrap: wrap;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      color: var(--text-main);
    }
    .status-chip {
      background: #1a2f44;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 13px;
      line-height: 1.2;
      display: flex;
      align-items: center;
      gap: 4px;
      color: var(--text-main);
    }
    .status-chip .check {
      color: var(--accent-green);
      font-weight: 600;
    }
    .status-chip .guest {
      color: var(--text-main);
    }

    .tokens-chip {
      background: #1a2f44;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      padding: 4px 8px;
      font-size: 13px;
      line-height: 1.2;
      font-weight: 500;
      color: var(--accent-yellow);
    }

    .user-email {
      font-size: 13px;
      color: var(--text-dim);
      font-weight: 400;
    }

    .header-buttons {
      display: flex;
      flex-wrap: wrap;
      justify-content: flex-end;
      gap: 8px;
    }

    .btn-small {
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      background: #1a2f44;
      color: var(--text-main);
      font-size: 14px;
      line-height: 1.2;
      font-weight: 500;
      padding: 8px 10px;
      min-width: max-content;
    }
    .btn-danger {
      background: var(--accent-red);
      border: none;
      color: #fff;
      font-weight: 600;
    }

    .intro-panel {
      background: var(--bg-card);
      border: 1px solid var(--border-soft);
      border-radius: 10px;
      padding: 16px;
      margin-top: 12px;
      color: var(--text-main);
      font-size: 15px;
      line-height: 1.5;
    }

    .intro-title {
      font-size: 18px;
      font-weight: 600;
      margin: 0 0 12px 0;
      color: #fff;
    }

    .intro-desc {
      color: var(--text-main);
      margin-bottom: 12px;
    }

    .intro-bullets {
      background: #0f2538;
      border-radius: 8px;
      border: 1px solid var(--border-soft);
      padding: 12px;
      color: var(--text-main);
      font-size: 14px;
      line-height: 1.4;
    }

    .intro-bullets ul {
      margin: 0;
      padding-left: 20px;
    }
    .intro-bullets li {
      margin-bottom: 8px;
    }
    .intro-note {
      font-size: 13px;
      line-height: 1.4;
      margin-top: 12px;
      color: var(--text-dim);
    }

    .chat-wrapper {
      flex: 1;
      display: flex;
      flex-direction: column;
      min-height: 0;
    }

    .messages-area {
      flex: 1;
      overflow-y: auto;
      padding: 16px 12px 120px;
    }

    .bubble {
      max-width: 90%;
      background: var(--bubble-assistant);
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.45;
      border-radius: 10px;
      border: 1px solid var(--border-soft);
      padding: 12px 14px;
      margin-bottom: 10px;
      white-space: pre-wrap;
      word-wrap: break-word;
    }

    .bubble.user {
      background: var(--bubble-user);
      border-color: rgba(0,0,0,0.3);
      align-self: flex-end;
    }

    .bubble.system {
      background: var(--bubble-system);
      color: #fff;
      border: 1px solid var(--border-soft);
      font-weight: 500;
    }

    .messages-list {
      display: flex;
      flex-direction: column;
    }

    .input-bar-outer {
      position: fixed;
      left: 0;
      right: 0;
      bottom: 0;
      background: var(--bg-app);
      border-top: 1px solid var(--border-soft);
      padding: 12px;
      z-index: 30;
    }

    .input-row {
      display: flex;
      flex-wrap: nowrap;
      align-items: stretch;
      gap: 8px;
    }

    .btn-photo {
      background: #1f2f3f;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      padding: 10px 12px;
      font-size: 16px;
      color: var(--text-main);
      display: flex;
      align-items: center;
      justify-content: center;
      min-width: 44px;
    }

    .field-wrap {
      flex: 1;
      background: #1f2f3f;
      border: 1px solid var(--border-soft);
      border-radius: 8px;
      display: flex;
      align-items: center;
      padding: 0 10px;
    }
    .field-wrap input {
      background: transparent;
      border: none;
      outline: none;
      width: 100%;
      font-size: 16px;
      line-height: 1.4;
      color: var(--text-main);
      padding: 10px 0;
    }

    .btn-wizz {
      background: #2a2115;
      border: 1px solid #7a4a00;
      color: #ffc400;
      font-weight: 600;
      border-radius: 8px;
      padding: 10px 12px;
      min-width: 60px;
      font-size: 16px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      text-align: center;
    }
    .btn-wizz span {
      display: flex;
      flex-direction: row;
      align-items: center;
      gap: 4px;
      justify-content: center;
      font-size: 15px;
      line-height: 1.2;
    }

    .btn-send {
      background: var(--accent-blue);
      border-radius: 8px;
      border: none;
      color: #fff;
      font-size: 16px;
      line-height: 1.2;
      font-weight: 600;
      padding: 10px 14px;
      min-width: 88px;
    }

    .token-line {
      text-align: right;
      color: var(--text-dim);
      font-size: 14px;
      margin-top: 6px;
    }

    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      display: none;
      align-items: flex-end;
      justify-content: center;
      z-index: 50;
    }
    .overlay.active {
      display: flex;
    }
    .settings-panel {
      background: var(--bg-card);
      border-top-left-radius: 16px;
      border-top-right-radius: 16px;
      width: 100%;
      max-width: 480px;
      border: 1px solid var(--border-soft);
      border-bottom: none;
      padding: 16px;
      color: var(--text-main);
      font-size: 16px;
      line-height: 1.4;
    }
    .settings-title {
      font-size: 17px;
      font-weight: 600;
      margin-bottom: 12px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      color: #fff;
    }
    .settings-row {
      font-size: 15px;
      color: var(--text-main);
      line-height: 1.4;
      margin-bottom: 8px;
    }
    .settings-small {
      font-size: 14px;
      color: var(--text-dim);
      line-height: 1.4;
      margin-bottom: 16px;
    }
    .settings-actions {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-top: 16px;
    }
    .btn-primary-wide {
      background: var(--accent-blue);
      color: #fff;
      font-weight: 600;
      border-radius: 8px;
      text-align: center;
      padding: 12px;
      font-size: 16px;
      border: none;
    }
    .btn-close-settings {
      background: #2a2a2a;
      border-radius: 8px;
      text-align: center;
      padding: 12px;
      font-size: 16px;
      border: 1px solid var(--border-soft);
      color: var(--text-main);
      font-weight: 500;
    }

    @media (min-width: 480px) {
      .messages-area {
        padding-left: 24px;
        padding-right: 24px;
      }
    }
  </style>

  <!-- Clerk Frontend SDK -->
  <script
    async
    crossorigin="anonymous"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@5/dist/clerk.browser.js">
  </script>

</head>
<body>

  <header>
    <div class="header-topline">
      <div class="user-block">
        <div class="user-row1">
          <div class="status-chip" id="statusChip">
            <span class="guest" id="statusText">Invit√© üë•</span>
          </div>

          <div class="tokens-chip" id="tokensChip">
            Tokens: <span id="tokenCount">1000</span>
          </div>
        </div>
        <div class="user-email" id="userEmailLine">Non connect√©</div>
      </div>

      <div class="header-buttons">
        <button class="btn-small" id="btnOpenSettings">R√©glages</button>
        <button class="btn-small" id="btnAuth">Cr√©er un compte / Se connecter</button>
        <button class="btn-small btn-danger" id="btnClearChat">Vider chat</button>
      </div>
    </div>

    <div class="intro-panel" id="introPanel">
      <h2 class="intro-title">Philom√®ne IA ‚Äì Assistant personnel</h2>
      <div class="intro-desc">
        Je peux t‚Äôaider pour tes devoirs, √©crire un mail pro, corriger un texte,
        cuisiner avec ce que tu as dans ton frigo, traduire, expliquer une panne,
        pr√©parer un CV, t‚Äôexpliquer une facture‚Ä¶ calmement √©tape par √©tape.
      </div>

      <div class="intro-bullets">
        <ul>
          <li>Mode invit√© : tu testes gratuitement (1000 tokens).</li>
          <li>Quand tu cr√©es ton compte (e-mail v√©rifi√©) :
              tu passes √† 5000 tokens et on garde l‚Äôhistorique.</li>
        </ul>
        <div class="intro-note">
          Politique / actu du jour :
          je peux parfois ne pas avoir la derni√®re info en temps r√©el.
        </div>
      </div>
    </div>
  </header>

  <main class="chat-wrapper">

    <section class="messages-area" id="messagesArea">
      <div class="messages-list" id="messagesList">
      </div>
    </section>

  </main>

  <div class="input-bar-outer">
    <div class="input-row">
      <button class="btn-photo" id="btnPhoto" title="Envoyer une image">
        üì∑
      </button>

      <div class="field-wrap">
        <input
          id="userInput"
          type="text"
          placeholder="√âcris ton message‚Ä¶ (Entr√©e = envoyer)"
        />
      </div>

      <button class="btn-wizz" id="btnWizz">
        <span>‚ö° Wizz</span>
      </button>

      <button class="btn-send" id="btnSend">Envoyer</button>
    </div>

    <div class="token-line">
      Solde: <span id="footerTokens">1000</span> tokens restants
    </div>
  </div>

  <div class="overlay" id="settingsOverlay">
    <div class="settings-panel">
      <div class="settings-title">
        <span>R√©glages</span>
        <span id="settingsCloseX" style="font-size:20px; font-weight:600; color:#fff; cursor:pointer;">√ó</span>
      </div>

      <div class="settings-row">
        Statut : <span id="settingsStatusText">Invit√© (1000 tokens)</span>
      </div>
      <div class="settings-row">
        Solde actuel : <span id="settingsTokensText">1000 tokens</span>
      </div>
      <div class="settings-small">
        Passe √† <strong>5000 tokens</strong> en cr√©ant un compte
        (connexion rapide par e-mail).
      </div>

      <div class="settings-actions">
        <button class="btn-primary-wide" id="settingsAuthBtn">
          Cr√©er un compte / Se connecter
        </button>

        <button class="btn-close-settings" id="settingsCloseBtn">
          Fermer
        </button>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = document.querySelector('meta[name="api-base"]').content || "";
    const CLERK_PK = document.querySelector('meta[name="clerk-publishable-key"]').content || "";

    let userId = "anonymous";
    let userEmail = null;
    let tokensRemaining = 1000;
    let isLoggedIn = false;
    const conversation = [];

    const statusText     = document.getElementById("statusText");
    const tokensChip     = document.getElementById("tokenCount");
    const userEmailLine  = document.getElementById("userEmailLine");
    const footerTokens   = document.getElementById("footerTokens");

    const btnSend        = document.getElementById("btnSend");
    const btnPhoto       = document.getElementById("btnPhoto");
    const btnWizz        = document.getElementById("btnWizz");
    const btnClearChat   = document.getElementById("btnClearChat");
    const btnOpenSettings= document.getElementById("btnOpenSettings");
    const btnAuthHeader  = document.getElementById("btnAuth");
    const userInput      = document.getElementById("userInput");
    const messagesList   = document.getElementById("messagesList");

    const settingsOverlay     = document.getElementById("settingsOverlay");
    const settingsCloseBtn    = document.getElementById("settingsCloseBtn");
    const settingsCloseX      = document.getElementById("settingsCloseX");
    const settingsStatusText  = document.getElementById("settingsStatusText");
    const settingsTokensText  = document.getElementById("settingsTokensText");
    const settingsAuthBtn     = document.getElementById("settingsAuthBtn");

    function renderHeader() {
      if (isLoggedIn) {
        statusText.textContent = "Connect√© ‚úÖ";
        statusText.classList.remove("guest");
        statusText.classList.add("check");
        if (userEmail) {
          userEmailLine.textContent = userEmail;
        } else {
          userEmailLine.textContent = "Compte v√©rifi√©";
        }
      } else {
        statusText.textContent = "Invit√© üë•";
        statusText.classList.remove("check");
        statusText.classList.add("guest");
        userEmailLine.textContent = "Non connect√©";
      }
      tokensChip.textContent = tokensRemaining;
      footerTokens.textContent = tokensRemaining;

      const labelStatut = isLoggedIn
        ? `Connect√© (${tokensRemaining} tokens)`
        : `Invit√© (${tokensRemaining} tokens)`;
      settingsStatusText.textContent = labelStatut;
      settingsTokensText.textContent = tokensRemaining + " tokens";
    }

    function pushBubble(role, text) {
      conversation.push({ role, text });

      const div = document.createElement("div");
      div.classList.add("bubble");

      if (role === "user") {
        div.classList.add("user");
      } else if (role === "system") {
        div.classList.add("system");
      }

      div.textContent = text;
      messagesList.appendChild(div);

      const msgArea = document.getElementById("messagesArea");
      msgArea.scrollTop = msgArea.scrollHeight;
    }

    let clerkLoaded = false;
    window.addEventListener("load", async () => {
      try {
        if (window.Clerk && CLERK_PK) {
          await window.Clerk.load({
            publishableKey: CLERK_PK
          });
          clerkLoaded = true;

          const session = window.Clerk.session;
          if (session && session.user) {
            await handleClerkLoggedIn(session.user);
          }
        }
      } catch(e) {
        console.log("Clerk init error:", e);
      }

      refreshBalanceFromAPI();
      renderHeader();
      greetFirstTime();
    });

    async function handleClerkLoggedIn(user) {
      isLoggedIn = true;
      userId = user.id || "user";
      userEmail = (user.primaryEmailAddress && user.primaryEmailAddress.emailAddress) || "";

      try {
        const r = await fetch(API_BASE + "/api/balance?userId=" + encodeURIComponent(userId));
        const j = await r.json();
        if (j && typeof j.free === "number") {
          tokensRemaining = j.free;
        } else {
          tokensRemaining = 5000;
        }
      } catch(e) {
        tokensRemaining = 5000;
      }
      renderHeader();

      pushBubble("system", "Bienvenue, compte activ√© ‚úÖ Tu as maintenant " + tokensRemaining + " tokens.");
    }

    function openSettings() {
      settingsOverlay.classList.add("active");
    }
    function closeSettings() {
      settingsOverlay.classList.remove("active");
    }

    btnOpenSettings.addEventListener("click", openSettings);
    settingsCloseBtn.addEventListener("click", closeSettings);
    settingsCloseX.addEventListener("click", closeSettings);

    async function startAuthFlow() {
      if (!clerkLoaded || !window.Clerk) {
        console.log("Clerk pas pr√™t");
        return;
      }
      try {
        if (window.Clerk.openSignIn) {
          await window.Clerk.openSignIn();
          const session = window.Clerk.session;
          if (session && session.user) {
            await handleClerkLoggedIn(session.user);
          }
        } else if (window.Clerk.openSignUp) {
          await window.Clerk.openSignUp();
          const session = window.Clerk.session;
          if (session && session.user) {
            await handleClerkLoggedIn(session.user);
          }
        } else {
          const session = window.Clerk.session;
          if (session && session.user) {
            await handleClerkLoggedIn(session.user);
          }
        }
      } catch(e) {
        console.log("Auth flow error:", e);
      }
    }

    btnAuthHeader.addEventListener("click", startAuthFlow);
    settingsAuthBtn.addEventListener("click", startAuthFlow);

    async function sendMessage() {
      const msg = userInput.value.trim();
      if (!msg) return;

      pushBubble("user", msg);
      userInput.value = "";

      try {
        const body = {
          userId,
          message: msg
        };
        const r = await fetch(API_BASE + "/api/chat", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(body),
        });

        const j = await r.json();
        if (!r.ok || j.error) {
          pushBubble("assistant", "D√©sol√©, erreur serveur.");
          return;
        }

        const reply = j.reply || "D√©sol√©, pas de r√©ponse.";
        pushBubble("assistant", reply);

        if (typeof j.remaining === "number") {
          tokensRemaining = j.remaining;
        }
        renderHeader();

      } catch(e) {
        console.log(e);
        pushBubble("assistant", "D√©sol√©, il y a eu un probl√®me r√©seau.");
      }
    }

    btnSend.addEventListener("click", sendMessage);
    userInput.addEventListener("keydown", (ev) => {
      if (ev.key === "Enter") {
        ev.preventDefault();
        sendMessage();
      }
    });

    btnWizz.addEventListener("click", () => {
      pushBubble("system", "üí• WIZZ envoy√©");
      if (window.navigator && window.navigator.vibrate) {
        window.navigator.vibrate(100);
      }
    });

    btnPhoto.addEventListener("click", () => {
      pushBubble("system", "üì∑ Envoi photo pas encore activ√© (bient√¥t).");
    });

    async function clearChat() {
      conversation.length = 0;
      messagesList.innerHTML = "";

      try {
        await fetch(API_BASE + "/api/clear", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ userId }),
        });
      } catch(e) {
        console.log("clear error:", e);
      }

      pushBubble("system", "Conversation effac√©e ‚úÖ");
    }
    btnClearChat.addEventListener("click", clearChat);

    async function refreshBalanceFromAPI() {
      try {
        const r = await fetch(API_BASE + "/api/balance?userId=" + encodeURIComponent(userId));
        const j = await r.json();
        if (j && typeof j.free === "number") {
          tokensRemaining = j.free;
        }
      } catch(e) {}
      renderHeader();
    }

    function greetFirstTime() {
      if (conversation.length === 0) {
        if (isLoggedIn) {
          pushBubble(
            "system",
            "Bienvenue, compte activ√© ‚úÖ Tu as maintenant " + tokensRemaining + " tokens."
          );
        } else {
          pushBubble(
            "system",
            "Salut üëã Je suis Philom√®ne IA. Tu as " + tokensRemaining +
            " tokens gratuits pour tester. Pose ta question."
          );
        }
      }
    }
  </script>
</body>
</html>

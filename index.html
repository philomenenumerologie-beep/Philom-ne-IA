<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Philomène IA — Messenger</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Clerk (auth) -->
  <script async crossorigin="anonymous"
    data-clerk-publishable-key="pk_test_ZW5vdWdoLXRyZWVmcm9nLTIuY2xlcmsuYWNjb3VudHMuZGV2JA"
    src="https://cdn.jsdelivr.net/npm/@clerk/clerk-js@latest/dist/clerk.browser.js">
  </script>

  <style>
    :root { --bg:#071826; --panel:#0e2238; --muted:#9bb3c9; --accent:#2e7df6; --danger:#ff4646; --line:#173a5c; }
    html, body { height:100%; }
    body { margin:0; background:var(--bg); color:#fff; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; }

    /* Header */
    header { display:flex; align-items:center; gap:12px; padding:14px 16px; border-bottom:1px solid var(--line); background:#061522; position:sticky; top:0; z-index:3; }
    .brand { display:flex; align-items:center; gap:10px; }
    .brand .logo { width:28px; height:28px; display:grid; place-items:center; background:#ff7aac; border-radius:8px; }
    .brand b { font-size:16px; letter-spacing:.2px; }
    .spacer { flex:1; }
    .pill { display:inline-flex; align-items:center; gap:8px; padding:8px 10px; background:#0f2b47; border:1px solid #234c77; border-radius:999px; font-size:13px; }
    .btn { border:0; border-radius:10px; padding:10px 12px; font-weight:600; cursor:pointer; }
    .btn.primary { background:var(--accent); color:#001427; }
    .btn.ghost { background:#203345; color:#fff; border:1px solid var(--line); }
    .btn.danger { background:var(--danger); color:#fff; }

    /* Wrap */
    .wrap { max-width:980px; margin:0 auto; padding:16px; }
    h1 { margin:10px 0 8px; font-size:26px; text-align:center; }
    .topline { display:flex; flex-wrap:wrap; align-items:center; justify-content:center; gap:8px; color:var(--muted); margin-bottom:14px; font-size:14px; }

    /* Panel & chat */
    .panel { background:var(--panel); border:1px solid var(--line); border-radius:12px; padding:14px; }
    .alert { margin:0 4px 8px; color:var(--muted); }
    .chatbox { height:62vh; min-height:320px; overflow:auto; padding:12px; background:#0b1d31; border:1px solid #153150; border-radius:10px; }
    .msg { max-width:88%; margin:8px 0; padding:10px 12px; border-radius:10px; line-height:1.35; font-size:15px; white-space:pre-wrap; word-wrap:break-word; }
    .me { margin-left:auto; background:#133a6d; border:1px solid #2d65a2; }
    .bot { background:#0f2b47; border:1px solid #2a527e; }

    .row { display:flex; gap:10px; margin-top:10px; }
    textarea { flex:1; height:56px; resize:none; background:#0b1d31; border:1px solid var(--line); color:#fff; border-radius:10px; padding:12px; font-size:15px; outline:none; }
    button { cursor:pointer; border:0; border-radius:10px; padding:12px 14px; font-weight:600; }
    .send { background:var(--accent); color:#001427; min-width:120px; }
    .photo { background:#00bcd4; color:#001427; min-width:120px; }
    input[type=file] { display:none; }

    .mini { font-size:12px; opacity:.9; }
    .muted { color:var(--muted); }
  </style>
</head>
<body>

  <!-- Header global -->
  <header>
    <div class="brand">
      <div class="logo">🧠</div>
      <b>Philomène IA</b>
    </div>
    <div class="spacer"></div>
    <span id="connectedAs" class="pill">Statut: non connecté</span>
    <span class="pill">Tokens: <span id="tokRemain">0</span></span>
    <button id="signup" class="btn ghost">Créer un compte</button>
    <button id="signin" class="btn primary">Se connecter</button>
    <button id="logout" class="btn danger" style="display:none">Se déconnecter</button>
  </header>

  <div class="wrap">
    <h1>Messenger</h1>
    <div class="topline">
      <span class="muted">GPT-4 Turbo • 5000 tokens offerts à l’inscription • FR/EN/NL • Upload photo</span>
    </div>

    <div class="panel">
      <div id="alert" class="alert">Prêt ✅</div>

      <div id="chat" class="chatbox"></div>
      <div class="mini" id="lastUsage" style="margin:6px 2px 0;"></div>

      <div class="row">
        <textarea id="input" placeholder="Écris ton message… (Entrée = envoyer)"></textarea>
        <label for="file" class="btn photo" title="Envoyer une photo">📷 Photo</label>
        <input id="file" type="file" accept="image/*" />
        <button id="send" class="send">Envoyer</button>
      </div>
    </div>
  </div>

  <script>
    // ====== Helpers UI
    const $ = (id) => document.getElementById(id);
    const chat = $("chat");
    function addMsg(text, who = "bot") {
      const div = document.createElement("div");
      div.className = "msg " + (who === "me" ? "me" : "bot");
      div.textContent = text;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    async function safeJSON(url, options = {}) {
      try {
        const r = await fetch(url, options);
        if (!r.ok) throw new Error("HTTP " + r.status);
        return await r.json();
      } catch (e) {
        console.error(e);
        $("alert").textContent = "⚠️ Erreur réseau: " + (e.message || "inconnue");
        return null;
      }
    }

    // ====== Etat
    let userId = null;
    let imageDataUrl = null;

    // ====== Au chargement
    window.addEventListener("load", async () => {
      // 1) Clerk (si dispo). Sinon mode “anonyme” (tests).
      try { await Clerk.load(); } catch(_) {}
      if (window.Clerk && Clerk.user) {
        userId = Clerk.user.id;
        const mail = Clerk.user.primaryEmailAddress?.emailAddress || "inconnu";
        $("connectedAs").textContent = "Connecté ✅ : " + mail;
        $("signin").style.display = "none";
        $("signup").style.display = "none";
        $("logout").style.display = "inline-block";
      } else {
        userId = localStorage.getItem("anon_id");
        if (!userId) { userId = "anon_" + Math.random().toString(36).slice(2); localStorage.setItem("anon_id", userId); }
        $("connectedAs").textContent = "Mode visiteur";
      }

      // 2) Boutons auth
      $("signin").onclick = () => window.Clerk ? Clerk.openSignIn({ redirectUrl: "/" }) : alert("Auth indisponible");
      $("signup").onclick = () => window.Clerk ? Clerk.openSignUp({ redirectUrl: "/" }) : alert("Auth indisponible");
      $("logout").onclick = async () => { if (window.Clerk) { await Clerk.signOut(); location.reload(); } };

      // 3) Message d’accueil auto (style “présentation”)
      addMsg("👋 Bienvenue sur Philomène IA !\n\nJe suis ton assistante personnelle. Pose tes questions (devoirs, recettes, dépannage, idées…). Tu peux aussi envoyer une 📷 photo.\n\nTu as 5000 tokens gratuits pour tester. Je montre à chaque message combien de tokens sont utilisés et ce qu’il te reste. C’est parti !");

      // 4) Solde initial
      await refreshBalance();

      // 5) Entrées utilisateur
      $("send").onclick = sendMessage;
      const input = $("input");
      input.addEventListener("keydown", (e) => {
        if (e.key === "Enter" && !e.shiftKey) { e.preventDefault(); sendMessage(); }
      });

      // 6) Upload photo
      $("file").addEventListener("change", async () => {
        const f = $("file").files?.[0];
        if (!f) return;
        if (!f.type.startsWith("image/")) { imageDataUrl = null; return; }
        imageDataUrl = await toDataURL(f);
        $("alert").textContent = "Photo attachée ✅";
      });
    });

    async function refreshBalance() {
      const d = await safeJSON(`/api/balance?userId=${encodeURIComponent(userId)}`);
      if (!d) return;
      $("tokRemain").textContent = d.free ?? 0;
    }

    async function sendMessage() {
      const input = $("input");
      const text = input.value.trim();
      if (!text && !imageDataUrl) return;
      addMsg(text || "(photo)", "me");
      input.value = "";

      const body = { userId, message: text || "", imageDataUrl: imageDataUrl || null };
      const data = await safeJSON(`/api/chat`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
      });

      if (!data) { addMsg("Désolé, impossible d’obtenir une réponse pour le moment.", "bot"); return; }
      if (data.error) {
        addMsg(data.error === "Solde insuffisant" ? "⛔ Solde insuffisant. Recharge bientôt disponible." : data.error, "bot");
        $("tokRemain").textContent = data.remaining ?? 0;
        return;
      }

      addMsg(data.reply, "bot");

      // Affiche usage & reste
      const u = data.usage || {};
      $("lastUsage").textContent =
        `Utilisés: prompt ${u.prompt_tokens||0} + output ${u.completion_tokens||0} = ${u.total_tokens||0} tokens  •  Reste: ${data.remaining}`;
      $("tokRemain").textContent = data.remaining ?? 0;

      // reset pièce jointe
      imageDataUrl = null;
      $("alert").textContent = "Prêt ✅";
    }

    function toDataURL(file) {
      return new Promise((resolve, reject) => {
        const fr = new FileReader();
        fr.onload = () => resolve(fr.result);
        fr.onerror = reject;
        fr.readAsDataURL(file);
      });
    }
  </script>
</body>
</html>

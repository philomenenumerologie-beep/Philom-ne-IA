<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Philom√®ne I.A.</title>

  <style>
    * {
      box-sizing: border-box;
      -webkit-font-smoothing: antialiased;
      margin: 0;
      padding: 0;
    }

    body {
      background-color: #000;
      color: #fff;
      font-family: -apple-system, BlinkMacSystemFont, "Inter", Roboto, sans-serif;
      line-height: 1.45;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      background-image: radial-gradient(circle at 30% 30%, rgba(128,0,255,0.25) 0%, rgba(0,0,0,0) 60%);
      background-repeat: no-repeat;
      background-size: 120% 120%;
    }

    /* ===== HEADER ===== */
    .topbar {
      background-color: #000;
      color: #fff;
      padding: 12px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.07);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: nowrap;
      position: sticky;
      top: 0;
      z-index: 1000;
    }

    .left-group,
    .right-group {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .burger-btn {
      width: 44px;
      height: 44px;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      color: #fff;
    }

    .tokens-box {
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      font-size: 14px;
      line-height: 1.2;
      color: #ffd44b;
      font-weight: 600;
    }

    .tokens-topline {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 18px;
      font-weight: 600;
      color: #ffd44b;
    }
    .tokens-diamond {
      font-size: 20px;
      color: #4ccfff;
    }
    .tokens-amount {
      color: #ffd44b;
    }
    .assistant-name {
      color: #888;
      font-size: 13px;
      margin-top: 2px;
    }

    /* ===== BOUTON COMPTE (connexion / d√©connexion) ===== */
    #auth-btn {
      min-width: auto;
      border-radius: 8px;
      background-color: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      color: #fff;
      font-size: 15px;
      line-height: 1.2;
      font-weight: 500;
      padding: 10px 12px;
      display: flex;
      flex-direction: column;
      text-align: right;
      box-shadow: 0 12px 30px rgba(0,0,0,0.8);
    }
    #auth-line-main {
      display: flex;
      align-items: center;
      justify-content: flex-end;
      gap: 6px;
      white-space: nowrap;
    }
    #auth-icon {
      font-size: 16px;
    }
    #auth-text-main {
      font-size: 15px;
      font-weight: 500;
      color: #fff;
    }
    #auth-text-sub {
      font-size: 12px;
      color: #888;
      font-weight: 400;
    }

    /* si connect√© on met le sous-texte en accent rouge pour "d√©connexion" */
    .logout-mode #auth-text-main {
      color: #ff4d4d;
      font-weight: 600;
    }
    .logout-mode #auth-icon {
      color: #ff4d4d;
    }

    /* ===== CHAT AREA ===== */
    .chat-area {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      overflow-y: auto;
    }

    .bubble {
      background-color: #1f1f1f;
      border: 1px solid rgba(255,255,255,0.08);
      border-radius: 12px;
      padding: 16px;
      color: #fff;
      max-width: 90%;
      font-size: 18px;
      line-height: 1.45;
    }

    .bubble.assistant {
      align-self: flex-start;
      background: rgba(255,255,255,0.07);
      border: 1px solid rgba(255,255,255,0.15);
    }

    .bubble.user {
      align-self: flex-end;
      background: radial-gradient(circle at 50% 0%, rgba(86,64,255,0.9) 0%, rgba(12,0,64,1) 60%);
      border: 1px solid rgba(120,80,255,0.6);
      color: #fff;
      font-weight: 500;
    }

    /* ===== INPUT BAR ===== */
    .input-bar-wrapper {
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.07);
      background-color: rgba(0,0,0,0.6);
      position: sticky;
      bottom: 0;
    }

    .input-row {
      display: flex;
      gap: 12px;
      align-items: stretch;
    }

    .plus-btn,
    .send-btn {
      min-width: 64px;
      max-width: 64px;
      border-radius: 12px;
      background: radial-gradient(circle at 50% 0%, rgba(86,64,255,1) 0%, rgba(12,0,64,1) 60%);
      border: 1px solid rgba(120,80,255,0.7);
      color: #fff;
      font-size: 28px;
      font-weight: 500;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 20px rgba(120,80,255,0.6);
    }

    #message-input {
      flex: 1;
      background-color: rgba(20,20,30,0.8);
      border: 1px solid rgba(255,255,255,0.15);
      border-radius: 12px;
      color: #fff;
      font-size: 18px;
      padding: 16px;
      font-family: inherit;
      outline: none;
    }
    #message-input::placeholder {
      color: #888;
    }

    .status-row {
      color: #aaa;
      font-size: 15px;
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      flex-wrap: wrap;
      line-height: 1.4;
    }

    .status-right { font-weight: 600; color: #fff; }
    .status-right .tokens-number {
      color: #fff;
    }
  </style>
</head>

<body>

  <!-- ===== TOP BAR ===== -->
  <header class="topbar">
    <div class="left-group">
      <div class="burger-btn">‚ò∞</div>

      <div class="tokens-box">
        <div class="tokens-topline">
          <div class="tokens-diamond">üíé</div>
          <div><span id="token-count-header" class="tokens-amount">5000</span>&nbsp;tokens</div>
        </div>
        <div class="assistant-name">Philom√®ne I.A.</div>
      </div>
    </div>

    <div class="right-group">
      <!-- Bouton compte -->
      <button id="auth-btn">
        <div id="auth-line-main">
          <span id="auth-icon">üîê</span>
          <span id="auth-text-main">Connexion / Inscription</span>
        </div>
        <div id="auth-text-sub">S√©curis√©</div>
      </button>
    </div>
  </header>

  <!-- ===== CHAT AREA ===== -->
  <main class="chat-area" id="chat-area">
    <div class="bubble assistant" id="welcome">
      üëã Bonjour ! Je suis Philom√®ne I.A., votre assistante personnelle.<br>
      Si vous avez un probl√®me, j‚Äôai la solution.<br>
      Vous avez une question, j‚Äôai la r√©ponse.<br>
      Ensemble, on ira plus loin üïä
    </div>
  </main>

  <!-- ===== INPUT BAR ===== -->
  <footer class="input-bar-wrapper">
    <div class="input-row">
      <button class="plus-btn" id="plus-btn">+</button>
      <input id="message-input" type="text" placeholder="√âcrivez votre message..." />
      <button class="send-btn" id="send-btn">‚û§</button>
    </div>

    <div class="status-row">
      <div class="status-left">
        Pr√™t ¬∑ <span id="token-count-footer">5000</span> tokens restants
      </div>
      <div class="status-right" style="display:none"></div>
    </div>
  </footer>

  <!-- ===== Clerk SDK ===== -->
  <script>
  // =========================
  // CONFIG
  // =========================
  const API_URL = "https://philo-backend-su29.onrender.com/ask";
  const STARTING_TOKENS = 5000;

  // √©tat runtime
  let currentUserId = "guest";
  let currentUserEmail = null;
  let isSignedIn = false;
  let tokenBalance = STARTING_TOKENS;
  let clerkReady = false;

  // m√©moire conversation (envoy√©e au backend)
  const conversation = [
    {
      role: "assistant",
      content:
        "üëã Bonjour ! Je suis Philom√®ne I.A., votre assistante personnelle. Si vous avez un probl√®me, j‚Äôai la solution. Vous avez une question, j‚Äôai la r√©ponse. Ensemble, on ira plus loin üïä"
    }
  ];

  // DOM refs
  const chatArea       = document.getElementById("chat-area");
  const inputField     = document.getElementById("message-input");
  const sendBtn        = document.getElementById("send-btn");
  const plusBtn        = document.getElementById("plus-btn");
  const tokenHeader    = document.getElementById("token-count-header");
  const tokenFooter    = document.getElementById("token-count-footer");

  // ATTENTION: dans ton HTML actuel, on a un bouton connexion en haut maintenant.
  // Je vais supposer qu'il a l'id "connect-btn" (on va le cr√©er juste apr√®s).
  // Et un bouton logout avec id "logout-btn" si tu l'ajoutes plus tard.
  const connectBtn     = document.getElementById("connect-btn");
  const logoutBtn      = document.getElementById("logout-btn");

  // =========================
  // UI helpers
  // =========================
  function appendMessage(role, text) {
    const div = document.createElement("div");
    div.className = "bubble " + (role === "user" ? "user" : "assistant");
    div.textContent = text;
    chatArea.appendChild(div);
    chatArea.scrollTop = chatArea.scrollHeight;
  }

  function refreshTokenDisplay() {
    tokenHeader.textContent = tokenBalance;
    tokenFooter.textContent = tokenBalance;
  }
  refreshTokenDisplay();

  function spendTokensForMessage() {
    const cost = 20;
    tokenBalance = Math.max(0, tokenBalance - cost);
    refreshTokenDisplay();
  }

  // met √† jour le bouton du haut selon l'√©tat
  function refreshAuthUI() {
    if (!connectBtn) return;

    if (isSignedIn) {
      // connect√©
      connectBtn.innerText = (currentUserEmail || "Mon compte") + " üîê";
      if (logoutBtn) logoutBtn.style.display = "inline-block";
    } else {
      // invit√©
      connectBtn.innerText = "Connexion / Inscription üîê\nS√©curis√©";
      if (logoutBtn) logoutBtn.style.display = "none";
    }
  }

  // =========================
  // Clerk auth
  // =========================
  async function initClerk() {
    // attendre que Clerk soit inject√©
    if (!window.Clerk) {
      console.warn("Clerk pas charg√© encore");
      return;
    }

    try {
      // load initialise Clerk, obligatoire avant d'utiliser openSignIn etc.
      await window.Clerk.load();

      clerkReady = true;

      const user = window.Clerk.user;
      const session = window.Clerk.session;

      if (user && session) {
        isSignedIn = true;
        currentUserId = user.id || "guest";
        currentUserEmail = (user.primaryEmailAddress && user.primaryEmailAddress.emailAddress) || null;
      } else {
        isSignedIn = false;
        currentUserId = "guest";
        currentUserEmail = null;
      }

      refreshAuthUI();
    } catch (err) {
      console.error("Erreur initClerk:", err);
    }
  }

  // ouvre la popup Clerk (login/signup)
  async function openSignInFlow() {
    if (!clerkReady) {
      alert("Connexion momentan√©ment indisponible. R√©essaie dans une seconde.");
      return;
    }

    if (!window.Clerk) {
      alert("Clerk n'est pas pr√™t.");
      return;
    }

    try {
      await window.Clerk.openSignIn({
        afterSignIn: async () => {
          await initClerk();
        },
        afterSignUp: async () => {
          await initClerk();
        }
      });
    } catch (err) {
      console.error("openSignIn error:", err);
    }
  }

  // d√©connexion
  async function doLogout() {
    if (!clerkReady || !window.Clerk) return;
    try {
      await window.Clerk.signOut();
    } catch (err) {
      console.error("signOut error:", err);
    }
    isSignedIn = false;
    currentUserId = "guest";
    currentUserEmail = null;
    refreshAuthUI();
  }

  // brancher les boutons auth
  if (connectBtn) {
    connectBtn.addEventListener("click", () => {
      if (!isSignedIn) {
        // pas connect√© ‚Üí ouvrir login
        openSignInFlow();
      } else {
        // d√©j√† connect√© ‚Üí plus tard on pourra ouvrir "mon compte"
        // pour l'instant rien
        console.log("D√©j√† connect√©:", currentUserEmail || currentUserId);
      }
    });
  }
  if (logoutBtn) {
    logoutBtn.addEventListener("click", () => {
      doLogout();
    });
  }

  // =========================
  // Envoi message IA
  // =========================
  async function sendMessage() {
    const text = inputField.value.trim();
    if (!text) return;

    appendMessage("user", text);

    conversation.push({
      role: "user",
      content: text
    });

    spendTokensForMessage();
    inputField.value = "";

    try {
      const resp = await fetch(API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json"
        },
        body: JSON.stringify({
          conversation
        })
      });

      const data = await resp.json();

      if (!data || !data.answer) {
        appendMessage("assistant", "D√©sol√©e, j'ai eu un probl√®me r√©seau.");
        return;
      }

      const answer = data.answer.trim();
      appendMessage("assistant", answer);

      conversation.push({
        role: "assistant",
        content: answer
      });
    } catch (err) {
      appendMessage("assistant", "D√©sol√©e, j'ai eu un probl√®me r√©seau.");
    }
  }

  sendBtn.addEventListener("click", sendMessage);
  inputField.addEventListener("keydown", (ev) => {
    if (ev.key === "Enter") {
      ev.preventDefault();
      sendMessage();
    }
  });

  // bouton +
  plusBtn.addEventListener("click", () => {
    appendMessage("assistant", "Fonction + bient√¥t dispo üíé");
  });

  // =========================
  // Au chargement de la page
  // =========================
  window.addEventListener("load", () => {
    initClerk(); // on initialise Clerk au d√©marrage
    refreshAuthUI(); // affiche le bon texte dans le bouton
  });
</script>
</body>
</html>
